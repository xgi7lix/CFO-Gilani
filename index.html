<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام الإدارة المالية المتقدم</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  
  <!-- Firebase SDKs (using compat libraries for easier transition) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --primary-color: #2C786C;
      --secondary-color: #004445;
      --accent-color: #FFD166;
      --light-color: #f8f9fa;
      --dark-color: #333;
      --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
      --danger-color: #dc3545;
      --danger-hover: #c82333;
    }
    * { box-sizing: border; margin: 0; padding: 0; }
    body { 
      font-family: 'Tajawal', sans-serif; 
      background: var(--light-color); 
      color: var(--dark-color);
      line-height: 1.6;
    }
    .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 15px; }
    header { background: var(--primary-color); color: white; padding: 15px 0; text-align: center; box-shadow: var(--card-shadow); margin-bottom: 20px; position: relative; }
    h1 { font-size: 1.5rem; margin: 0; }
    .back-button, .back-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; transition: var(--transition); }
    .back-btn { position: static; margin: 10px 0; }
    .back-button i, .back-btn i { margin-right: 5px; }
    .back-button:hover, .back-btn:hover { background: rgba(255,255,255,0.3); }
    .main-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
    @media (min-width: 768px) { .main-grid { grid-template-columns: repeat(3, 1fr); } }
    .main-card { background: white; border-radius: 10px; box-shadow: var(--card-shadow); padding: 20px; text-align: center; cursor: pointer; transition: var(--transition); border: 2px solid var(--primary-color); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px; }
    .main-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); background: var(--primary-color); color: white; }
    .main-card:hover i { color: white; }
    .main-card i { font-size: 2rem; color: var(--primary-color); margin-bottom: 10px; transition: var(--transition); }
    .main-card h3 { margin: 0; font-size: 1rem; }
    .page { display: none; background: white; border-radius: 10px; box-shadow: var(--card-shadow); padding: 15px; margin-top: 15px; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .active-page { display: block; }
    .page-header { display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
    .page-header i { margin-left: 10px; color: var(--primary-color); } 
    .settings-card { background: white; border-radius: 10px; box-shadow: var(--card-shadow); padding: 20px; margin-bottom: 15px; border-left: 4px solid var(--primary-color); }
    .settings-card h3 { color: var(--primary-color); margin-bottom: 15px; }
    .form-row { margin-bottom: 15px; }
    .form-row label { font-weight: bold; display: block; margin-bottom: 5px; }
    input, select, textarea, button { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; font-family: 'Tajawal', sans-serif; transition: var(--transition); }
    input:focus, select:focus, textarea:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px rgba(44, 120, 108, 0.2); }
    button { background: var(--primary-color); color: white; cursor: pointer; margin-top: 10px; font-weight: bold; border: none; transition: var(--transition); padding: 12px; }
    button:hover { background: var(--secondary-color); }
    .btn-wide { display: block; width: 100%; margin: 10px 0; text-align: right; padding: 15px; font-size: 1rem; }
    .btn-wide i { margin-left: 10px; }
    .btn-danger { background: var(--danger-color); }
    .btn-danger:hover { background: var(--danger-hover); }
    .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; padding: 10px 15px; border-radius: 5px; z-index: 2000; text-align: center; animation: slideIn 0.3s ease; box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
    .notification.error { background: var(--danger-color); }
    @keyframes slideIn { from { transform: translateY(-20px) translateX(-50%); opacity: 0; } to { transform: translateY(0) translateX(-50%); opacity: 1; } }
    .settings-buttons { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px; }
    @media (min-width: 480px) { .settings-buttons { grid-template-columns: repeat(2, 1fr); } }
    .balance-item { padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; display: flex; justify-content: space-between; }
    .debt-section { margin: 15px 0; }
    .debt-records-container { padding: 10px; background: #f8f9fa; border-radius: 5px; max-height: 300px; overflow-y: auto; }
    .debt-record { padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; }
    .transaction-button { width: 100%; padding: 10px; margin-bottom: 10px; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-size: 1rem; text-align: right; }
    
    /* Auth Page Styles */
    #auth-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
    .auth-box { background: white; padding: 30px; border-radius: 10px; box-shadow: var(--card-shadow); width: 100%; max-width: 400px; text-align: center; }
    .auth-box h2 { margin-bottom: 20px; color: var(--primary-color); }
    .auth-box .form-row { text-align: right; }
    .auth-box button { margin-top: 15px; }
    .auth-box .google-btn { background-color: #4285F4; color: white; }
    .auth-box .google-btn:hover { background-color: #357ae8; }
    .auth-box .or-separator { margin: 20px 0; display: flex; align-items: center; text-align: center; color: #aaa; }
    .auth-box .or-separator::before, .auth-box .or-separator::after { content: ''; flex: 1; border-bottom: 1px solid #ddd; }
    .auth-box .or-separator:not(:empty)::before { margin-left: .25em; }
    .auth-box .or-separator:not(:empty)::after { margin-right: .25em; }
    .auth-switch { margin-top: 20px; color: var(--dark-color); }
    .auth-switch a { color: var(--primary-color); cursor: pointer; font-weight: bold; }
    .auth-switch a:hover { text-decoration: underline; }
    #app-container { display: none; } /* Hidden by default */
    
    /* Loader */
    .loader { 
      display: none;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <!-- واجهة المصادقة -->
  <div id="auth-container">
    <div class="auth-box">
      <!-- Login Form -->
      <div id="login-form">
        <h2>تسجيل الدخول</h2>
        <div class="form-row">
          <label for="login-email">البريد الإلكتروني</label>
          <input type="email" id="login-email" placeholder="email@example.com" required>
        </div>
        <div class="form-row">
          <label for="login-password">كلمة المرور</label>
          <input type="password" id="login-password" placeholder="********" required>
        </div>
        <!-- رابط نسيت كلمة المرور -->
        <div class="form-row" style="text-align: left; margin-top: -10px; margin-bottom: 15px;">
            <a href="#" id="forgot-password-link" class="auth-switch">نسيت كلمة المرور؟</a>
        </div>
        <button id="login-button">تسجيل الدخول</button>
        <div class="loader" id="login-loader"></div>
        <div class="or-separator">أو</div>
        <button class="google-btn" id="google-sign-in-button-login"><i class="fab fa-google"></i> المتابعة باستخدام Google</button>
        <div class="loader" id="google-loader"></div>
        <p class="auth-switch">ليس لديك حساب؟ <a id="toggle-signup-link">إنشاء حساب جديد</a></p>
      </div>
      <!-- Signup Form -->
      <div id="signup-form" style="display: none;">
        <h2>إنشاء حساب جديد</h2>
        <div class="form-row">
            <label for="signup-firstname">الاسم الأول</label>
            <input type="text" id="signup-firstname" placeholder="مثال: أحمد" required>
        </div>
        <div class="form-row">
            <label for="signup-lastname">الاسم الأخير</label>
            <input type="text" id="signup-lastname" placeholder="مثال: محمد" required>
        </div>
        <div class="form-row">
          <label for="signup-email">البريد الإلكتروني</label>
          <input type="email" id="signup-email" placeholder="email@example.com" required>
        </div>
        <div class="form-row">
          <label for="signup-password">كلمة المرور</label>
          <input type="password" id="signup-password" placeholder="6 أحرف على الأقل" required>
        </div>
        <button id="signup-button">إنشاء حساب</button>
        <div class="loader" id="signup-loader"></div>
        <div class="or-separator">أو</div>
        <button class="google-btn" id="google-sign-in-button-signup"><i class="fab fa-google"></i> المتابعة باستخدام Google</button>
        <div class="loader" id="google-loader-signup"></div>
        <p class="auth-switch">لديك حساب بالفعل؟ <a id="toggle-login-link">تسجيل الدخول</a></p>
      </div>
    </div>
  </div>

  <!-- محتوى التطبيق الرئيسي (مخفي افتراضياً) -->
  <div id="app-container">
    <!-- الهيدر الرئيسي -->
    <header id="main-header">
      <div class="container">
        <h1><i class="fas fa-wallet"></i> نظام الإدارة المالية المتقدم</h1>
      </div>
    </header>

    <!-- هيدر الصفحات الفرعية -->
    <header id="page-header" style="display:none;">
      <button class="back-button" id="back-button-header"><i class="fas fa-arrow-left"></i> العودة</button>
      <h1 id="page-title"></h1>
    </header>

    <!-- المحتوى الرئيسي مع البطاقات الست -->
    <main class="container" id="main-content">
      <div class="main-grid">
        <div class="main-card" id="balances-card"><i class="fas fa-wallet"></i><h3>كشف الحساب</h3></div>
        <div class="main-card" id="transfers-card"><i class="fas fa-exchange-alt"></i><h3>التحويلات</h3></div>
        <div class="main-card" id="expenses-card"><i class="fas fa-money-bill-wave"></i><h3>الصادر والوارد</h3></div>
        <div class="main-card" id="transactions-card"><i class="fas fa-list"></i><h3>كل المعاملات</h3></div>
        <div class="main-card" id="customer-debts-card"><i class="fas fa-users"></i><h3>ديون العملاء</h3></div>
        <div class="main-card" id="settings-card"><i class="fas fa-cog"></i><h3>الإعدادات</h3></div>
      </div>
    </main>

    <!-- صفحة كشف الحساب -->
    <div class="container page" id="balances-page">
        <div class="page-header"><i class="fas fa-wallet"></i><h2>كشف الحساب</h2></div>
        <div id="balancesList"></div>
        <h3 style="margin-top: 20px;">أحدث المعاملات:</h3>
        <div id="recentTransactions"></div>
    </div>
    <!-- صفحة التحويلات -->
    <div class="container page" id="transfers-page">
        <div class="page-header"><i class="fas fa-exchange-alt"></i><h2>التحويلات</h2></div>
        <div class="form-row"><label>من:</label><select id="fromCurrency"></select></div>
        <div class="form-row"><label>إلى:</label><select id="toCurrency"></select></div>
        <div class="form-row"><label>المبلغ:</label><input type="number" id="transferAmount" placeholder="أدخل المبلغ"></div>
        <div class="form-row"><label>سعر الصرف:</label><div style="display:flex; align-items:center; gap:10px;"><input type="number" id="exchangeRate" placeholder="أدخل سعر الصرف" step="0.0001"><button id="rateModeBtn" type="button" >×</button></div></div>
        <div class="form-row"><label>تعليق (اختياري):</label><input type="text" id="transferComment" placeholder="أدخل تعليقًا إذا لزم الأمر"></div>
        <button id="perform-transfer-button"><i class="fas fa-exchange-alt"></i> تنفيذ التحويل</button>
    </div>
    <!-- صفحة الصادر والوارد -->
    <div class="container page" id="expenses-page">
        <div class="page-header"><i class="fas fa-money-bill-wave"></i><h2>الصادر والوارد</h2></div>
        <div class="form-row"><label>الاسم:</label><input type="text" id="expensePerson" placeholder="اسم العميل أو المورد"></div>
        <div class="form-row"><label>نوع العملية:</label><select id="expenseType"><option value="صادر">صادر</option><option value="وارد">وارد</option></select></div>
        <div class="form-row"><label>المبلغ:</label><input type="number" id="expenseAmount" placeholder="أدخل المبلغ"></div>
        <div class="form-row"><label>العملة:</label><select id="expenseCurrency"></select></div>
        <div class="form-row"><label>تفاصيل:</label><textarea id="expenseDetails" placeholder="وصف العملية" rows="3"></textarea></div>
        <button id="perform-expense-button"><i class="fas fa-check"></i> تنفيذ العملية</button>
    </div>
    <!-- صفحة المعاملات -->
    <div class="container page" id="transactions-page">
        <div class="page-header"><i class="fas fa-list"></i><h2>كل المعاملات</h2></div>
        <div class="form-row"><input type="text" id="transactionSearch" placeholder="ابحث في المعاملات..."></div>
        <div id="transactionsList"></div>
    </div>
    <!-- صفحة ديون العملاء -->
    <div class="container page" id="customerDebtsPage">
        <button class="back-btn" id="back-button-customer-debts">← رجوع</button><h2>ديون العملاء</h2>
        <div id="overallDebtSummary" class="balance-item"></div>
        <div class="debt-section"><button id="toggle-add-client-button">إضافة عميل</button><button id="toggle-remove-client-button">إزالة عميل</button></div>
        <div id="addClientSection" class="debt-section" style="display:none;"><h3>إضافة عميل جديد</h3><div class="form-row"><label>اسم العميل:</label><input type="text" id="newClientName" placeholder="ادخل اسم العميل"></div><div class="form-row"><label>رقم الهاتف:</label><input type="text" id="newClientPhone" placeholder="ادخل رقم الهاتف"></div><div class="form-row"><label>ملاحظة (اختياري):</label><input type="text" id="newClientNote" placeholder="ادخل ملاحظة"></div><button id="add-client-debt-button">تسجيل العميل</button></div>
        <div id="removeClientSection" class="debt-section" style="display:none;"><h3>إزالة عميل</h3><select id="removeClientDropdown"></select><button id="remove-client-from-dropdown-button">حذف العميل</button></div>
        <div class="debt-section"><h3>العملاء المُسجّلين</h3><div id="clientsListDisplay"></div></div>
    </div>
    <!-- صفحة تفاصيل ديون العميل -->
    <div class="container page" id="debtDetailsPage">
        <button class="back-btn" id="back-button-debt-details">← رجوع</button><h2>تفاصيل ديون العميل: <span id="clientDetailsName"></span></h2>
        <div id="clientDebtSummary" class="balance-item"></div>
        <div class="form-row"><label>نوع العملية:</label><select id="clientDebtType"><option value="لك">لك (تطلب منه)</option><option value="له">له (يطلب منك)</option></select></div>
        <div class="form-row"><label>المبلغ:</label><input type="number" id="clientDebtAmount" placeholder="ادخل المبلغ"></div>
        <div class="form-row"><label>العملة:</label><select id="clientDebtCurrency"></select></div>
        <div class="form-row"><label>تفاصيل:</label><textarea id="clientDebtDetails" placeholder="وصف العملية" rows="3"></textarea></div>
        <button id="add-client-transaction-button">إضافة معاملة</button>
        <div class="debt-records-container" id="clientDebtRecords"></div>
    </div>
    <!-- صفحة الإعدادات -->
    <div class="container page" id="settings-page">
        <div class="page-header"><i class="fas fa-cog"></i><h2>الإعدادات</h2></div>
        <div class="settings-card">
            <h3>إدارة العملات</h3>
            <div class="form-row">
                <label for="newCurrencyCode">رمز العملة (مثال: USD)</label>
                <input type="text" id="newCurrencyCode" placeholder="أدخل رمز العملة" maxlength="3" style="text-transform:uppercase;">
            </div>
            <div class="form-row">
                <label for="newCurrencyName">اسم العملة (مثال: دولار أمريكي)</label>
                <input type="text" id="newCurrencyName" placeholder="أدخل اسم العملة">
            </div>
            <button id="add-currency-button">إضافة عملة</button>
            <div id="currencyList" style="margin-top: 15px;"></div>
        </div>
        <div class="settings-card">
            <h3>النسخ الاحتياطي والاستعادة</h3>
            <button id="backup-data-button">إنشاء نسخة احتياطية</button>
            <input type="file" id="restoreFileInput" accept=".json" style="display: none;">
            <button id="restore-data-button">استعادة من نسخة احتياطية</button>
        </div>
        <div class="settings-card">
            <h3>تصدير البيانات</h3>
            <button id="export-transactions-pdf-button">تصدير المعاملات كـ PDF</button>
            <button id="export-transactions-excel-button">تصدير المعاملات كـ Excel</button>
        </div>
        <div class="settings-card">
            <h3>إدارة الحساب</h3>
            <button id="change-password-button">تغيير كلمة المرور</button>
            <button id="delete-account-button" class="btn-danger">حذف الحساب</button>
        </div>
        <div class="settings-card">
            <h3>تسجيل الخروج</h3>
            <button id="logout-button">تسجيل الخروج</button>
        </div>
    </div>
  </div>

  <!-- رسائل التنبيه -->
  <div id="notification-container"></div>

  <script>
    // Firebase configuration (replace with your actual config)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    let currentUser = null;
    let userDocRef = null;
    let currentClientDocRef = null; // For customer debt details

    // Utility functions
    function showNotification(message, isError = false) {
      const container = document.getElementById('notification-container');
      const notification = document.createElement('div');
      notification.className = `notification ${isError ? 'error' : ''}`;
      notification.textContent = message;
      container.appendChild(notification);
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    function showLoader(loaderId) {
      document.getElementById(loaderId).style.display = 'block';
    }

    function hideLoader(loaderId) {
      document.getElementById(loaderId).style.display = 'none';
    }

    // Auth functions
    function toggleAuthForms() {
      const loginForm = document.getElementById('login-form');
      const signupForm = document.getElementById('signup-form');
      if (loginForm.style.display === 'none') {
        loginForm.style.display = 'block';
        signupForm.style.display = 'none';
      } else {
        loginForm.style.display = 'none';
        signupForm.style.display = 'block';
      }
    }

    async function handleLogin() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      showLoader('login-loader');
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        showNotification(`خطأ في تسجيل الدخول: ${error.message}`, true);
      } finally {
        hideLoader('login-loader');
      }
    }

    async function handleSignup() {
      const firstname = document.getElementById('signup-firstname').value;
      const lastname = document.getElementById('signup-lastname').value;
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;

      if (password.length < 6) {
        showNotification('كلمة المرور يجب أن تكون 6 أحرف على الأقل.', true);
        return;
      }

      showLoader('signup-loader');
      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await db.collection('users').doc(userCredential.user.uid).set({
          firstname: firstname,
          lastname: lastname,
          email: email,
          currencies: {},
          transactions: [],
          clients: []
        });
        showNotification('تم إنشاء الحساب بنجاح!');
      } catch (error) {
        showNotification(`خطأ في إنشاء الحساب: ${error.message}`, true);
      } finally {
        hideLoader('signup-loader');
      }
    }

    async function signInWithGoogle() {
      showLoader('google-loader'); // Use a single loader for both forms or separate as needed
      showLoader('google-loader-signup');
      try {
        const result = await auth.signInWithPopup(googleProvider);
        // Check if user document exists, if not, create it
        const userRef = db.collection('users').doc(result.user.uid);
        const doc = await userRef.get();
        if (!doc.exists) {
          await userRef.set({
            firstname: result.user.displayName ? result.user.displayName.split(' ')[0] : '',
            lastname: result.user.displayName ? result.user.displayName.split(' ').slice(1).join(' ') : '',
            email: result.user.email,
            currencies: {},
            transactions: [],
            clients: []
          });
        }
      } catch (error) {
        showNotification(`خطأ في تسجيل الدخول باستخدام Google: ${error.message}`, true);
      } finally {
        hideLoader('google-loader');
        hideLoader('google-loader-signup');
      }
    }

    async function handlePasswordReset(event) {
        event.preventDefault();
        const email = document.getElementById('login-email').value;
        if (!email) {
            showNotification('الرجاء إدخال بريدك الإلكتروني لإعادة تعيين كلمة المرور.', true);
            return;
        }
        try {
            await auth.sendPasswordResetEmail(email);
            showNotification('تم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني.');
        } catch (error) {
            showNotification(`خطأ في إعادة تعيين كلمة المرور: ${error.message}`, true);
        }
    }

    async function logout() {
      try {
        await auth.signOut();
        showNotification('تم تسجيل الخروج بنجاح.');
      } catch (error) {
        showNotification(`خطأ في تسجيل الخروج: ${error.message}`, true);
      }
    }

    // Page navigation
    let currentPage = 'main-content';
    const pages = ['main-content', 'balances-page', 'transfers-page', 'expenses-page', 'transactions-page', 'customerDebtsPage', 'debtDetailsPage', 'settings-page'];

    function showPage(pageId) {
      pages.forEach(id => {
        document.getElementById(id).classList.remove('active-page');
      });
      document.getElementById(pageId).classList.add('active-page');
      currentPage = pageId;

      const mainHeader = document.getElementById('main-header');
      const pageHeader = document.getElementById('page-header');
      const pageTitle = document.getElementById('page-title');

      if (pageId === 'main-content') {
        mainHeader.style.display = 'block';
        pageHeader.style.display = 'none';
      } else {
        mainHeader.style.display = 'none';
        pageHeader.style.display = 'flex';
        // Set page title based on the card clicked or page ID
        const card = document.getElementById(pageId.replace('-page', '-card'));
        if (card) {
            pageTitle.textContent = card.querySelector('h3').textContent;
        } else if (pageId === 'debtDetailsPage') {
            pageTitle.textContent = 'تفاصيل ديون العميل';
        } else {
            pageTitle.textContent = document.querySelector(`#${pageId} h2`).textContent;
        }
      }
      // Specific logic for pages that need data loaded
      if (pageId === 'balances-page') {
        renderBalances();
        renderRecentTransactions();
      } else if (pageId === 'transfers-page') {
        populateCurrencySelects('fromCurrency', 'toCurrency');
      } else if (pageId === 'expenses-page') {
        populateCurrencySelects('expenseCurrency');
      } else if (pageId === 'transactions-page') {
        renderTransactions();
      } else if (pageId === 'customerDebtsPage') {
        renderClientsList();
        renderOverallDebtSummary();
      } else if (pageId === 'settings-page') {
        renderCurrencyList();
      }
    }

    function goBack() {
      if (currentPage === 'debtDetailsPage') {
        showPage('customerDebtsPage');
      } else {
        showPage('main-content');
      }
    }

    // Data handling functions
    async function getUserData() {
      if (userDocRef) {
        const doc = await userDocRef.get();
        return doc.data();
      }
      return null;
    }

    async function updateUserData(data) {
      if (userDocRef) {
        await userDocRef.update(data);
      }
    }

    // Currencies
    async function addCurrency() {
      const code = document.getElementById('newCurrencyCode').value.toUpperCase();
      const name = document.getElementById('newCurrencyName').value;
      if (!code || !name) {
        showNotification('الرجاء إدخال رمز واسم العملة.', true);
        return;
      }

      const userData = await getUserData();
      if (userData.currencies[code]) {
        showNotification('هذه العملة موجودة بالفعل.', true);
        return;
      }

      userData.currencies[code] = { name: name, balance: 0 };
      await updateUserData({ currencies: userData.currencies });
      showNotification(`تم إضافة عملة ${name} بنجاح.`);
      document.getElementById('newCurrencyCode').value = '';
      document.getElementById('newCurrencyName').value = '';
      renderCurrencyList();
    }

    async function deleteCurrency(code) {
      if (!confirm(`هل أنت متأكد أنك تريد حذف عملة ${code}؟ سيتم حذف جميع المعاملات المتعلقة بها.`)) {
        return;
      }
      const userData = await getUserData();
      delete userData.currencies[code];
      // Also remove transactions related to this currency
      userData.transactions = userData.transactions.filter(t => t.currency !== code);
      await updateUserData({ currencies: userData.currencies, transactions: userData.transactions });
      showNotification(`تم حذف عملة ${code} بنجاح.`);
      renderCurrencyList();
      renderBalances(); // Update balances display
      renderTransactions(); // Update transactions display
    }

    async function renderCurrencyList() {
      const userData = await getUserData();
      const currencyListDiv = document.getElementById('currencyList');
      currencyListDiv.innerHTML = '';
      for (const code in userData.currencies) {
        const currency = userData.currencies[code];
        const div = document.createElement('div');
        div.className = 'balance-item';
        div.innerHTML = `
          <span>${currency.name} (${code})</span>
          <button class="btn-danger" data-currency-code="${code}">حذف</button>
        `;
        currencyListDiv.appendChild(div);
      }
      // Attach event listeners to delete buttons
      currencyListDiv.querySelectorAll('.btn-danger').forEach(button => {
        button.addEventListener('click', (event) => {
          deleteCurrency(event.target.dataset.currencyCode);
        });
      });
    }

    async function populateCurrencySelects(...selectIds) {
      const userData = await getUserData();
      const currencies = userData.currencies;
      selectIds.forEach(selectId => {
        const selectElement = document.getElementById(selectId);
        selectElement.innerHTML = '';
        for (const code in currencies) {
          const option = document.createElement('option');
          option.value = code;
          option.textContent = `${currencies[code].name} (${code})`;
          selectElement.appendChild(option);
        }
      });
    }

    // Balances
    async function renderBalances() {
      const userData = await getUserData();
      const balancesListDiv = document.getElementById('balancesList');
      balancesListDiv.innerHTML = '';
      for (const code in userData.currencies) {
        const currency = userData.currencies[code];
        const div = document.createElement('div');
        div.className = 'balance-item';
        div.innerHTML = `
          <span>${currency.name} (${code}):</span>
          <span>${currency.balance.toFixed(2)} ${code}</span>
        `;
        balancesListDiv.appendChild(div);
      }
    }

    // Transfers
    let isManualRate = false;
    function toggleRateMode() {
      isManualRate = !isManualRate;
      const rateInput = document.getElementById('exchangeRate');
      const rateBtn = document.getElementById('rateModeBtn');
      if (isManualRate) {
        rateInput.readOnly = false;
        rateBtn.textContent = '✓';
        showNotification('أدخل سعر الصرف يدوياً.');
      } else {
        rateInput.readOnly = true;
        rateBtn.textContent = '×';
        showNotification('سيتم حساب سعر الصرف تلقائياً.');
        calculateExchangeRate();
      }
    }

    async function calculateExchangeRate() {
      if (isManualRate) return;
      const fromCurrency = document.getElementById('fromCurrency').value;
      const toCurrency = document.getElementById('toCurrency').value;
      if (fromCurrency && toCurrency && fromCurrency !== toCurrency) {
        // In a real app, you'd fetch this from an API
        // For now, a simple placeholder logic
        let rate = 1;
        if (fromCurrency === 'USD' && toCurrency === 'EGP') rate = 30.9;
        else if (fromCurrency === 'EGP' && toCurrency === 'USD') rate = 1 / 30.9;
        else if (fromCurrency === 'USD' && toCurrency === 'SAR') rate = 3.75;
        else if (fromCurrency === 'SAR' && toCurrency === 'USD') rate = 1 / 3.75;
        else if (fromCurrency === 'EGP' && toCurrency === 'SAR') rate = 3.75 / 30.9;
        else if (fromCurrency === 'SAR' && toCurrency === 'EGP') rate = 30.9 / 3.75;
        document.getElementById('exchangeRate').value = rate.toFixed(4);
      } else {
        document.getElementById('exchangeRate').value = '';
      }
    }

    async function performTransfer() {
      const fromCurrencyCode = document.getElementById('fromCurrency').value;
      const toCurrencyCode = document.getElementById('toCurrency').value;
      const amount = parseFloat(document.getElementById('transferAmount').value);
      const exchangeRate = parseFloat(document.getElementById('exchangeRate').value);
      const comment = document.getElementById('transferComment').value;

      if (!fromCurrencyCode || !toCurrencyCode || isNaN(amount) || amount <= 0 || isNaN(exchangeRate) || exchangeRate <= 0) {
        showNotification('الرجاء إدخال جميع حقول التحويل بشكل صحيح.', true);
        return;
      }
      if (fromCurrencyCode === toCurrencyCode) {
        showNotification('لا يمكنك التحويل إلى نفس العملة.', true);
        return;
      }

      const userData = await getUserData();
      if (userData.currencies[fromCurrencyCode].balance < amount) {
        showNotification('الرصيد غير كافٍ لإجراء هذا التحويل.', true);
        return;
      }

      userData.currencies[fromCurrencyCode].balance -= amount;
      userData.currencies[toCurrencyCode].balance += (amount * exchangeRate);

      const transaction = {
        id: Date.now(),
        type: 'تحويل',
        fromCurrency: fromCurrencyCode,
        toCurrency: toCurrencyCode,
        amount: amount,
        convertedAmount: amount * exchangeRate,
        exchangeRate: exchangeRate,
        comment: comment,
        timestamp: new Date().toISOString()
      };
      userData.transactions.unshift(transaction); // Add to beginning

      await updateUserData({ currencies: userData.currencies, transactions: userData.transactions });
      showNotification('تم التحويل بنجاح!');
      // Clear form
      document.getElementById('transferAmount').value = '';
      document.getElementById('transferComment').value = '';
      renderBalances();
      renderRecentTransactions();
    }

    // Expenses (صادر ووارد)
    async function performExpense() {
      const person = document.getElementById('expensePerson').value;
      const type = document.getElementById('expenseType').value;
      const amount = parseFloat(document.getElementById('expenseAmount').value);
      const currency = document.getElementById('expenseCurrency').value;
      const details = document.getElementById('expenseDetails').value;

      if (!person || !type || isNaN(amount) || amount <= 0 || !currency) {
        showNotification('الرجاء إدخال جميع حقول الصادر/الوارد بشكل صحيح.', true);
        return;
      }

      const userData = await getUserData();
      if (type === 'صادر' && userData.currencies[currency].balance < amount) {
        showNotification('الرصيد غير كافٍ لتسجيل هذا الصادر.', true);
        return;
      }

      if (type === 'صادر') {
        userData.currencies[currency].balance -= amount;
      } else {
        userData.currencies[currency].balance += amount;
      }

      const transaction = {
        id: Date.now(),
        type: type,
        person: person,
        amount: amount,
        currency: currency,
        details: details,
        timestamp: new Date().toISOString()
      };
      userData.transactions.unshift(transaction); // Add to beginning

      await updateUserData({ currencies: userData.currencies, transactions: userData.transactions });
      showNotification(`تم تسجيل ${type} بنجاح!`);
      // Clear form
      document.getElementById('expensePerson').value = '';
      document.getElementById('expenseAmount').value = '';
      document.getElementById('expenseDetails').value = '';
      renderBalances();
      renderRecentTransactions();
    }

    // Transactions
    async function renderTransactions(searchTerm = '') {
      const userData = await getUserData();
      const transactionsListDiv = document.getElementById('transactionsList');
      transactionsListDiv.innerHTML = '';

      const filteredTransactions = userData.transactions.filter(t => 
        JSON.stringify(t).toLowerCase().includes(searchTerm.toLowerCase())
      );

      if (filteredTransactions.length === 0) {
        transactionsListDiv.innerHTML = '<p style="text-align: center; color: #666;">لا توجد معاملات لعرضها.</p>';
        return;
      }

      filteredTransactions.forEach(t => {
        const div = document.createElement('div');
        div.className = 'balance-item'; // Reusing style
        let details = '';
        if (t.type === 'تحويل') {
          details = `تحويل: ${t.amount} ${t.fromCurrency} إلى ${t.convertedAmount.toFixed(2)} ${t.toCurrency} (سعر الصرف: ${t.exchangeRate})`;
        } else if (t.type === 'صادر' || t.type === 'وارد') {
          details = `${t.type}: ${t.amount} ${t.currency} من/إلى ${t.person}`; 
        }
        if (t.details) details += ` - ${t.details}`;
        if (t.comment) details += ` - ${t.comment}`;

        div.innerHTML = `
          <span>${new Date(t.timestamp).toLocaleString()}</span>
          <span>${details}</span>
        `;
        transactionsListDiv.appendChild(div);
      });
    }

    function searchTransactions() {
      const searchTerm = document.getElementById('transactionSearch').value;
      renderTransactions(searchTerm);
    }

    async function renderRecentTransactions() {
      const userData = await getUserData();
      const recentTransactionsDiv = document.getElementById('recentTransactions');
      recentTransactionsDiv.innerHTML = '';

      const recent = userData.transactions.slice(0, 5); // Get last 5 transactions

      if (recent.length === 0) {
        recentTransactionsDiv.innerHTML = '<p style="text-align: center; color: #666;">لا توجد معاملات حديثة.</p>';
        return;
      }

      recent.forEach(t => {
        const div = document.createElement('div');
        div.className = 'balance-item'; // Reusing style
        let details = '';
        if (t.type === 'تحويل') {
          details = `تحويل: ${t.amount} ${t.fromCurrency} إلى ${t.convertedAmount.toFixed(2)} ${t.toCurrency}`; 
        } else if (t.type === 'صادر' || t.type === 'وارد') {
          details = `${t.type}: ${t.amount} ${t.currency} من/إلى ${t.person}`; 
        }
        div.innerHTML = `
          <span>${new Date(t.timestamp).toLocaleDateString()}</span>
          <span>${details}</span>
        `;
        recentTransactionsDiv.appendChild(div);
      });
    }

    // Customer Debts
    function toggleAddClient() {
      const section = document.getElementById('addClientSection');
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
      document.getElementById('removeClientSection').style.display = 'none';
    }

    function toggleRemoveClient() {
      const section = document.getElementById('removeClientSection');
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
      document.getElementById('addClientSection').style.display = 'none';
      populateRemoveClientDropdown();
    }

    async function addClientDebt() {
      const name = document.getElementById('newClientName').value;
      const phone = document.getElementById('newClientPhone').value;
      const note = document.getElementById('newClientNote').value;

      if (!name) {
        showNotification('الرجاء إدخال اسم العميل.', true);
        return;
      }

      const userData = await getUserData();
      const newClient = {
        id: Date.now().toString(), // Unique ID for client
        name: name,
        phone: phone,
        note: note,
        debts: {} // {currencyCode: amount}
      };
      userData.clients.push(newClient);
      await updateUserData({ clients: userData.clients });
      showNotification(`تم إضافة العميل ${name} بنجاح.`);
      document.getElementById('newClientName').value = '';
      document.getElementById('newClientPhone').value = '';
      document.getElementById('newClientNote').value = '';
      renderClientsList();
      toggleAddClient(); // Hide form after adding
    }

    async function populateRemoveClientDropdown() {
      const userData = await getUserData();
      const dropdown = document.getElementById('removeClientDropdown');
      dropdown.innerHTML = '';
      userData.clients.forEach(client => {
        const option = document.createElement('option');
        option.value = client.id;
        option.textContent = client.name;
        dropdown.appendChild(option);
      });
    }

    async function removeClientFromDropdown() {
      const clientIdToRemove = document.getElementById('removeClientDropdown').value;
      if (!clientIdToRemove) {
        showNotification('الرجاء اختيار عميل للحذف.', true);
        return;
      }
      if (!confirm('هل أنت متأكد أنك تريد حذف هذا العميل وجميع ديونه؟')) {
        return;
      }

      const userData = await getUserData();
      userData.clients = userData.clients.filter(client => client.id !== clientIdToRemove);
      await updateUserData({ clients: userData.clients });
      showNotification('تم حذف العميل بنجاح.');
      renderClientsList();
      populateRemoveClientDropdown();
      toggleRemoveClient(); // Hide form after removing
    }

    async function renderClientsList() {
      const userData = await getUserData();
      const clientsListDisplay = document.getElementById('clientsListDisplay');
      clientsListDisplay.innerHTML = '';

      if (userData.clients.length === 0) {
        clientsListDisplay.innerHTML = '<p style="text-align: center; color: #666;">لا يوجد عملاء مسجلون.</p>';
        return;
      }

      userData.clients.forEach(client => {
        const div = document.createElement('div');
        div.className = 'balance-item'; // Reusing style
        div.style.cursor = 'pointer';
        div.innerHTML = `
          <span>${client.name}</span>
          <span>${Object.values(client.debts).map(d => `${d.toFixed(2)}`).join(', ')}</span>
        `;
        div.addEventListener('click', () => showClientDebtDetails(client.id));
        clientsListDisplay.appendChild(div);
      });
    }

    async function renderOverallDebtSummary() {
      const userData = await getUserData();
      const overallDebtSummaryDiv = document.getElementById('overallDebtSummary');
      const totalDebts = {};

      userData.clients.forEach(client => {
        for (const currency in client.debts) {
          if (!totalDebts[currency]) {
            totalDebts[currency] = 0;
          }
          totalDebts[currency] += client.debts[currency];
        }
      });

      overallDebtSummaryDiv.innerHTML = `
        <span>إجمالي الديون (لك):</span>
        <span>${Object.keys(totalDebts).map(c => `${totalDebts[c].toFixed(2)} ${c}`).join(', ') || '0'}</span>
      `;
    }

    async function showClientDebtDetails(clientId) {
      const userData = await getUserData();
      const client = userData.clients.find(c => c.id === clientId);
      if (!client) {
        showNotification('العميل غير موجود.', true);
        return;
      }
      currentClientDocRef = client; // Store current client for transactions

      document.getElementById('clientDetailsName').textContent = client.name;
      populateCurrencySelects('clientDebtCurrency');
      renderClientDebtSummary(client);
      renderClientDebtRecords(client);
      showPage('debtDetailsPage');
    }

    function renderClientDebtSummary(client) {
      const clientDebtSummaryDiv = document.getElementById('clientDebtSummary');
      clientDebtSummaryDiv.innerHTML = `
        <span>إجمالي الديون مع ${client.name}:</span>
        <span>${Object.keys(client.debts).map(c => `${client.debts[c].toFixed(2)} ${c}`).join(', ') || '0'}</span>
      `;
    }

    async function addClientTransaction() {
      const type = document.getElementById('clientDebtType').value;
      const amount = parseFloat(document.getElementById('clientDebtAmount').value);
      const currency = document.getElementById('clientDebtCurrency').value;
      const details = document.getElementById('clientDebtDetails').value;

      if (!currentClientDocRef || isNaN(amount) || amount <= 0 || !currency) {
        showNotification('الرجاء إدخال جميع حقول المعاملة بشكل صحيح.', true);
        return;
      }

      const userData = await getUserData();
      const clientIndex = userData.clients.findIndex(c => c.id === currentClientDocRef.id);
      if (clientIndex === -1) return; // Should not happen

      const client = userData.clients[clientIndex];

      if (!client.debts[currency]) {
        client.debts[currency] = 0;
      }

      if (type === 'لك') { // Client owes you
        client.debts[currency] += amount;
      } else { // You owe client
        client.debts[currency] -= amount;
      }

      // Add transaction record for client
      if (!client.transactions) client.transactions = [];
      client.transactions.unshift({
        id: Date.now(),
        type: type,
        amount: amount,
        currency: currency,
        details: details,
        timestamp: new Date().toISOString()
      });

      await updateUserData({ clients: userData.clients });
      showNotification('تم تسجيل المعاملة بنجاح.');
      document.getElementById('clientDebtAmount').value = '';
      document.getElementById('clientDebtDetails').value = '';
      renderClientDebtSummary(client);
      renderClientDebtRecords(client);
      renderOverallDebtSummary();
    }

    function renderClientDebtRecords(client) {
      const clientDebtRecordsDiv = document.getElementById('clientDebtRecords');
      clientDebtRecordsDiv.innerHTML = '';

      if (!client.transactions || client.transactions.length === 0) {
        clientDebtRecordsDiv.innerHTML = '<p style="text-align: center; color: #666;">لا توجد سجلات ديون لهذا العميل.</p>';
        return;
      }

      client.transactions.forEach(t => {
        const div = document.createElement('div');
        div.className = 'debt-record';
        div.innerHTML = `
          <span>${new Date(t.timestamp).toLocaleString()} - ${t.type}: ${t.amount} ${t.currency}</span>
          <p>${t.details || 'لا توجد تفاصيل'}</p>
        `;
        clientDebtRecordsDiv.appendChild(div);
      });
    }

    // Backup and Restore
    async function backupData() {
      const userData = await getUserData();
      const dataStr = JSON.stringify(userData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `financial_data_backup_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showNotification('تم إنشاء نسخة احتياطية بنجاح.');
    }

    function restoreData() {
      const fileInput = document.getElementById('restoreFileInput');
      fileInput.click(); // Trigger file input click
      fileInput.onchange = async (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = async (e) => {
            try {
              const restoredData = JSON.parse(e.target.result);
              if (confirm('هل أنت متأكد أنك تريد استعادة البيانات؟ سيتم استبدال بياناتك الحالية.')) {
                await updateUserData(restoredData);
                showNotification('تم استعادة البيانات بنجاح. سيتم تحديث الصفحة.');
                location.reload(); // Reload to reflect changes
              }
            } catch (error) {
              showNotification('خطأ في قراءة ملف النسخة الاحتياطية أو تنسيقه غير صحيح.', true);
            }
          };
          reader.readAsText(file);
        }
      };
    }

    // Export functions
    async function exportTransactionsToPdf() {
      const userData = await getUserData();
      const transactions = userData.transactions;

      if (transactions.length === 0) {
        showNotification('لا توجد معاملات لتصديرها.', true);
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFont('Tajawal', 'normal'); // Set a font that supports Arabic
      doc.addFont('Tajawal-Regular.ttf', 'Tajawal', 'normal'); // You might need to embed the font

      let y = 10;
      doc.text('سجل المعاملات المالية', 105, y, { align: 'center' });
      y += 10;

      transactions.forEach(t => {
        let details = '';
        if (t.type === 'تحويل') {
          details = `تحويل: ${t.amount} ${t.fromCurrency} إلى ${t.convertedAmount.toFixed(2)} ${t.toCurrency} (سعر الصرف: ${t.exchangeRate})`;
        } else if (t.type === 'صادر' || t.type === 'وارد') {
          details = `${t.type}: ${t.amount} ${t.currency} من/إلى ${t.person}`; 
        }
        if (t.details) details += ` - ${t.details}`;
        if (t.comment) details += ` - ${t.comment}`;

        doc.text(`${new Date(t.timestamp).toLocaleString()} - ${details}`, 10, y);
        y += 7;
        if (y > 280) { // New page if content exceeds
          doc.addPage();
          y = 10;
        }
      });

      doc.save('transactions.pdf');
      showNotification('تم تصدير المعاملات كـ PDF بنجاح.');
    }

    async function exportTransactionsToExcel() {
      const userData = await getUserData();
      const transactions = userData.transactions;

      if (transactions.length === 0) {
        showNotification('لا توجد معاملات لتصديرها.', true);
        return;
      }

      const headers = ["التاريخ والوقت", "النوع", "المبلغ", "العملة", "من/إلى", "تفاصيل/تعليق", "العملة المحولة", "المبلغ المحول", "سعر الصرف"];
      const rows = transactions.map(t => {
        let person = '';
        let detailsComment = t.details || t.comment || '';
        let convertedAmount = '';
        let exchangeRate = '';
        let toCurrency = '';

        if (t.type === 'تحويل') {
          person = `${t.fromCurrency} إلى ${t.toCurrency}`;
          convertedAmount = t.convertedAmount.toFixed(2);
          exchangeRate = t.exchangeRate;
          toCurrency = t.toCurrency;
        } else if (t.type === 'صادر' || t.type === 'وارد') {
          person = t.person;
        }

        return [
          new Date(t.timestamp).toLocaleString(),
          t.type,
          t.amount,
          t.currency,
          person,
          detailsComment,
          toCurrency,
          convertedAmount,
          exchangeRate
        ];
      });

      const csvContent = [headers.join('\t'), ...rows.map(e => e.join('\t'))].join('\n');
      const blob = new Blob([csvContent], { type: 'text/tab-separated-values;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `transactions_${new Date().toISOString().slice(0,10)}.xls`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showNotification('تم تصدير المعاملات كـ Excel بنجاح.');
    }

    // Account Management
    async function changePassword() {
      const email = auth.currentUser.email;
      if (!email) {
        showNotification('لا يمكن تغيير كلمة المرور. الرجاء تسجيل الدخول أولاً.', true);
        return;
      }
      try {
        await auth.sendPasswordResetEmail(email);
        showNotification('تم إرسال رابط تغيير كلمة المرور إلى بريدك الإلكتروني.');
      } catch (error) {
        showNotification(`خطأ في تغيير كلمة المرور: ${error.message}`, true);
      }
    }

    async function deleteAccount() {
      if (!confirm('هل أنت متأكد أنك تريد حذف حسابك؟ لا يمكن التراجع عن هذا الإجراء.')) {
        return;
      }
      try {
        // Delete user data from Firestore first
        if (userDocRef) {
          await userDocRef.delete();
        }
        // Then delete the user account
        await auth.currentUser.delete();
        showNotification('تم حذف حسابك بنجاح.');
      } catch (error) {
        showNotification(`خطأ في حذف الحساب: ${error.message}`, true);
      }
    }

    // Firebase Auth State Listener
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        userDocRef = db.collection('users').doc(user.uid);
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        showPage('main-content'); // Show main content after login
        initializeEventListeners(); // Initialize event listeners after user is logged in and app is displayed
      } else {
        currentUser = null;
        userDocRef = null;
        document.getElementById('auth-container').style.display = 'flex';
        document.getElementById('app-container').style.display = 'none';
      }
    });

    // NEW: Function to initialize all event listeners
    function initializeEventListeners() {
        // Auth Page Buttons
        document.getElementById('forgot-password-link').addEventListener('click', handlePasswordReset);
        document.getElementById('login-button').addEventListener('click', handleLogin);
        document.getElementById('google-sign-in-button-login').addEventListener('click', signInWithGoogle);
        document.getElementById('toggle-signup-link').addEventListener('click', toggleAuthForms);
        document.getElementById('signup-button').addEventListener('click', handleSignup);
        document.getElementById('google-sign-in-button-signup').addEventListener('click', signInWithGoogle);
        document.getElementById('toggle-login-link').addEventListener('click', toggleAuthForms);

        // Main Navigation Cards
        document.getElementById('balances-card').addEventListener('click', () => showPage('balances-page'));
        document.getElementById('transfers-card').addEventListener('click', () => showPage('transfers-page'));
        document.getElementById('expenses-card').addEventListener('click', () => showPage('expenses-page'));
        document.getElementById('transactions-card').addEventListener('click', () => showPage('transactions-page'));
        document.getElementById('customer-debts-card').addEventListener('click', () => showPage('customerDebtsPage'));
        document.getElementById('settings-card').addEventListener('click', () => showPage('settings-page'));

        // Back Buttons
        document.getElementById('back-button-header').addEventListener('click', goBack);
        document.getElementById('back-button-customer-debts').addEventListener('click', goBack);
        document.getElementById('back-button-debt-details').addEventListener('click', goBack);

        // Transfers Page
        document.getElementById('rateModeBtn').addEventListener('click', toggleRateMode);
        document.getElementById('perform-transfer-button').addEventListener('click', performTransfer);
        document.getElementById('fromCurrency').addEventListener('change', calculateExchangeRate);
        document.getElementById('toCurrency').addEventListener('change', calculateExchangeRate);

        // Expenses Page
        document.getElementById('perform-expense-button').addEventListener('click', performExpense);

        // Transactions Page
        document.getElementById('transactionSearch').addEventListener('input', searchTransactions);

        // Customer Debts Page
        document.getElementById('toggle-add-client-button').addEventListener('click', toggleAddClient);
        document.getElementById('toggle-remove-client-button').addEventListener('click', toggleRemoveClient);
        document.getElementById('add-client-debt-button').addEventListener('click', addClientDebt);
        document.getElementById('remove-client-from-dropdown-button').addEventListener('click', removeClientFromDropdown);

        // Debt Details Page
        document.getElementById('add-client-transaction-button').addEventListener('click', addClientTransaction);

        // Settings Page
        document.getElementById('add-currency-button').addEventListener('click', addCurrency);
        document.getElementById('backup-data-button').addEventListener('click', backupData);
        document.getElementById('restore-data-button').addEventListener('click', restoreData);
        document.getElementById('export-transactions-pdf-button').addEventListener('click', exportTransactionsToPdf);
        document.getElementById('export-transactions-excel-button').addEventListener('click', exportTransactionsToExcel);
        document.getElementById('change-password-button').addEventListener('click', changePassword);
        document.getElementById('delete-account-button').addEventListener('click', deleteAccount);
        document.getElementById('logout-button').addEventListener('click', logout);
    }

    // Initial setup (if user is already logged in from previous session)
    // The onAuthStateChanged listener will handle showing the app or auth page
    // and call initializeEventListeners when the user is logged in.

  </script>
  <!-- Include jspdf library for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Include jspdf-autotable for better table support in PDF (optional but recommended) -->
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script> -->
</body>
</html>


