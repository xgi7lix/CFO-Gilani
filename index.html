<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>نظام الإدارة المالية المتقدم</title>

  <!-- خط -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <!-- أيقونات -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- html2canvas (للتصدير مستقبلاً إن احتجت) -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --primary:#2C786C;
      --secondary:#004445;
      --accent:#FFD166;
      --light:#f8f9fa;
      --dark:#333;
      --danger:#dc3545;
      --danger-hover:#c82333;
      --shadow:0 4px 6px rgba(0,0,0,.1);
      --t:all .25s ease;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Tajawal',sans-serif;
      background:var(--light);
      color:var(--dark);
      line-height:1.6;
    }

    /* رأس */
    header{
      background:var(--primary);
      color:#fff;
      box-shadow:var(--shadow);
    }
    #main-header{padding:16px 0}
    #main-header h1{margin:0;font-size:1.4rem;text-align:center}
    #page-header{display:none;align-items:center;gap:12px;padding:10px 12px}
    #page-title{margin:0;font-size:1.1rem}

    /* حاوية */
    .container{max-width:1100px;margin:0 auto;padding:14px}

    /* شبكة البطاقات */
    .main-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    @media(min-width:768px){.main-grid{grid-template-columns:repeat(3,1fr)}}
    .main-card{
      background:#fff;border:2px solid var(--primary);border-radius:12px;
      padding:18px;text-align:center;cursor:pointer;transition:var(--t);
      min-height:120px;display:flex;flex-direction:column;justify-content:center;align-items:center
    }
    .main-card i{font-size:28px;color:var(--primary);margin-bottom:8px}
    .main-card:hover{transform:translateY(-4px);background:var(--primary);color:#fff}
    .main-card:hover i{color:#fff}

    /* الصفحات */
    .page{display:none;background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:14px;margin-top:14px}
    .active-page{display:block}
    .page-header{display:flex;align-items:center;gap:8px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #eee}
    .page-header i{color:var(--primary)}

    /* عناصر نموذج */
    .form-row{margin-bottom:12px}
    label{display:block;margin-bottom:6px;font-weight:700}
    input,select,textarea,button{
      width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-family:'Tajawal',sans-serif;font-size:14px
    }
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(44,120,108,.15)}
    textarea{resize:vertical}
    button{cursor:pointer;background:var(--primary);color:#fff;border:none;font-weight:700;transition:var(--t)}
    button:hover{background:var(--secondary)}
    .btn-danger{background:var(--danger)}
    .btn-danger:hover{background:var(--danger-hover)}
    .btn-wide{display:block;width:100%;padding:14px;margin:10px 0;text-align:right}

    .balance-item{padding:10px;margin:6px 0;background:#f7f7f8;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
    .debt-records-container{padding:8px;background:#f7f7f8;border-radius:8px;max-height:300px;overflow:auto}
    .debt-record{padding:8px;margin:6px 0;background:#fff;border:1px solid #eee;border-radius:8px}

    /* توست */
    .notification{
      position:fixed;top:16px;left:50%;transform:translateX(-50%);
      background:#28a745;color:#fff;padding:10px 14px;border-radius:8px;z-index:9999;box-shadow:var(--shadow)
    }
    .notification.error{background:var(--danger)}

    /* مصادقة */
    #auth-container{min-height:100vh;display:flex;justify-content:center;align-items:center;padding:16px}
    .auth-box{background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:22px;max-width:400px;width:100%}
    .auth-box h2{margin:0 0 14px;color:var(--primary)}
    .auth-switch{margin-top:12px;text-align:center}
    .auth-switch a{color:var(--primary);cursor:pointer;font-weight:700}
    .auth-switch a:hover{text-decoration:underline}
    .google-btn{background:#4285F4}
    .google-btn:hover{background:#357ae8}
    .or-sep{margin:14px 0;text-align:center;color:#999}

    /* لودر */
    .loader{
      display:none;border:4px solid #eee;border-top:4px solid var(--primary);
      border-radius:50%;width:28px;height:28px;margin:10px auto;animation:spin 1s linear infinite
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* زر رجوع */
    .back-button{background:rgba(255,255,255,.2);border:none;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>

  <!-- واجهة المصادقة -->
  <div id="auth-container">
    <div class="auth-box">
      <!-- تسجيل الدخول -->
      <div id="login-form">
        <h2>تسجيل الدخول</h2>
        <div class="form-row">
          <label for="login-email">البريد الإلكتروني</label>
          <input type="email" id="login-email" placeholder="email@example.com" required>
        </div>
        <div class="form-row">
          <label for="login-password">كلمة المرور</label>
          <input type="password" id="login-password" placeholder="********" required>
        </div>
        <div class="form-row" style="text-align:left;margin:-6px 0 10px">
          <a href="#" onclick="handlePasswordReset(event)" class="auth-switch">نسيت كلمة المرور؟</a>
        </div>
        <button type="button" onclick="handleLogin()">تسجيل الدخول</button>
        <div class="loader" id="login-loader"></div>

        <div class="or-sep">أو</div>

        <button type="button" class="google-btn" onclick="signInWithGoogle()">
          <i class="fab fa-google"></i> المتابعة باستخدام Google
        </button>
        <div class="loader" id="google-loader"></div>

        <p class="auth-switch">ليس لديك حساب؟ <a onclick="toggleAuthForms()">إنشاء حساب جديد</a></p>
      </div>

      <!-- إنشاء حساب -->
      <div id="signup-form" style="display:none">
        <h2>إنشاء حساب جديد</h2>
        <div class="form-row">
          <label for="signup-firstname">الاسم الأول</label>
          <input id="signup-firstname" type="text" placeholder="مثال: أحمد" required>
        </div>
        <div class="form-row">
          <label for="signup-lastname">الاسم الأخير</label>
          <input id="signup-lastname" type="text" placeholder="مثال: محمد" required>
        </div>
        <div class="form-row">
          <label for="signup-email">البريد الإلكتروني</label>
          <input id="signup-email" type="email" placeholder="email@example.com" required>
        </div>
        <div class="form-row">
          <label for="signup-password">كلمة المرور</label>
          <input id="signup-password" type="password" placeholder="6 أحرف على الأقل" required>
        </div>
        <button type="button" onclick="handleSignup()">إنشاء حساب</button>
        <div class="loader" id="signup-loader"></div>

        <div class="or-sep">أو</div>

        <button type="button" class="google-btn" onclick="signInWithGoogle()">
          <i class="fab fa-google"></i> المتابعة باستخدام Google
        </button>
        <div class="loader" id="google-loader-signup"></div>

        <p class="auth-switch">لديك حساب بالفعل؟ <a onclick="toggleAuthForms()">تسجيل الدخول</a></p>
      </div>
    </div>
  </div>

  <!-- التطبيق -->
  <div id="app-container" style="display:none">
    <!-- رأس رئيسي -->
    <header id="main-header">
      <div class="container">
        <h1><i class="fas fa-wallet"></i> نظام الإدارة المالية المتقدم</h1>
      </div>
    </header>

    <!-- رأس صفحات -->
    <header id="page-header">
      <div class="container" style="display:flex;align-items:center;gap:10px">
        <button class="back-button" onclick="goBack()"><i class="fas fa-arrow-right"></i> رجوع</button>
        <h1 id="page-title"></h1>
      </div>
    </header>

    <main class="container" id="main-content">
      <div class="main-grid">
        <div class="main-card" onclick="showPage('balances-page')">
          <i class="fas fa-wallet"></i><h3>كشف الحساب</h3>
        </div>
        <div class="main-card" onclick="showPage('transfers-page')">
          <i class="fas fa-right-left"></i><h3>التحويلات</h3>
        </div>
        <div class="main-card" onclick="showPage('expenses-page')">
          <i class="fas fa-money-bill-wave"></i><h3>الصادر والوارد</h3>
        </div>
        <div class="main-card" onclick="showPage('transactions-page')">
          <i class="fas fa-list"></i><h3>كل المعاملات</h3>
        </div>
        <div class="main-card" onclick="showPage('customerDebtsPage')">
          <i class="fas fa-users"></i><h3>ديون العملاء</h3>
        </div>
        <div class="main-card" onclick="showPage('settings-page')">
          <i class="fas fa-gear"></i><h3>الإعدادات</h3>
        </div>
      </div>
    </main>

    <!-- كشف الحساب -->
    <div class="container page" id="balances-page">
      <div class="page-header"><i class="fas fa-wallet"></i><h2>كشف الحساب</h2></div>
      <div id="balancesList"></div>
      <h3 style="margin-top:12px">أحدث المعاملات</h3>
      <div id="recentTransactions"></div>
    </div>

    <!-- التحويلات -->
    <div class="container page" id="transfers-page">
      <div class="page-header"><i class="fas fa-right-left"></i><h2>التحويلات</h2></div>
      <div class="form-row"><label>من:</label><select id="fromCurrency"></select></div>
      <div class="form-row"><label>إلى:</label><select id="toCurrency"></select></div>
      <div class="form-row"><label>المبلغ:</label><input id="transferAmount" type="number" placeholder="أدخل المبلغ"></div>
      <div class="form-row">
        <label>سعر الصرف:</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="exchangeRate" type="number" step="0.0001" placeholder="أدخل سعر الصرف">
          <button id="rateModeBtn" type="button" style="width:auto" onclick="toggleRateMode()">×</button>
        </div>
      </div>
      <div class="form-row"><label>تعليق (اختياري):</label><input id="transferComment" type="text" placeholder="تعليق"></div>
      <button type="button" onclick="performTransfer()"><i class="fas fa-check"></i> تنفيذ التحويل</button>
    </div>

    <!-- الصادر والوارد -->
    <div class="container page" id="expenses-page">
      <div class="page-header"><i class="fas fa-money-bill-wave"></i><h2>الصادر والوارد</h2></div>
      <div class="form-row"><label>الاسم:</label><input id="expensePerson" type="text" placeholder="اسم العميل/المورد"></div>
      <div class="form-row"><label>نوع العملية:</label>
        <select id="expenseType"><option value="صادر">صادر</option><option value="وارد">وارد</option></select>
      </div>
      <div class="form-row"><label>المبلغ:</label><input id="expenseAmount" type="number" placeholder="المبلغ"></div>
      <div class="form-row"><label>العملة:</label><select id="expenseCurrency"></select></div>
      <div class="form-row"><label>تفاصيل:</label><textarea id="expenseDetails" rows="3" placeholder="تفاصيل العملية"></textarea></div>
      <button type="button" onclick="performExpense()"><i class="fas fa-check"></i> تنفيذ العملية</button>
    </div>

    <!-- كل المعاملات -->
    <div class="container page" id="transactions-page">
      <div class="page-header"><i class="fas fa-list"></i><h2>كل المعاملات</h2></div>
      <div class="form-row"><input id="transactionSearch" type="text" placeholder="ابحث..." oninput="searchTransactions()"></div>
      <div id="transactionsList"></div>
    </div>

    <!-- ديون العملاء -->
    <div class="container page" id="customerDebtsPage">
      <div class="page-header"><i class="fas fa-users"></i><h2>ديون العملاء</h2></div>
      <div id="overallDebtSummary" class="balance-item"></div>

      <div class="form-row" style="display:flex;gap:8px">
        <button type="button" onclick="toggleAddClient()">إضافة عميل</button>
        <button type="button" onclick="toggleRemoveClient()">إزالة عميل</button>
      </div>

      <div id="addClientSection" class="page" style="display:none;padding:10px;margin:0">
        <h3>إضافة عميل جديد</h3>
        <div class="form-row"><label>الاسم:</label><input id="newClientName" type="text"></div>
        <div class="form-row"><label>الهاتف:</label><input id="newClientPhone" type="text"></div>
        <div class="form-row"><label>ملاحظة:</label><input id="newClientNote" type="text"></div>
        <button type="button" onclick="addClientDebt()">تسجيل العميل</button>
      </div>

      <div id="removeClientSection" class="page" style="display:none;padding:10px;margin:8px 0 0">
        <h3>إزالة عميل</h3>
        <select id="removeClientDropdown"></select>
        <button type="button" class="btn-danger" onclick="removeClientFromDropdown()">حذف</button>
      </div>

      <div style="margin-top:10px">
        <h3>العملاء المسجّلون</h3>
        <div id="clientsListDisplay"></div>
      </div>
    </div>

    <!-- تفاصيل عميل -->
    <div class="container page" id="debtDetailsPage">
      <div class="page-header"><i class="fas fa-user"></i><h2>تفاصيل ديون العميل: <span id="clientDetailsName"></span></h2></div>
      <div id="clientDebtSummary" class="balance-item"></div>

      <div class="form-row"><label>نوع العملية:</label>
        <select id="clientDebtType"><option value="لك">لك (يطلب منك)</option><option value="له">له (تطالبه)</option></select>
      </div>
      <div class="form-row"><label>المبلغ:</label><input id="clientDebtAmount" type="number"></div>
      <div class="form-row"><label>العملة:</label><select id="clientDebtCurrency"></select></div>
      <div class="form-row"><label>تفاصيل:</label><input id="clientDebtComment" type="text" placeholder="ملاحظة"></div>
      <button type="button" onclick="addOrUpdateClientDebt()">إضافة / تعديل</button>

      <h3 style="margin-top:14px">السجلات</h3>
      <div id="clientDebtDetails" class="debt-records-container"></div>
    </div>

    <!-- الإعدادات -->
    <div class="container page" id="settings-page">
      <div class="page-header"><i class="fas fa-gear"></i><h2>الإعدادات</h2></div>
      <button class="btn-wide" onclick="showSettingsPage('currency-settings')"><i class="fas fa-coins"></i> إدارة العملات</button>
      <button class="btn-wide" onclick="showSettingsPage('balance-settings')"><i class="fas fa-wallet"></i> إدارة الرصيد</button>
      <button class="btn-wide btn-danger" onclick="resetAllData()"><i class="fas fa-trash"></i> مسح جميع البيانات</button>
      <button class="btn-wide" onclick="handleLogout()"><i class="fas fa-right-from-bracket"></i> تسجيل الخروج</button>
    </div>

    <!-- إدارة العملات -->
    <div class="container page" id="currency-settings-page">
      <div class="page-header"><i class="fas fa-coins"></i><h2>إدارة العملات</h2></div>
      <div class="page" style="display:block;padding:0;margin:0;background:transparent;box-shadow:none">
        <div class="balance-item" style="flex-direction:column;align-items:stretch">
          <div class="form-row">
            <label>اختر العملة لإضافتها:</label>
            <select id="currency-select">
              <option value="USD">دولار أمريكي (USD)</option>
              <option value="EUR">يورو (EUR)</option>
              <option value="GBP">جنيه إسترليني (GBP)</option>
              <option value="SAR">ريال سعودي (SAR)</option>
              <option value="AED">درهم إماراتي (AED)</option>
              <option value="EGP">جنيه مصري (EGP)</option>
              <option value="SDG">جنيه سوداني (SDG)</option>
              <option value="QAR">ريال قطري (QAR)</option>
            </select>
          </div>
          <button type="button" onclick="addCurrency()"><i class="fas fa-plus"></i> إضافة</button>
        </div>
        <div class="page" style="display:block;background:#fff;padding:10px;border-radius:8px">
          <h3 style="margin:0 0 10px">العملات المضافة</h3>
          <div id="active-currencies-list"></div>
        </div>
      </div>
    </div>

    <!-- إدارة الرصيد -->
    <div class="container page" id="balance-settings-page">
      <div class="page-header"><i class="fas fa-wallet"></i><h2>إدارة الرصيد</h2></div>
      <div class="balance-item" style="flex-direction:column;align-items:stretch">
        <div class="form-row"><label>العملة:</label><select id="balance-currency-select"></select></div>
        <div class="form-row"><label>المبلغ الجديد:</label><input id="new-balance" type="number" placeholder="0.00"></div>
        <button type="button" onclick="updateBalance()"><i class="fas fa-floppy-disk"></i> حفظ</button>
      </div>
    </div>
  </div>

  <script>
    /* ====== أدوات مساعدة بسيطة ====== */
    const $ = (id)=> document.getElementById(id);
    const fmt = (n)=> (isNaN(n)?0:n).toFixed(2);

    /* ====== Firebase ====== */
    const firebaseConfig = {
      apiKey: "AIzaSyDLgv4ruPM7rmodEa_q4QoI7Cn_p84Sqww",
      authDomain: "galmok-9d8e7.firebaseapp.com",
      projectId: "galmok-9d8e7",
      storageBucket: "galmok-9d8e7.appspot.com",
      messagingSenderId: "193906028682",
      appId: "1:193906028682:web:00dd06fd80d556294b7d73",
      measurementId: "G-2XFFDDFEDD"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser=null, userDocRef=null;

    /* ====== الحالة العامة ====== */
    let balances = {};
    let currencies = {};
    let transactions = [];
    let clients = {};
    let transactionIdCounter = 1101;
    let currentDebtClient = null;
    let isMultiplyMode = true; // × أو ÷ في التحويل

    /* ====== إشعار (توست) ====== */
    function notify(msg, err=false){
      const n = document.createElement('div');
      n.className = 'notification' + (err?' error':'');
      n.textContent = msg;
      document.body.appendChild(n);
      setTimeout(()=> n.remove(), 3000);
    }

    /* ====== تنقّل الصفحات ====== */
    function showPage(pageId){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active-page'));
      const page = $(pageId);
      if(page) page.classList.add('active-page');

      $('#main-content').style.display = 'none';
      $('#main-header').style.display = 'none';
      $('#page-header').style.display = 'block';

      const titleEl = page ? page.querySelector('h2') : null;
      $('#page-title').textContent = titleEl ? titleEl.textContent : '';
      updateAllUI();
    }
    function goBack(){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active-page'));
      $('#main-content').style.display = '';
      $('#main-header').style.display = 'block';
      $('#page-header').style.display = 'none';
      updateAllUI();
    }
    function showSettingsPage(kind){
      showPage(`${kind}-page`);
    }

    /* ====== مصادقة ====== */
    function toggleAuthForms(){
      const login = $('#login-form'), signup = $('#signup-form');
      if(!login || !signup) return;
      const showLogin = (login.style.display==='none');
      login.style.display = showLogin ? 'block':'none';
      signup.style.display = showLogin ? 'none':'block';
    }

    auth.onAuthStateChanged(async (user)=>{
      const authC = $('#auth-container'), appC = $('#app-container');
      if(user){
        currentUser=user;
        userDocRef=db.collection('users').doc(user.uid);
        if(authC) authC.style.display='none';
        if(appC) appC.style.display='block';
        await loadData();
      }else{
        currentUser=null; userDocRef=null;
        if(authC) authC.style.display='flex';
        if(appC) appC.style.display='none';
      }
    });

    function getArabicAuthError(code){
      switch(code){
        case 'auth/invalid-email': return 'البريد الإلكتروني غير صالح.';
        case 'auth/user-disabled': return 'تم تعطيل هذا الحساب.';
        case 'auth/user-not-found': return 'البريد غير مسجل.';
        case 'auth/wrong-password': return 'كلمة المرور غير صحيحة.';
        case 'auth/email-already-in-use': return 'البريد مستخدم بحساب آخر.';
        case 'auth/weak-password': return 'كلمة المرور ضعيفة (6 أحرف على الأقل).';
        case 'auth/popup-blocked': return 'تم حظر النافذة المنبثقة.';
        case 'auth/network-request-failed': return 'فشل في الشبكة.';
        default: return 'حدث خطأ غير متوقع.';
      }
    }

    async function handleSignup(){
      const email = $('#signup-email')?.value || '';
      const pass  = $('#signup-password')?.value || '';
      const fn    = $('#signup-firstname')?.value.trim() || '';
      const ln    = $('#signup-lastname')?.value.trim() || '';

      if(!fn || !ln){ notify('الرجاء إدخال الاسم الأول والأخير.',true); return; }
      if(pass.length<6){ notify('كلمة المرور 6 أحرف على الأقل.',true); return; }

      const loader = $('#signup-loader'); if(loader) loader.style.display='block';

      try{
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        await cred.user.updateProfile({displayName:`${fn} ${ln}`});
        await db.collection('users').doc(cred.user.uid).set({
          balances:{SDG:0,QAR:0},
          currencies:{SDG:'جنيه سوداني',QAR:'ريال قطري'},
          transactions:[],
          clients:{},
          transactionIdCounter:1101
        });
        notify('تم إنشاء الحساب بنجاح!');
        if($('#signup-email')) $('#signup-email').value='';
        if($('#signup-password')) $('#signup-password').value='';
        if($('#signup-firstname')) $('#signup-firstname').value='';
        if($('#signup-lastname')) $('#signup-lastname').value='';
      }catch(e){
        notify(`خطأ: ${getArabicAuthError(e.code)}`,true);
      }finally{
        if(loader) loader.style.display='none';
      }
    }

    async function handleLogin(){
      const email = $('#login-email')?.value || '';
      const pass  = $('#login-password')?.value || '';
      const loader = $('#login-loader'); if(loader) loader.style.display='block';
      try{
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        notify(`مرحباً ${cred.user.displayName || 'بك'} !`);
      }catch(e){
        notify(`خطأ: ${getArabicAuthError(e.code)}`,true);
      }finally{
        if(loader) loader.style.display='none';
      }
    }

    async function signInWithGoogle(){
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({prompt:'select_account'});
      const l1=$('#google-loader'), l2=$('#google-loader-signup');
      if(l1) l1.style.display='block'; if(l2) l2.style.display='block';
      try{
        const res = await auth.signInWithPopup(provider);
        if(res?.additionalUserInfo?.isNewUser){
          await db.collection('users').doc(res.user.uid).set({
            balances:{SDG:0,QAR:0},
            currencies:{SDG:'جنيه سوداني',QAR:'ريال قطري'},
            transactions:[],
            clients:{},
            transactionIdCounter:1101
          });
          notify(`أهلاً بك ${res.user.displayName}!`);
        }else{
          notify(`أهلاً بك مجدداً ${res.user.displayName}!`);
        }
      }catch(e){
        notify(getArabicAuthError(e.code),true);
      }finally{
        if(l1) l1.style.display='none'; if(l2) l2.style.display='none';
      }
    }

    function handlePasswordReset(ev){
      ev?.preventDefault?.();
      const email = $('#login-email')?.value || '';
      if(!email){ notify('أدخل بريدك أولاً.',true); return; }
      auth.sendPasswordResetEmail(email)
        .then(()=> notify('تم إرسال رابط إعادة التعيين لبريدك.'))
        .catch(e=> notify(`خطأ: ${getArabicAuthError(e.code)}`,true));
    }

    function handleLogout(){
      auth.signOut().then(()=>{
        notify('تم تسجيل الخروج.');
        balances={}; currencies={}; transactions=[]; clients={}; transactionIdCounter=1101;
        goBack();
      }).catch(e=> notify(`خطأ: ${e.message}`,true));
    }

    /* ====== تحميل/حفظ البيانات من Firestore ====== */
    async function loadData(){
      if(!userDocRef) return;
      try{
        const snap = await userDocRef.get();
        if(snap.exists){
          const d=snap.data();
          balances = d.balances || {SDG:0,QAR:0};
          currencies = d.currencies || {SDG:'جنيه سوداني',QAR:'ريال قطري'};
          transactions = d.transactions || [];
          clients = d.clients || {};
          transactionIdCounter = d.transactionIdCounter || 1101;
        }else{
          await userDocRef.set({
            balances:{SDG:0,QAR:0},
            currencies:{SDG:'جنيه سوداني',QAR:'ريال قطري'},
            transactions:[],
            clients:{},
            transactionIdCounter:1101
          });
          balances={SDG:0,QAR:0};
          currencies={SDG:'جنيه سوداني',QAR:'ريال قطري'};
          transactions=[]; clients={}; transactionIdCounter=1101;
        }
      }catch(e){
        notify('تعذر تحميل البيانات.',true);
      }
      updateAllUI();
    }

    async function saveData(){
      if(!userDocRef) return;
      try{
        await userDocRef.set({
          balances, currencies, transactions, clients, transactionIdCounter
        });
      }catch(e){
        notify('تعذر حفظ البيانات.',true);
      }
    }

    /* ====== تحديث الواجهات ====== */
    function updateAllUI(){
      updateBalancesList();
      updateCurrencyDropdowns();
      updateActiveCurrenciesList();
      updateTransactionsList();
      updateClientsListDisplay();
      updateRemoveClientDropdown();
      if(currentDebtClient) updateClientDebtDetails();
    }

    /* كشف الحساب */
    function updateBalancesList(){
      const box = $('#balancesList'); if(!box) return;
      box.innerHTML='';
      Object.keys(balances).forEach(code=>{
        const val = Number(balances[code])||0;
        const div = document.createElement('div');
        div.className='balance-item';
        div.innerHTML = `<span>${currencies[code]||code}</span><strong>${fmt(val)} ${code}</strong>`;
        box.appendChild(div);
      });
    }

    function updateBalance(){
      const code = $('#balance-currency-select')?.value;
      const nb = parseFloat($('#new-balance')?.value||'');
      if(!code || isNaN(nb)){ notify('يرجى إدخال مبلغ صحيح.',true); return; }
      balances[code]=nb;
      saveData();
      notify('تم تحديث الرصيد.');
      updateBalancesList();
    }

    /* العملات */
    function updateCurrencyDropdowns(){
      const ids=['fromCurrency','toCurrency','expenseCurrency','balance-currency-select','clientDebtCurrency'];
      ids.forEach(id=>{
        const sel = $(id); if(!sel) return;
        sel.innerHTML='';
        Object.keys(currencies).forEach(code=>{
          const opt=document.createElement('option');
          opt.value=code; opt.textContent=currencies[code]||code;
          sel.appendChild(opt);
        });
      });
    }

    function addCurrency(){
      const sel = $('#currency-select'); if(!sel) return;
      const code = sel.value;
      const name = sel.options[sel.selectedIndex]?.text || code;
      if(currencies[code]){
        notify('العملة موجودة مسبقاً.',true); return;
      }
      currencies[code]=name;
      balances[code]=0;
      saveData();
      notify('تمت إضافة العملة.');
      updateAllUI();
    }

    function updateActiveCurrenciesList(){
      const box = $('#active-currencies-list'); if(!box) return;
      box.innerHTML='';
      Object.keys(currencies).forEach(code=>{
        const row=document.createElement('div');
        row.className='balance-item';
        row.innerHTML=`<span>${currencies[code]} (${code})</span>
          <button class="btn-danger" type="button" onclick="removeCurrency('${code}')">حذف</button>`;
        box.appendChild(row);
      });
    }

    function removeCurrency(code){
      if(!currencies[code]) return;
      if(!confirm(`هل تريد حذف ${currencies[code]}؟ سيتم حذف أرصدتها وسجلاتها.`)) return;
      delete currencies[code];
      delete balances[code];
      transactions = transactions.filter(t=> t.currency!==code && !(t.fromCurrency===code || t.toCurrency===code));
      Object.keys(clients).forEach(cid=>{
        clients[cid].debts = (clients[cid].debts||[]).filter(d=> d.currency!==code);
      });
      saveData();
      notify('تم الحذف.');
      updateAllUI();
    }

    /* التحويلات */
    function toggleRateMode(){
      isMultiplyMode = !isMultiplyMode;
      const btn = $('#rateModeBtn'); if(btn) btn.textContent = isMultiplyMode ? '×' : '÷';
      notify(isMultiplyMode ? 'وضع السعر: ضرب' : 'وضع السعر: قسمة');
    }

    function performTransfer(){
      const from = $('#fromCurrency')?.value, to = $('#toCurrency')?.value;
      const amount = parseFloat($('#transferAmount')?.value||'');
      const rate = parseFloat($('#exchangeRate')?.value||'');
      const comment = $('#transferComment')?.value || '';

      if(!from || !to || from===to){ notify('اختر عملتين مختلفتين.',true); return; }
      if(isNaN(amount)||amount<=0){ notify('مبلغ غير صالح.',true); return; }
      if(isNaN(rate)||rate<=0){ notify('سعر صرف غير صالح.',true); return; }
      if((balances[from]||0) < amount){ notify(`رصيد ${from} غير كافٍ.`,true); return; }

      const converted = isMultiplyMode ? amount*rate : amount/rate;

      balances[from] = (balances[from]||0) - amount;
      balances[to]   = (balances[to]||0) + converted;

      transactions.unshift({
        id: transactionIdCounter++,
        type:'تحويل',
        fromCurrency:from,
        toCurrency:to,
        amount, convertedAmount:converted, exchangeRate:rate,
        comment, date:new Date().toISOString()
      });

      saveData();
      notify('تم التحويل.');
      if($('#transferAmount')) $('#transferAmount').value='';
      if($('#transferComment')) $('#transferComment').value='';
      updateAllUI();
    }

    /* الصادر والوارد */
    function performExpense(){
      const person = $('#expensePerson')?.value || '';
      const type = $('#expenseType')?.value || 'صادر';
      const amount = parseFloat($('#expenseAmount')?.value || '');
      const currency = $('#expenseCurrency')?.value;
      const details = $('#expenseDetails')?.value || '';

      if(!person || !currency || isNaN(amount) || amount<=0){
        notify('أدخل الحقول المطلوبة بشكل صحيح.',true); return;
      }
      if(type==='صادر' && ((balances[currency]||0) < amount)){
        notify('الرصيد غير كافٍ.',true); return;
      }

      if(type==='صادر'){ balances[currency]=(balances[currency]||0)-amount; }
      else{ balances[currency]=(balances[currency]||0)+amount; }

      transactions.unshift({
        id: transactionIdCounter++,
        type, person, amount, currency, details,
        date:new Date().toISOString()
      });

      saveData();
      notify(`تم تسجيل ${type}.`);
      if($('#expensePerson')) $('#expensePerson').value='';
      if($('#expenseAmount')) $('#expenseAmount').value='';
      if($('#expenseDetails')) $('#expenseDetails').value='';
      updateAllUI();
    }

    /* المعاملات */
    function updateTransactionsList(){
      const list = $('#transactionsList');
      const recent = $('#recentTransactions');
      if(list) list.innerHTML='';
      if(recent) recent.innerHTML='';

      const sorted = [...transactions].sort((a,b)=> new Date(b.date)-new Date(a.date));
      sorted.forEach((t,i)=>{
        const div=document.createElement('div');
        div.className='balance-item';
        let text='';
        if(t.type==='تحويل'){
          text = `تحويل: ${fmt(t.amount)} ${t.fromCurrency} → ${fmt(t.convertedAmount)} ${t.toCurrency} بسعر ${t.exchangeRate}${t.comment?` (${t.comment})`:''}`;
        }else{
          text = `${t.type}: ${fmt(t.amount)} ${t.currency} ${t.person?(' - '+t.person):''}${t.details?` (${t.details})`:''}`;
        }
        div.textContent = `${new Date(t.date).toLocaleString()} — ${text}`;
        if(list) list.appendChild(div);
        if(recent && i<5) recent.appendChild(div.cloneNode(true));
      });
    }

    function searchTransactions(){
      const term = ($('#transactionSearch')?.value || '').toLowerCase();
      const list = $('#transactionsList'); if(!list) return;
      list.innerHTML='';

      const filtered = transactions.filter(t=>{
        const s = JSON.stringify(t).toLowerCase() + ' ' + new Date(t.date).toLocaleString().toLowerCase();
        return s.includes(term);
      }).sort((a,b)=> new Date(b.date)-new Date(a.date));

      if(!filtered.length){
        list.innerHTML='<p style="text-align:center;margin:16px 0">لا توجد معاملات مطابقة.</p>';
        return;
      }

      filtered.forEach(t=>{
        const div=document.createElement('div');
        div.className='balance-item';
        let text='';
        if(t.type==='تحويل'){
          text = `تحويل: ${fmt(t.amount)} ${t.fromCurrency} → ${fmt(t.convertedAmount)} ${t.toCurrency} بسعر ${t.exchangeRate}${t.comment?` (${t.comment})`:''}`;
        }else{
          text = `${t.type}: ${fmt(t.amount)} ${t.currency} ${t.person?(' - '+t.person):''}${t.details?` (${t.details})`:''}`;
        }
        div.textContent = `${new Date(t.date).toLocaleString()} — ${text}`;
        list.appendChild(div);
      });
    }

    /* ديون العملاء (أساسيات) */
    function toggleAddClient(){
      const s=$('#addClientSection'); if(!s) return;
      s.style.display = (s.style.display==='none' || !s.style.display)?'block':'none';
    }
    function toggleRemoveClient(){
      const s=$('#removeClientSection'); if(!s) return;
      s.style.display = (s.style.display==='none' || !s.style.display)?'block':'none';
    }
    function addClientDebt(){
      const name = $('#newClientName')?.value.trim(); if(!name){ notify('أدخل اسم العميل.',true); return; }
      const phone = $('#newClientPhone')?.value.trim() || '';
      const note  = $('#newClientNote')?.value.trim() || '';
      const id = 'C' + Date.now();
      clients[id]={ id, name, phone, note, debts:[] };
      saveData(); notify('تم إضافة العميل.');
      if($('#newClientName')) $('#newClientName').value='';
      if($('#newClientPhone')) $('#newClientPhone').value='';
      if($('#newClientNote')) $('#newClientNote').value='';
      updateClientsListDisplay();
      updateRemoveClientDropdown();
    }
    function updateClientsListDisplay(){
      const box = $('#clientsListDisplay'); if(!box) return;
      box.innerHTML='';
      Object.values(clients).forEach(c=>{
        const row=document.createElement('div');
        row.className='balance-item';
        row.innerHTML=`<div><strong>${c.name}</strong>${c.phone?` — ${c.phone}`:''}${c.note?` — ${c.note}`:''}</div>
        <div style="display:flex;gap:8px">
          <button type="button" onclick="openClientDetails('${c.id}')">تفاصيل</button>
        </div>`;
        box.appendChild(row);
      });
      // مخلص إجمالي (بسيط)
      const overall = $('#overallDebtSummary');
      if(overall){
        overall.innerHTML = `<span>عدد العملاء</span><strong>${Object.keys(clients).length}</strong>`;
      }
    }
    function openClientDetails(id){
      currentDebtClient = clients[id] || null;
      if(!currentDebtClient){ notify('العميل غير موجود.',true); return; }
      $('#clientDetailsName').textContent = currentDebtClient.name;
      showPage('debtDetailsPage');
      updateClientDebtDetails();
    }
    function updateClientDebtDetails(){
      if(!currentDebtClient) return;
      const sumBox = $('#clientDebtSummary'); const list = $('#clientDebtDetails');
      if(sumBox) sumBox.innerHTML='';
      if(list) list.innerHTML='';
      const totals = {}; // حسب العملة
      (currentDebtClient.debts||[]).forEach(d=>{
        const key = d.currency || 'UNK';
        totals[key] = totals[key] || { لك:0, له:0 };
        if(d.type==='لك') totals[key].لك += Number(d.amount)||0;
        else totals[key].له += Number(d.amount)||0;
        const r=document.createElement('div');
        r.className='debt-record';
        r.textContent = `${new Date(d.date).toLocaleString()} — ${d.type}: ${fmt(d.amount)} ${d.currency} ${d.comment?`(${d.comment})`:''}`;
        if(list) list.appendChild(r);
      });
      const sum = Object.entries(totals).map(([cur,v])=>{
        const net = v.له - v.لك; // موجب: عليه لك / سالب: لك عليه
        return `<div class="balance-item"><span>${cur}</span><strong>${fmt(net)}</strong></div>`;
      }).join('') || '<div class="balance-item"><span>لا توجد سجلات</span><strong>0</strong></div>';
      if(sumBox) sumBox.innerHTML = sum;

      // تحديث قائمة العملات في صفحة العميل
      const sel = $('#clientDebtCurrency');
      if(sel){
        sel.innerHTML='';
        Object.keys(currencies).forEach(code=>{
          const opt=document.createElement('option');
          opt.value=code; opt.textContent=currencies[code]||code;
          sel.appendChild(opt);
        });
      }
    }
    function addOrUpdateClientDebt(){
      if(!currentDebtClient){ notify('اختر عميلاً أولاً.',true); return; }
      const type = $('#clientDebtType')?.value || 'له';
      const amount = parseFloat($('#clientDebtAmount')?.value||'');
      const currency = $('#clientDebtCurrency')?.value;
      const comment = $('#clientDebtComment')?.value||'';
      if(!currency || isNaN(amount)||amount<=0){ notify('بيانات غير صالحة.',true); return; }
      currentDebtClient.debts = currentDebtClient.debts || [];
      currentDebtClient.debts.unshift({
        type, amount, currency, comment, date:new Date().toISOString()
      });
      clients[currentDebtClient.id]=currentDebtClient;
      saveData(); notify('تم الحفظ.');
      if($('#clientDebtAmount')) $('#clientDebtAmount').value='';
      if($('#clientDebtComment')) $('#clientDebtComment').value='';
      updateClientDebtDetails();
    }
    function updateRemoveClientDropdown(){
      const sel=$('#removeClientDropdown'); if(!sel) return;
      sel.innerHTML='';
      Object.values(clients).forEach(c=>{
        const opt=document.createElement('option'); opt.value=c.id; opt.textContent=c.name;
        sel.appendChild(opt);
      });
    }
    function removeClientFromDropdown(){
      const sel=$('#removeClientDropdown'); if(!sel) return;
      const id = sel.value; if(!id) return;
      if(!confirm('هل تريد حذف هذا العميل؟')) return;
      delete clients[id];
      if(currentDebtClient && currentDebtClient.id===id){ currentDebtClient=null; }
      saveData(); notify('تم حذف العميل.');
      updateClientsListDisplay(); updateRemoveClientDropdown();
      if($('#debtDetailsPage').classList.contains('active-page')) goBack();
    }

    /* مسح البيانات */
    function resetAllData(){
      if(!confirm('سيتم مسح جميع البيانات. هل أنت متأكد؟')) return;
      balances={}; currencies={}; transactions=[]; clients={}; transactionIdCounter=1101;
      saveData(); notify('تم المسح.');
      updateAllUI();
    }

    /* عند التحميل الأولي */
    document.addEventListener('DOMContentLoaded', ()=>{
      // لا شيء إضافي هنا… بقية العمل يتم بعد auth
    });
  </script>
</body>
</html>