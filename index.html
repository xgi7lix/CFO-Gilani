<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>نظام الإدارة المالية المتقدم</title>

  <!-- خط -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <!-- أيقونات -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- html2canvas (للتصدير مستقبلاً إن احتجت) -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <!-- Chart.js للرسوم البيانية -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --primary:#2C786C;
      --secondary:#004445;
      --accent:#FFD166;
      --light:#f8f9fa;
      --dark:#333;
      --danger:#dc3545;
      --danger-hover:#c82333;
      --shadow:0 4px 6px rgba(0,0,0,.1);
      --t:all .25s ease;
      --success:#28a745;
      --success-hover:#218838;
    }

    /* الوضع المظلم */
    [data-theme="dark"] {
      --light:#1a1a1a;
      --dark:#f8f9fa;
      --shadow:0 4px 6px rgba(255,255,255,.1);
    }

    [data-theme="dark"] body {
      background:var(--light);
      color:var(--dark);
    }

    [data-theme="dark"] .main-card,
    [data-theme="dark"] .page,
    [data-theme="dark"] .auth-box,
    [data-theme="dark"] .balance-item,
    [data-theme="dark"] .debt-record,
    [data-theme="dark"] .modal-content {
      background:#2d2d2d;
      color:var(--dark);
      border-color:#444;
    }

    [data-theme="dark"] input,
    [data-theme="dark"] select,
    [data-theme="dark"] textarea {
      background:#2d2d2d;
      color:var(--dark);
      border-color:#444;
    }

    [data-theme="dark"] .debt-records-container {
      background:#2d2d2d;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Tajawal',sans-serif;
      background:var(--light);
      color:var(--dark);
      line-height:1.6;
      transition:var(--t);
    }

    /* رأس */
    header{
      background:var(--primary);
      color:#fff;
      box-shadow:var(--shadow);
    }
    #main-header{padding:16px 0;position:relative}
    #main-header h1{margin:0;font-size:1.4rem;text-align:center}
    #page-header{display:none;align-items:center;gap:12px;padding:10px 12px}
    #page-title{margin:0;font-size:1.1rem}

    /* أزرار التحكم في الرأس */
    .header-controls {
      position:absolute;
      top:50%;
      right:20px;
      transform:translateY(-50%);
      display:flex;
      gap:10px;
    }

    .header-btn {
      background:rgba(255,255,255,.2);
      border:none;
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
      transition:var(--t);
    }

    .header-btn:hover {
      background:rgba(255,255,255,.3);
    }

    /* حاوية */
    .container{max-width:1100px;margin:0 auto;padding:14px}

    /* شبكة البطاقات */
    .main-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    @media(min-width:768px){.main-grid{grid-template-columns:repeat(3,1fr)}}
    .main-card{
      background:#fff;border:2px solid var(--primary);border-radius:12px;
      padding:18px;text-align:center;cursor:pointer;transition:var(--t);
      min-height:120px;display:flex;flex-direction:column;justify-content:center;align-items:center
    }
    .main-card i{font-size:28px;color:var(--primary);margin-bottom:8px}
    .main-card:hover{transform:translateY(-4px);background:var(--primary);color:#fff}
    .main-card:hover i{color:#fff}

    /* الصفحات */
    .page{display:none;background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:14px;margin-top:14px}
    .active-page{display:block}
    .page-header{display:flex;align-items:center;gap:8px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #eee}
    .page-header i{color:var(--primary)}

    /* عناصر نموذج */
    .form-row{margin-bottom:12px}
    label{display:block;margin-bottom:6px;font-weight:700}
    input,select,textarea,button{
      width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-family:'Tajawal',sans-serif;font-size:14px;transition:var(--t)
    }
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(44,120,108,.15)}
    textarea{resize:vertical}
    button{cursor:pointer;background:var(--primary);color:#fff;border:none;font-weight:700;transition:var(--t)}
    button:hover{background:var(--secondary)}
    .btn-danger{background:var(--danger)}
    .btn-danger:hover{background:var(--danger-hover)}
    .btn-success{background:var(--success)}
    .btn-success:hover{background:var(--success-hover)}
    .btn-wide{display:block;width:100%;padding:14px;margin:10px 0;text-align:right}

    .balance-item{padding:10px;margin:6px 0;background:#f7f7f8;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
    .debt-records-container{padding:8px;background:#f7f7f8;border-radius:8px;max-height:300px;overflow:auto}
    .debt-record{padding:8px;margin:6px 0;background:#fff;border:1px solid #eee;border-radius:8px}

    /* توست محسن */
    .notification{
      position:fixed;top:20px;left:50%;transform:translateX(-50%);
      background:var(--success);color:#fff;padding:12px 20px;border-radius:8px;z-index:9999;
      box-shadow:var(--shadow);display:flex;align-items:center;gap:8px;
      animation:slideDown 0.3s ease-out;
    }
    .notification.error{background:var(--danger)}
    .notification.warning{background:#ffc107;color:#000}
    .notification.info{background:#17a2b8}

    @keyframes slideDown {
      from { transform:translateX(-50%) translateY(-100%); opacity:0; }
      to { transform:translateX(-50%) translateY(0); opacity:1; }
    }

    /* مصادقة */
    #auth-container{min-height:100vh;display:flex;justify-content:center;align-items:center;padding:16px}
    .auth-box{background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:22px;max-width:400px;width:100%}
    .auth-box h2{margin:0 0 14px;color:var(--primary)}
    .auth-switch{margin-top:12px;text-align:center}
    .auth-switch a{color:var(--primary);cursor:pointer;font-weight:700}
    .auth-switch a:hover{text-decoration:underline}
    .google-btn{background:#4285F4}
    .google-btn:hover{background:#357ae8}
    .or-sep{margin:14px 0;text-align:center;color:#999}

    /* لودر */
    .loader{
      display:none;border:4px solid #eee;border-top:4px solid var(--primary);
      border-radius:50%;width:28px;height:28px;margin:10px auto;animation:spin 1s linear infinite
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* زر رجوع */
    .back-button{background:rgba(255,255,255,.2);border:none;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}

    /* فلاتر البحث المختصرة */
    .compact-filters {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #e9ecef;
    }

    .filter-toggle-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      transition: var(--t);
    }

    .filter-toggle-btn:hover {
      background: #0056b3;
    }

    .filter-toggle-btn i:last-child {
      transition: transform 0.3s ease;
    }

    .filter-toggle-btn.active i:last-child {
      transform: rotate(180deg);
    }

    .quick-filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .compact-select, .compact-input, .compact-date, .compact-number {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      min-width: 100px;
      height: 32px;
    }

    .compact-select {
      min-width: 120px;
    }

    .compact-input {
      min-width: 150px;
      flex: 1;
    }

    .compact-date, .compact-number {
      min-width: 110px;
    }

    .clear-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      height: 32px;
      min-width: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .clear-btn:hover {
      background: #c82333;
    }

    .advanced-filters {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e9ecef;
    }

    .advanced-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
    }

    .advanced-group {
      display: flex;
      flex-direction: column;
    }

    .advanced-group label {
      font-size: 11px;
      margin-bottom: 4px;
      color: #666;
      font-weight: 500;
    }

    /* تحسينات الاستجابة للفلاتر المختصرة */
    @media (max-width: 768px) {
      .quick-filters {
        flex-direction: column;
        align-items: stretch;
      }

      .compact-select, .compact-input, .compact-date, .compact-number {
        min-width: auto;
        width: 100%;
      }

      .advanced-row {
        grid-template-columns: 1fr;
      }
    }

    /* الأنماط القديمة للفلاتر */
    .search-filters {
      background:#f8f9fa;
      border-radius:8px;
      padding:15px;
      margin-bottom:15px;
      border:1px solid #e9ecef;
    }

    .filter-row {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:10px;
      margin-bottom:10px;
    }

    .filter-group {
      display:flex;
      flex-direction:column;
    }

    .filter-group label {
      font-size:12px;
      margin-bottom:4px;
      color:#666;
    }

    /* إحصائيات */
    .stats-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:15px;
      margin-bottom:20px;
    }

    .stat-card {
      background:#fff;
      border-radius:8px;
      padding:15px;
      box-shadow:var(--shadow);
      text-align:center;
      border-left:4px solid var(--primary);
    }

    .stat-value {
      font-size:24px;
      font-weight:700;
      color:var(--primary);
      margin-bottom:5px;
    }

    .stat-label {
      font-size:14px;
      color:#666;
    }

    /* رسم بياني */
    .chart-container {
      background:#fff;
      border-radius:8px;
      padding:20px;
      box-shadow:var(--shadow);
      margin-bottom:20px;
    }

    .chart-title {
      font-size:18px;
      font-weight:700;
      margin-bottom:15px;
      color:var(--primary);
    }

    /* تبويبات */
    .tabs {
      border-bottom:2px solid #e9ecef;
      margin-bottom:20px;
    }

    .tab-buttons {
      display:flex;
      gap:0;
    }

    .tab-button {
      background:none;
      border:none;
      padding:12px 20px;
      cursor:pointer;
      border-bottom:3px solid transparent;
      transition:var(--t);
      font-weight:600;
    }

    .tab-button.active {
      color:var(--primary);
      border-bottom-color:var(--primary);
    }

    .tab-content {
      display:none;
    }

    .tab-content.active {
      display:block;
    }

    /* مؤشر النسخ الاحتياطي */
    .backup-indicator {
      position:fixed;
      bottom:20px;
      right:20px;
      background:var(--success);
      color:#fff;
      padding:8px 12px;
      border-radius:20px;
      font-size:12px;
      display:flex;
      align-items:center;
      gap:5px;
      z-index:1000;
      transition:var(--t);
    }

    .backup-indicator.syncing {
      background:#ffc107;
      color:#000;
    }

    .backup-indicator.error {
      background:var(--danger);
    }

    .backup-indicator i {
      animation:none;
    }

    .backup-indicator.syncing i {
      animation:spin 1s linear infinite;
    }

    /* تحسينات الاستجابة */
    @media (max-width: 768px) {
      .header-controls {
        position:static;
        transform:none;
        justify-content:center;
        margin-top:10px;
      }

      .filter-row {
        grid-template-columns:1fr;
      }

      .stats-grid {
        grid-template-columns:1fr;
      }

      .tab-buttons {
        flex-wrap:wrap;
      }

      .tab-button {
        flex:1;
        min-width:120px;
      }
    }

    /* أزرار إدارة الرصيد */
    .balance-controls {
      display:flex;
      gap:10px;
      margin-top:15px;
    }

    .balance-controls button {
      flex:1;
      padding:8px 12px;
      font-size:12px;
    }

    /* إصلاح النافذة المنبثقة */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      box-shadow: var(--shadow);
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .modal-buttons button {
      flex: 1;
    }

  </style>
</head>
<body data-theme="light">

  <!-- مؤشر النسخ الاحتياطي -->
  <div id="backup-indicator" class="backup-indicator" style="display:none">
    <i class="fas fa-cloud"></i>
    <span id="backup-text">تم الحفظ</span>
  </div>

  <!-- واجهة المصادقة -->
  <div id="auth-container">
    <div class="auth-box">
      <!-- تسجيل الدخول -->
      <div id="login-form">
        <h2>تسجيل الدخول</h2>
        <div class="form-row">
          <label for="login-email">البريد الإلكتروني</label>
          <input type="email" id="login-email" placeholder="email@example.com" required>
        </div>
        <div class="form-row">
          <label for="login-password">كلمة المرور</label>
          <input type="password" id="login-password" placeholder="********" required>
        </div>
        <div class="form-row" style="display: flex; align-items: center; gap: 8px; margin: 10px 0;">
          <input type="checkbox" id="remember-me" style="width: auto; margin: 0;">
          <label for="remember-me" style="margin: 0; font-weight: normal; cursor: pointer;">حفظ تسجيل الدخول</label>
        </div>
        <div class="form-row" style="text-align:left;margin:-6px 0 10px">
          <a href="#" onclick="handlePasswordReset(event)" class="auth-switch">نسيت كلمة المرور؟</a>
        </div>
        <button type="button" onclick="handleLogin()">تسجيل الدخول</button>
        <div class="loader" id="login-loader"></div>

        <div class="or-sep">أو</div>

        <button type="button" class="google-btn" onclick="signInWithGoogle()">
          <i class="fab fa-google"></i> المتابعة باستخدام Google
        </button>
        <div class="loader" id="google-loader"></div>

        <p class="auth-switch">ليس لديك حساب؟ <a href="#" onclick="toggleAuthForms()">إنشاء حساب جديد</a></p>
      </div>

      <!-- إنشاء حساب -->
      <div id="signup-form" style="display:none">
        <h2>إنشاء حساب جديد</h2>
        <div class="form-row">
          <label for="signup-firstname">الاسم الأول</label>
          <input id="signup-firstname" type="text" placeholder="مثال: أحمد" required>
        </div>
        <div class="form-row">
          <label for="signup-lastname">الاسم الأخير</label>
          <input id="signup-lastname" type="text" placeholder="مثال: محمد" required>
        </div>
        <div class="form-row">
          <label for="signup-email">البريد الإلكتروني</label>
          <input id="signup-email" type="email" placeholder="email@example.com" required>
        </div>
        <div class="form-row">
          <label for="signup-password">كلمة المرور</label>
          <input id="signup-password" type="password" placeholder="حرف كبير، صغير، رقم، رمز خاص" required>
          <div id="password-requirements" style="font-size:12px;color:#666;margin-top:4px;display:none">
            <div>• حرف كبير واحد على الأقل (A-Z)</div>
            <div>• حرف صغير واحد على الأقل (a-z)</div>
            <div>• رقم واحد على الأقل (0-9)</div>
            <div>• رمز خاص واحد على الأقل ($&#@!%*?&)</div>
            <div>• 8 أحرف على الأقل</div>
          </div>
        </div>
        <button type="button" onclick="handleSignup()">إنشاء حساب</button>
        <div class="loader" id="signup-loader"></div>

        <div class="or-sep">أو</div>

        <button type="button" class="google-btn" onclick="signInWithGoogle()">
          <i class="fab fa-google"></i> المتابعة باستخدام Google
        </button>
        <div class="loader" id="google-loader-signup"></div>

        <p class="auth-switch">لديك حساب بالفعل؟ <a href="#" onclick="toggleAuthForms()">تسجيل الدخول</a></p>
      </div>
    </div>
  </div>

  <!-- التطبيق -->
  <div id="app-container" style="display:none">
    <!-- رأس رئيسي -->
    <header>
      <div id="main-header">
        <h1><i class="fas fa-wallet"></i> نظام الإدارة المالية المتقدم</h1>
        <div class="header-controls">
          <button class="header-btn" onclick="toggleTheme()">
            <i class="fas fa-moon" id="theme-icon"></i>
          </button>
          <button class="header-btn" onclick="toggleLanguage()">EN</button>
          <button class="header-btn" onclick="handleLogout()">خروج</button>
        </div>
      </div>
      <div id="page-header">
        <button class="back-button" onclick="showMainMenu()">رجوع</button>
        <h2 id="page-title">الصفحة</h2>
      </div>
    </header>

    <div class="container">
      <!-- القائمة الرئيسية -->
      <div id="main-menu">
        <div class="main-grid">
          <div class="main-card" onclick="showPage('balance')">
            <i class="fas fa-wallet"></i>
            <div>كشف الحساب</div>
          </div>
          <div class="main-card" onclick="showPage('transfers')">
            <i class="fas fa-right-left"></i>
            <div>التحويلات</div>
          </div>
          <div class="main-card" onclick="showPage('income-expense')">
            <i class="fas fa-dollar-sign"></i>
            <div>الصادر والوارد</div>
          </div>
          <div class="main-card" onclick="showPage('debts')">
            <i class="fas fa-handshake"></i>
            <div>الديون</div>
          </div>
          <div class="main-card" onclick="showPage('transactions')">
            <i class="fas fa-list"></i>
            <div>كل المعاملات</div>
          </div>
          <div class="main-card" onclick="showPage('settings')">
            <i class="fas fa-cog"></i>
            <div>الإعدادات</div>
          </div>
        </div>
      </div>

      <!-- صفحة كشف الحساب -->
      <div id="balance" class="page">
        <div class="page-header"><i class="fas fa-wallet"></i><h2 id="balance-header">كشف الحساب</h2></div>
        <div id="balance-list"></div>
        <div class="balance-controls">
          <button class="btn-success" onclick="showBalanceModal('add')">إضافة رصيد</button>
          <button class="btn-danger" onclick="showBalanceModal('subtract')">خصم رصيد</button>
        </div>
      </div>

      <!-- صفحة التحويلات -->
      <div id="transfers" class="page">
        <div class="page-header"><i class="fas fa-right-left"></i><h2 id="transfers-header">التحويلات</h2></div>
        <div class="form-row">
          <label for="fromCurrency">من العملة</label>
          <select id="fromCurrency">
            <option value="SDG">جنيه سوداني (SDG)</option>
            <option value="USD">دولار أمريكي (USD)</option>
            <option value="EUR">يورو (EUR)</option>
          </select>
        </div>
        <div class="form-row">
          <label for="toCurrency">إلى العملة</label>
          <select id="toCurrency">
            <option value="SDG">جنيه سوداني (SDG)</option>
            <option value="USD">دولار أمريكي (USD)</option>
            <option value="EUR">يورو (EUR)</option>
          </select>
        </div>
        <div class="form-row">
          <label for="transferAmount">المبلغ</label>
          <input type="number" id="transferAmount" placeholder="0.00" step="0.01" min="0">
        </div>
        <div class="form-row">
          <label for="exchangeRate">سعر الصرف</label>
          <input type="number" id="exchangeRate" placeholder="1.00" step="0.01" min="0">
        </div>
        <div class="form-row">
          <label for="operationType">العملية</label>
          <select id="operationType">
            <option value="multiply">ضرب (×)</option>
            <option value="divide">قسمة (÷)</option>
          </select>
        </div>
        <button onclick="processTransfer()">تحويل</button>
      </div>

      <!-- صفحة الصادر والوارد -->
      <div id="income-expense" class="page">
        <div class="page-header"><i class="fas fa-dollar-sign"></i><h2 id="income-expense-header">الصادر والوارد</h2></div>
        <div class="form-row">
          <label for="transactionType">نوع المعاملة</label>
          <select id="transactionType">
            <option value="income">وارد</option>
            <option value="expense">صادر</option>
          </select>
        </div>
        <div class="form-row">
          <label for="transactionAmount">المبلغ</label>
          <input type="number" id="transactionAmount" placeholder="0.00" step="0.01" min="0">
        </div>
        <div class="form-row">
          <label for="transactionCurrency">العملة</label>
          <select id="transactionCurrency">
            <option value="SDG">جنيه سوداني (SDG)</option>
            <option value="USD">دولار أمريكي (USD)</option>
            <option value="EUR">يورو (EUR)</option>
          </select>
        </div>
        <div class="form-row">
          <label for="transactionDescription">الوصف</label>
          <input type="text" id="transactionDescription" placeholder="وصف المعاملة">
        </div>
        <button onclick="addTransaction()">إضافة معاملة</button>
      </div>

      <!-- صفحة الديون -->
      <div id="debts" class="page">
        <div class="page-header"><i class="fas fa-handshake"></i><h2 id="debts-header">الديون</h2></div>
        
        <div class="form-row">
          <label for="debtType">نوع الدين</label>
          <select id="debtType">
            <option value="owed_to_me">له</option>
            <option value="i_owe">عليه</option>
          </select>
        </div>
        
        <div class="form-row">
          <label for="debtPerson">اسم الشخص</label>
          <input type="text" id="debtPerson" placeholder="اسم المدين أو الدائن">
        </div>
        
        <div class="form-row">
          <label for="debtAmount">المبلغ</label>
          <input type="number" id="debtAmount" placeholder="0.00" step="0.01" min="0">
        </div>
        
        <div class="form-row">
          <label for="debtCurrency">العملة</label>
          <select id="debtCurrency">
            <option value="SDG">جنيه سوداني (SDG)</option>
            <option value="USD">دولار أمريكي (USD)</option>
            <option value="EUR">يورو (EUR)</option>
          </select>
        </div>
        
        <div class="form-row">
          <label for="debtDescription">الوصف</label>
          <input type="text" id="debtDescription" placeholder="وصف الدين">
        </div>
        
        <div class="form-row">
          <label for="debtDate">تاريخ الدين</label>
          <input type="date" id="debtDate">
        </div>
        
        <button onclick="addDebt()">إضافة دين</button>
        
        <div id="debts-list" class="debt-records-container" style="margin-top: 20px;">
          <!-- سيتم عرض الديون هنا -->
        </div>
      </div>

      <!-- صفحة كل المعاملات -->
      <div id="transactions" class="page">
        <div class="page-header"><i class="fas fa-list"></i><h2 id="transactions-header">كل المعاملات</h2></div>
        
        <!-- فلاتر البحث المختصرة -->
        <div class="compact-filters">
          <button class="filter-toggle-btn" onclick="toggleFilters()">
            <i class="fas fa-filter"></i>
            <span>فلترة</span>
            <i class="fas fa-chevron-down" id="filter-chevron"></i>
          </button>
          
          <div class="quick-filters">
            <select id="filter-type" onchange="applyFilters()" class="compact-select">
              <option value="">كل الأنواع</option>
              <option value="income">وارد</option>
              <option value="expense">صادر</option>
              <option value="transfer">تحويل</option>
            </select>
            
            <select id="filter-currency" onchange="applyFilters()" class="compact-select">
              <option value="">كل العملات</option>
              <option value="SDG">SDG</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
            </select>
            
            <input type="text" id="filter-description" placeholder="بحث..." oninput="applyFilters()" class="compact-input">
          </div>
          
          <div class="advanced-filters" id="advanced-filters" style="display: none;">
            <div class="advanced-row">
              <div class="advanced-group">
                <label>من تاريخ</label>
                <input type="date" id="filter-date-from" onchange="applyFilters()" class="compact-date">
              </div>
              <div class="advanced-group">
                <label>إلى تاريخ</label>
                <input type="date" id="filter-date-to" onchange="applyFilters()" class="compact-date">
              </div>
              <div class="advanced-group">
                <label>المبلغ من</label>
                <input type="number" id="filter-amount-min" placeholder="0" step="0.01" onchange="applyFilters()" class="compact-number">
              </div>
              <div class="advanced-group">
                <label>المبلغ إلى</label>
                <input type="number" id="filter-amount-max" placeholder="∞" step="0.01" onchange="applyFilters()" class="compact-number">
              </div>
            </div>
          </div>
        </div>

        <div id="transactions-list"></div>
      </div>

      <!-- صفحة الإحصائيات -->
      <div id="statistics" class="page">
        <div class="page-header"><i class="fas fa-chart-bar"></i><h2 id="statistics-header">الإحصائيات</h2></div>
        
        <!-- بطاقات الإحصائيات -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="total-income">0</div>
            <div class="stat-label">إجمالي الوارد</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="total-expense">0</div>
            <div class="stat-label">إجمالي الصادر</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="net-balance">0</div>
            <div class="stat-label">الرصيد الصافي</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="transaction-count">0</div>
            <div class="stat-label">عدد المعاملات</div>
          </div>
        </div>

        <!-- الرسم البياني -->
        <div class="chart-container">
          <div class="chart-title">الوارد والصادر الشهري</div>
          <canvas id="monthly-chart" width="400" height="200"></canvas>
        </div>

        <!-- رسم بياني للعملات -->
        <div class="chart-container">
          <div class="chart-title">توزيع الأرصدة حسب العملة</div>
          <canvas id="currency-chart" width="400" height="200"></canvas>
        </div>
      </div>

      <!-- صفحة الإعدادات -->
      <div id="settings" class="page">
        <div class="page-header"><i class="fas fa-cog"></i><h2 id="settings-header">الإعدادات</h2></div>
        
        <!-- أزرار الإعدادات المتتالية -->
        <div style="display: flex; flex-direction: column; gap: 15px;">
          
          <!-- 1. اللغة -->
          <button class="btn-wide" onclick="toggleLanguage()" style="background: var(--primary); display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-language"></i>
              <span>اللغة</span>
            </div>
            <span style="font-size: 12px; opacity: 0.8;">العربية / English</span>
          </button>

          <!-- 2. الوضع الداكن -->
          <button class="btn-wide" onclick="toggleTheme()" style="background: var(--secondary); display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-moon" id="settings-theme-icon"></i>
              <span>الوضع الداكن</span>
            </div>
            <span style="font-size: 12px; opacity: 0.8;" id="theme-status">فاتح</span>
          </button>

          <!-- 3. الإحصائيات -->
          <button class="btn-wide" onclick="showPage('statistics')" style="background: var(--accent); color: var(--dark); display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-chart-bar"></i>
            <span>الإحصائيات</span>
          </button>

          <!-- 4. معلومات الحساب -->
          <button class="btn-wide" onclick="showAccountInfo()" style="background: #17a2b8; display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-user"></i>
            <span>معلومات الحساب</span>
          </button>

          <!-- 5. تسجيل الخروج -->
          <button class="btn-wide btn-danger" onclick="handleLogout()" style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-sign-out-alt"></i>
            <span>تسجيل الخروج</span>
          </button>

        </div>
      </div>

      <!-- صفحة معلومات الحساب -->
      <div id="account-info" class="page">
        <div class="page-header"><i class="fas fa-user"></i><h2>معلومات الحساب</h2></div>
        
        <div class="form-row">
          <label>تعديل الاسم</label>
          <input type="text" id="user-name" placeholder="الاسم الجديد">
        </div>
        <div class="form-row">
          <label>البريد الإلكتروني</label>
          <input type="email" id="user-email" readonly placeholder="غير قابل للتعديل" style="background: #f8f9fa; cursor: not-allowed;">
        </div>
        <div class="form-row">
          <label>تغيير كلمة المرور</label>
          <input type="password" id="new-password" placeholder="كلمة المرور الجديدة">
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button onclick="updateProfile()" class="btn-success" style="flex: 1;">حفظ التغييرات</button>
          <button onclick="exportData()" class="btn-success" style="flex: 1;">تصدير البيانات</button>
        </div>
      </div>

      </div>
    </div>
  </div>

  <!-- نافذة إدارة الرصيد المحسنة -->
  <div id="balance-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 id="balance-modal-title">إدارة الرصيد</h3>
      <div class="form-row">
        <label for="balance-currency">العملة</label>
        <select id="balance-currency"></select>
      </div>
      <div class="form-row">
        <label for="balance-amount">المبلغ</label>
        <input type="number" id="balance-amount" placeholder="0.00" step="0.01" min="0">
      </div>
      <div class="form-row">
        <label for="balance-description">الوصف (اختياري)</label>
        <input type="text" id="balance-description" placeholder="وصف العملية">
      </div>
      <div class="modal-buttons">
        <button id="balance-confirm-btn" onclick="processBalanceChange()">تأكيد</button>
        <button onclick="closeBalanceModal()" style="background:#6c757d">إلغاء</button>
      </div>
    </div>
  </div>

  <script>
    // إعدادات Firebase - يجب تحديثها بالقيم الصحيحة
    const firebaseConfig = {
      apiKey: "AIzaSyD7eKVMk4-lZ48_3n88fsextFrziqiK-Mw",
      authDomain: "gilani-financial.firebaseapp.com",
      projectId: "gilani-financial",
      storageBucket: "gilani-financial.firebasestorage.app",
      messagingSenderId: "685744108797",
      appId: "1:685744108797:web:2feddfaf3f04d6028b7a94"
    };

    // تهيئة Firebase
    let app, auth, db;
    let firebaseInitialized = false;
    
    try {
      app = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
      firebaseInitialized = true;
      console.log('Firebase initialized successfully');
    } catch (error) {
      console.error('Firebase initialization failed:', error);
      firebaseInitialized = false;
    }

    // متغيرات عامة
    let currentUser = null;
    let currentLanguage = 'ar';
    let currencies = ['SDG', 'USD', 'EUR'];
    let defaultCurrency = 'SDG'; // العملة الأساسية: الجنيه السوداني
    let balances = { SDG: 0, USD: 0, EUR: 0 };
    let transactions = [];
    let filteredTransactions = [];
    let currentBalanceAction = '';

    // وظائف المساعدة
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}"></i>
        <span>${message}</span>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    function formatCurrency(amount, currency) {
      // تحديد عدد الأرقام العشرية بناءً على القيمة
      const hasDecimals = amount % 1 !== 0;
      const minimumFractionDigits = hasDecimals ? 2 : 0;
      const maximumFractionDigits = 2;
      
      return new Intl.NumberFormat('ar-SA', {
        style: 'currency',
        currency: currency,
        minimumFractionDigits: minimumFractionDigits,
        maximumFractionDigits: maximumFractionDigits
      }).format(amount);
    }

    function getCurrencyName(currency) {
      const names = {
        'SDG': 'جنيه سوداني (SDG)',
        'USD': 'دولار أمريكي (USD)',
        'EUR': 'يورو (EUR)',
        'GBP': 'جنيه إسترليني (GBP)',
        'JPY': 'ين ياباني (JPY)',
        'SAR': 'ريال سعودي (SAR)',
        'AED': 'درهم إماراتي (AED)'
      };
      return names[currency] || currency;
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function updateBackupIndicator(status, text) {
      const indicator = document.getElementById('backup-indicator');
      const textElement = document.getElementById('backup-text');
      
      if (indicator && textElement) {
        indicator.className = `backup-indicator ${status}`;
        textElement.textContent = text;
        indicator.style.display = 'flex';
        
        if (status === 'syncing') {
          setTimeout(() => {
            indicator.className = 'backup-indicator';
            textElement.textContent = 'تم الحفظ';
          }, 2000);
        }
      }
    }

    // إضافة دالة تهيئة بيانات المستخدم المفقودة
    function initializeUserData() {
      // تهيئة البيانات الافتراضية للمستخدم الجديد
      currencies = ['SDG', 'USD', 'EUR'];
      balances = { SDG: 0, USD: 0, EUR: 0 };
      transactions = [];
      defaultCurrency = 'SDG';
      
      // حفظ البيانات الأولية
      saveUserData();
    }

    // وظائف Firebase
    function saveUserData() {
      if (currentUser && db && firebaseInitialized) {
        updateBackupIndicator('syncing', 'جاري الحفظ...');
        
        const userData = {
          currencies,
          balances,
          transactions,
          preferences: {
            language: currentLanguage,
            theme: document.body.getAttribute('data-theme'),
            defaultCurrency
          },
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        };

        db.collection('users').doc(currentUser.uid).set(userData, { merge: true })
          .then(() => {
            updateBackupIndicator('', 'تم الحفظ');
          })
          .catch(error => {
            console.error('Error saving data:', error);
            updateBackupIndicator('error', 'خطأ في الحفظ');
          });
      }
    }

    function loadUserData() {
      if (currentUser && db && firebaseInitialized) {
        updateBackupIndicator('syncing', 'جاري التحميل...');
        
        db.collection('users').doc(currentUser.uid).get()
          .then(doc => {
            if (doc.exists) {
              const data = doc.data();
              
              if (data.currencies) currencies = data.currencies;
              if (data.balances) balances = data.balances;
              if (data.transactions) transactions = data.transactions;
              if (data.preferences) {
                if (data.preferences.language) currentLanguage = data.preferences.language;
                if (data.preferences.theme) document.body.setAttribute('data-theme', data.preferences.theme);
                if (data.preferences.defaultCurrency) defaultCurrency = data.preferences.defaultCurrency;
              }
              
              updateBackupIndicator('', 'تم التحميل');
            } else {
              // مستخدم جديد - تهيئة البيانات الافتراضية
              initializeUserData();
            }
            
            updateUI();
          })
          .catch(error => {
            console.error('Error loading data:', error);
            updateBackupIndicator('error', 'خطأ في التحميل');
            // في حالة الخطأ، استخدم البيانات الافتراضية
            initializeUserData();
            updateUI();
          });
      } else {
        // إذا لم يكن Firebase متاحاً، استخدم البيانات المحلية
        updateUI();
      }
    }

    // وظائف المصادقة
    function validatePassword(password) {
      const minLength = 8;
      const hasUpperCase = /[A-Z]/.test(password);
      const hasLowerCase = /[a-z]/.test(password);
      const hasNumbers = /\d/.test(password);
      const hasSpecialChar = /[$&#@!%*?&]/.test(password);
      
      return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers && hasSpecialChar;
    }

    function handleLogin() {
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const rememberMe = document.getElementById('remember-me').checked;
      
      // التحقق من الحقول الفارغة
      if (!email || !password) {
        showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
        return;
      }

      // التحقق من صحة البريد الإلكتروني
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showNotification('يرجى إدخال بريد إلكتروني صحيح (مثال: user@example.com)', 'error');
        return;
      }

      if (!firebaseInitialized) {
        showNotification('خدمة المصادقة غير متاحة حالياً. يرجى المحاولة لاحقاً.', 'error');
        return;
      }

      const loginLoader = document.getElementById('login-loader');
      if (loginLoader) loginLoader.style.display = 'block';

      // تعيين نوع الاستمرارية بناءً على خيار "حفظ تسجيل الدخول"
      const persistence = rememberMe ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION;
      
      auth.setPersistence(persistence)
        .then(() => {
          return auth.signInWithEmailAndPassword(email, password);
        })
        .then(userCredential => {
          // التحقق من صحة المستخدم
          if (!userCredential || !userCredential.user) {
            throw new Error('فشل في تسجيل الدخول - بيانات المستخدم غير صحيحة');
          }
          
          currentUser = userCredential.user;
          console.log('Login successful for:', currentUser.email);
          
          const welcomeMessage = rememberMe ? 
            'مرحباً بك! تم تسجيل الدخول بنجاح وسيتم حفظ جلستك' : 
            'مرحباً بك! تم تسجيل الدخول بنجاح';
          showNotification(welcomeMessage, 'success');
          
          // تنظيف الحقول
          document.getElementById('login-email').value = '';
          document.getElementById('login-password').value = '';
          document.getElementById('remember-me').checked = false;
          
          loadUserData();
          showApp();
        })
        .catch(error => {
          console.error('Login error:', error);
          let errorMessage = 'حدث خطأ أثناء تسجيل الدخول';
          
          switch(error.code) {
            case 'auth/user-not-found':
              errorMessage = 'لا يوجد حساب مسجل بهذا البريد الإلكتروني. يرجى التحقق من البريد أو إنشاء حساب جديد.';
              break;
            case 'auth/wrong-password':
              errorMessage = 'كلمة المرور غير صحيحة. يرجى المحاولة مرة أخرى أو استخدام "نسيت كلمة المرور".';
              break;
            case 'auth/invalid-email':
              errorMessage = 'تنسيق البريد الإلكتروني غير صحيح. يرجى التحقق من البريد المدخل.';
              break;
            case 'auth/user-disabled':
              errorMessage = 'تم تعطيل هذا الحساب من قبل المدير. يرجى التواصل مع الدعم الفني.';
              break;
            case 'auth/too-many-requests':
              errorMessage = 'تم تجاوز عدد المحاولات المسموح. يرجى الانتظار قليلاً ثم المحاولة مرة أخرى.';
              break;
            case 'auth/network-request-failed':
              errorMessage = 'مشكلة في الاتصال بالإنترنت. يرجى التحقق من الاتصال والمحاولة مرة أخرى.';
              break;
            case 'auth/invalid-credential':
              errorMessage = 'بيانات الدخول غير صحيحة. يرجى التحقق من البريد الإلكتروني وكلمة المرور.';
              break;
            default:
              errorMessage = `خطأ غير متوقع: ${error.message || 'يرجى المحاولة لاحقاً'}`;
          }
          
          showNotification(errorMessage, 'error');
          
          // التأكد من عدم فتح التطبيق في حالة الخطأ
          currentUser = null;
          showAuth();
        })
        .finally(() => {
          const loginLoader = document.getElementById('login-loader');
          if (loginLoader) loginLoader.style.display = 'none';
        });
    }

    function handleSignup() {
      const firstName = document.getElementById('signup-firstname').value.trim();
      const lastName = document.getElementById('signup-lastname').value.trim();
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;
      
      // التحقق من الحقول الفارغة
      if (!firstName || !lastName || !email || !password) {
        showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
        return;
      }

      // التحقق من طول الأسماء
      if (firstName.length < 2 || lastName.length < 2) {
        showNotification('يجب أن يكون الاسم الأول والأخير مكونين من حرفين على الأقل', 'error');
        return;
      }

      // التحقق من صحة البريد الإلكتروني
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showNotification('يرجى إدخال بريد إلكتروني صحيح (مثال: user@example.com)', 'error');
        return;
      }

      // التحقق من قوة كلمة المرور
      if (!validatePassword(password)) {
        showNotification('كلمة المرور يجب أن تحتوي على: حرف كبير، حرف صغير، رقم، رمز خاص، وأن تكون 8 أحرف على الأقل', 'error');
        return;
      }

      if (!firebaseInitialized) {
        showNotification('خدمة المصادقة غير متاحة حالياً. يرجى المحاولة لاحقاً.', 'error');
        return;
      }

      const signupLoader = document.getElementById('signup-loader');
      if (signupLoader) signupLoader.style.display = 'block';

      auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          currentUser = userCredential.user;
          
          // تحديث الملف الشخصي
          return currentUser.updateProfile({
            displayName: `${firstName} ${lastName}`
          });
        })
        .then(() => {
          showNotification(`مرحباً ${firstName}! تم إنشاء حسابك بنجاح`, 'success');
          initializeUserData();
          showApp();
        })
        .catch(error => {
          console.error('Signup error:', error);
          let errorMessage = 'حدث خطأ أثناء إنشاء الحساب';
          
          switch(error.code) {
            case 'auth/email-already-in-use':
              errorMessage = 'هذا البريد الإلكتروني مستخدم بالفعل. يرجى استخدام بريد آخر أو تسجيل الدخول.';
              break;
            case 'auth/invalid-email':
              errorMessage = 'تنسيق البريد الإلكتروني غير صحيح. يرجى التحقق من البريد المدخل.';
              break;
            case 'auth/weak-password':
              errorMessage = 'كلمة المرور ضعيفة جداً. يرجى استخدام كلمة مرور أقوى تحتوي على أحرف وأرقام ورموز.';
              break;
            case 'auth/operation-not-allowed':
              errorMessage = 'إنشاء الحسابات غير مفعل حالياً. يرجى التواصل مع الدعم الفني.';
              break;
            case 'auth/network-request-failed':
              errorMessage = 'مشكلة في الاتصال بالإنترنت. يرجى التحقق من الاتصال والمحاولة مرة أخرى.';
              break;
            case 'auth/too-many-requests':
              errorMessage = 'تم تجاوز عدد المحاولات المسموح. يرجى الانتظار قليلاً ثم المحاولة مرة أخرى.';
              break;
            default:
              errorMessage = `خطأ غير متوقع: ${error.message || 'يرجى المحاولة لاحقاً'}`;
          }
          
          showNotification(errorMessage, 'error');
        })
        .finally(() => {
          const signupLoader = document.getElementById('signup-loader');
          if (signupLoader) signupLoader.style.display = 'none';
        });
    }

    function signInWithGoogle() {
      if (!firebaseInitialized) {
        showNotification('خدمة المصادقة غير متاحة حالياً. يرجى المحاولة لاحقاً.', 'error');
        return;
      }

      const provider = new firebase.auth.GoogleAuthProvider();
      provider.addScope('profile');
      provider.addScope('email');
      
      auth.signInWithPopup(provider)
        .then(result => {
          currentUser = result.user;
          const userName = result.user.displayName || 'المستخدم';
          showNotification(`مرحباً ${userName}! تم تسجيل الدخول بنجاح`, 'success');
          loadUserData();
          showApp();
        })
        .catch(error => {
          console.error('Google sign-in error:', error);
          let errorMessage = 'حدث خطأ أثناء تسجيل الدخول بـ Google';
          
          switch(error.code) {
            case 'auth/popup-closed-by-user':
              errorMessage = 'تم إغلاق نافذة تسجيل الدخول. يرجى المحاولة مرة أخرى.';
              break;
            case 'auth/popup-blocked':
              errorMessage = 'تم حظر النافذة المنبثقة. يرجى السماح للنوافذ المنبثقة والمحاولة مرة أخرى.';
              break;
            case 'auth/cancelled-popup-request':
              errorMessage = 'تم إلغاء طلب تسجيل الدخول. يرجى المحاولة مرة أخرى.';
              break;
            case 'auth/network-request-failed':
              errorMessage = 'مشكلة في الاتصال بالإنترنت. يرجى التحقق من الاتصال والمحاولة مرة أخرى.';
              break;
            case 'auth/too-many-requests':
              errorMessage = 'تم تجاوز عدد المحاولات المسموح. يرجى الانتظار قليلاً ثم المحاولة مرة أخرى.';
              break;
            case 'auth/user-disabled':
              errorMessage = 'تم تعطيل هذا الحساب من قبل المدير. يرجى التواصل مع الدعم الفني.';
              break;
            default:
              errorMessage = `خطأ في تسجيل الدخول: ${error.message || 'يرجى المحاولة لاحقاً'}`;
          }
          
          showNotification(errorMessage, 'error');
        });
    }

    function handlePasswordReset(event) {
      event.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      
      if (!email) {
        showNotification('يرجى إدخال البريد الإلكتروني أولاً في حقل تسجيل الدخول', 'error');
        return;
      }

      // التحقق من صحة البريد الإلكتروني
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showNotification('يرجى إدخال بريد إلكتروني صحيح', 'error');
        return;
      }

      if (!firebaseInitialized) {
        showNotification('خدمة المصادقة غير متاحة حالياً. يرجى المحاولة لاحقاً.', 'error');
        return;
      }

      auth.sendPasswordResetEmail(email)
        .then(() => {
          showNotification(`تم إرسال رابط إعادة تعيين كلمة المرور إلى ${email}. يرجى فحص بريدك الإلكتروني.`, 'success');
        })
        .catch(error => {
          console.error('Password reset error:', error);
          let errorMessage = 'حدث خطأ أثناء إرسال رابط إعادة تعيين كلمة المرور';
          
          switch(error.code) {
            case 'auth/user-not-found':
              errorMessage = 'لا يوجد حساب مسجل بهذا البريد الإلكتروني. يرجى التحقق من البريد أو إنشاء حساب جديد.';
              break;
            case 'auth/invalid-email':
              errorMessage = 'تنسيق البريد الإلكتروني غير صحيح. يرجى التحقق من البريد المدخل.';
              break;
            case 'auth/too-many-requests':
              errorMessage = 'تم إرسال عدد كبير من الطلبات. يرجى الانتظار قليلاً ثم المحاولة مرة أخرى.';
              break;
            case 'auth/network-request-failed':
              errorMessage = 'مشكلة في الاتصال بالإنترنت. يرجى التحقق من الاتصال والمحاولة مرة أخرى.';
              break;
            default:
              errorMessage = `خطأ غير متوقع: ${error.message || 'يرجى المحاولة لاحقاً'}`;
          }
          
          showNotification(errorMessage, 'error');
        });
    }

    function handleLogout() {
      if (!firebaseInitialized) {
        showNotification('خدمة المصادقة غير متاحة حالياً.', 'error');
        return;
      }

      if (!currentUser) {
        showNotification('لا يوجد مستخدم مسجل دخول حالياً', 'info');
        return;
      }

      auth.signOut()
        .then(() => {
          const userName = currentUser.displayName || 'المستخدم';
          currentUser = null;
          showAuth();
          showNotification(`وداعاً ${userName}! تم تسجيل الخروج بنجاح`, 'success');
        })
        .catch(error => {
          console.error('Logout error:', error);
          let errorMessage = 'حدث خطأ أثناء تسجيل الخروج';
          
          switch(error.code) {
            case 'auth/network-request-failed':
              errorMessage = 'مشكلة في الاتصال بالإنترنت. تم تسجيل الخروج محلياً.';
              break;
            default:
              errorMessage = `خطأ في تسجيل الخروج: ${error.message || 'تم تسجيل الخروج محلياً'}`;
          }
          
          // حتى لو فشل تسجيل الخروج من الخادم، نقوم بتسجيل الخروج محلياً
          currentUser = null;
          showAuth();
          showNotification(errorMessage, 'warning');
        });
    }

    function toggleAuthForms() {
      const loginForm = document.getElementById("login-form");
      const signupForm = document.getElementById("signup-form");
      
      if (loginForm.style.display === "none") {
        loginForm.style.display = "block";
        signupForm.style.display = "none";
      } else {
        loginForm.style.display = "none";
        signupForm.style.display = "block";
      }
    }

    // وظائف التنقل
    function showPage(pageId) {
      // إخفاء القائمة الرئيسية
      document.getElementById('main-menu').style.display = 'none';
      document.getElementById('main-header').style.display = 'none';
      document.getElementById('page-header').style.display = 'flex';
      
      // إخفاء جميع الصفحات
      const pages = document.querySelectorAll('.page');
      pages.forEach(page => page.classList.remove('active-page'));
      
      // عرض الصفحة المطلوبة
      const targetPage = document.getElementById(pageId);
      if (targetPage) {
        targetPage.classList.add('active-page');
        
        // تحديث عنوان الصفحة
        const pageTitle = targetPage.querySelector('h2').textContent;
        document.getElementById('page-title').textContent = pageTitle;
        
        // تحديث محتوى الصفحة حسب النوع
        switch(pageId) {
          case 'balance':
            updateBalanceDisplay();
            break;
          case 'transactions':
            updateTransactionsDisplay();
            break;
          case 'statistics':
            updateStatistics();
            break;
          case 'settings':
            updateSettingsDisplay();
            break;
        }
      }
    }

    function showMainMenu() {
      document.getElementById('main-menu').style.display = 'block';
      document.getElementById('main-header').style.display = 'block';
      document.getElementById('page-header').style.display = 'none';
      
      // إخفاء جميع الصفحات
      const pages = document.querySelectorAll('.page');
      pages.forEach(page => page.classList.remove('active-page'));
    }

    function showApp() {
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('app-container').style.display = 'block';
      document.getElementById('backup-indicator').style.display = 'flex';
      updateUI();
    }

    function showAuth() {
      document.getElementById('auth-container').style.display = 'flex';
      document.getElementById('app-container').style.display = 'none';
      document.getElementById('backup-indicator').style.display = 'none';
    }

    // وظائف واجهة المستخدم
    function updateUI() {
      updateCurrencySelects();
      updateBalanceDisplay();
      updateTransactionsDisplay();
      updateSettingsDisplay();
    }

    function updateCurrencySelects() {
      const selects = [
        'fromCurrency', 'toCurrency', 'transactionCurrency', 
        'filter-currency', 'default-currency-select', 'balance-currency'
      ];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
          select.innerHTML = '';
          if (selectId === 'filter-currency') {
            select.innerHTML = '<option value="">الكل</option>';
          }
          
          currencies.forEach(currency => {
            const option = document.createElement('option');
            option.value = currency;
            option.textContent = getCurrencyName(currency);
            if (currency === defaultCurrency) {
              option.selected = true;
            }
            select.appendChild(option);
          });
        }
      });
    }

    function updateBalanceDisplay() {
      const balanceList = document.getElementById('balance-list');
      if (!balanceList) return;
      
      balanceList.innerHTML = '';
      
      currencies.forEach(currency => {
        const balance = balances[currency] || 0;
        const balanceItem = document.createElement('div');
        balanceItem.className = 'balance-item';
        balanceItem.innerHTML = `
          <div>
            <strong>${getCurrencyName(currency)}</strong>
            ${currency === defaultCurrency ? '<span style="color:var(--primary);font-size:12px"> (افتراضية)</span>' : ''}
          </div>
          <div style="font-weight:700;color:${balance >= 0 ? 'var(--success)' : 'var(--danger)'}">
            ${formatCurrency(balance, currency)}
          </div>
        `;
        balanceList.appendChild(balanceItem);
      });
    }

    function updateTransactionsDisplay() {
      applyFilters();
    }

    function updateSettingsDisplay() {
      // تحديث معلومات المستخدم
      if (currentUser) {
        const emailInput = document.getElementById('user-email');
        const nameInput = document.getElementById('user-name');
        if (emailInput) emailInput.value = currentUser.email || '';
        if (nameInput) nameInput.value = currentUser.displayName || '';
      }
      
      // تحديث قائمة العملات
      updateCurrenciesList();
      
      // تحديث الإعدادات
      const languageSelect = document.getElementById('language-select');
      const themeSelect = document.getElementById('theme-select');
      const defaultCurrencySelect = document.getElementById('default-currency-select');
      
      if (languageSelect) languageSelect.value = currentLanguage;
      if (themeSelect) themeSelect.value = document.body.getAttribute('data-theme');
      if (defaultCurrencySelect) defaultCurrencySelect.value = defaultCurrency;
    }

    function updateCurrenciesList() {
      const currenciesList = document.getElementById('currencies-list');
      if (!currenciesList) return;
      
      currenciesList.innerHTML = '';
      
      currencies.forEach(currency => {
        const currencyItem = document.createElement('div');
        currencyItem.className = 'balance-item';
        currencyItem.innerHTML = `
          <div>
            <strong>${getCurrencyName(currency)}</strong>
            ${currency === defaultCurrency ? '<span style="color:var(--primary);font-size:12px"> (افتراضية)</span>' : ''}
          </div>
          <button class="btn-danger" onclick="removeCurrency('${currency}')" 
                  ${currency === defaultCurrency ? 'disabled' : ''}>حذف</button>
        `;
        currenciesList.appendChild(currencyItem);
      });
    }

    // وظائف إدارة الرصيد المحسنة
    function showBalanceModal(action) {
      currentBalanceAction = action;
      const modal = document.getElementById('balance-modal');
      const title = document.getElementById('balance-modal-title');
      const confirmBtn = document.getElementById('balance-confirm-btn');
      
      if (!modal || !title || !confirmBtn) return;
      
      title.textContent = action === 'add' ? 'إضافة رصيد' : 'خصم رصيد';
      confirmBtn.textContent = action === 'add' ? 'إضافة' : 'خصم';
      confirmBtn.className = action === 'add' ? 'btn-success' : 'btn-danger';
      
      // تحديث قائمة العملات
      const currencySelect = document.getElementById('balance-currency');
      if (currencySelect) {
        currencySelect.innerHTML = '';
        currencies.forEach(currency => {
          const option = document.createElement('option');
          option.value = currency;
          option.textContent = getCurrencyName(currency);
          currencySelect.appendChild(option);
        });
      }
      
      // مسح الحقول
      const amountInput = document.getElementById('balance-amount');
      const descriptionInput = document.getElementById('balance-description');
      if (amountInput) amountInput.value = '';
      if (descriptionInput) descriptionInput.value = '';
      
      // عرض النافذة
      modal.classList.add('show');
    }

    function closeBalanceModal() {
      const modal = document.getElementById('balance-modal');
      if (modal) {
        modal.classList.remove('show');
      }
    }

    function processBalanceChange() {
      const currencySelect = document.getElementById('balance-currency');
      const amountInput = document.getElementById('balance-amount');
      const descriptionInput = document.getElementById('balance-description');
      
      if (!currencySelect || !amountInput) return;
      
      const currency = currencySelect.value;
      const amount = parseFloat(amountInput.value);
      const description = descriptionInput ? descriptionInput.value || 
                         (currentBalanceAction === 'add' ? 'إضافة رصيد' : 'خصم رصيد') : 
                         (currentBalanceAction === 'add' ? 'إضافة رصيد' : 'خصم رصيد');
      
      if (!amount || amount <= 0) {
        showNotification('يرجى إدخال مبلغ صحيح', 'error');
        return;
      }
      
      if (currentBalanceAction === 'subtract' && (balances[currency] || 0) < amount) {
        showNotification('الرصيد غير كافي', 'error');
        return;
      }
      
      // تحديث الرصيد
      if (!balances[currency]) balances[currency] = 0;
      
      if (currentBalanceAction === 'add') {
        balances[currency] += amount;
      } else {
        balances[currency] -= amount;
      }
      
      // إضافة معاملة
      const transaction = {
        id: generateId(),
        type: currentBalanceAction === 'add' ? 'income' : 'expense',
        amount: amount,
        currency: currency,
        description: description,
        timestamp: new Date()
      };
      
      transactions.push(transaction);
      
      // حفظ البيانات
      saveUserData();
      updateBalanceDisplay();
      closeBalanceModal();
      
      showNotification(`تم ${currentBalanceAction === 'add' ? 'إضافة' : 'خصم'} ${formatCurrency(amount, currency)} بنجاح`);
    }

    // وظائف المعاملات
    function addTransaction() {
      const typeSelect = document.getElementById('transactionType');
      const amountInput = document.getElementById('transactionAmount');
      const currencySelect = document.getElementById('transactionCurrency');
      const descriptionInput = document.getElementById('transactionDescription');
      
      if (!typeSelect || !amountInput || !currencySelect || !descriptionInput) return;
      
      const type = typeSelect.value;
      const amount = parseFloat(amountInput.value);
      const currency = currencySelect.value;
      const description = descriptionInput.value;
      
      if (!amount || amount <= 0) {
        showNotification('يرجى إدخال مبلغ صحيح', 'error');
        return;
      }
      
      if (!description.trim()) {
        showNotification('يرجى إدخال وصف للمعاملة', 'error');
        return;
      }
      
      // التحقق من كفاية الرصيد للمصروفات
      if (type === 'expense' && (balances[currency] || 0) < amount) {
        showNotification('الرصيد غير كافي', 'error');
        return;
      }
      
      // تحديث الرصيد
      if (!balances[currency]) balances[currency] = 0;
      
      if (type === 'income') {
        balances[currency] += amount;
      } else {
        balances[currency] -= amount;
      }
      
      // إضافة المعاملة
      const transaction = {
        id: generateId(),
        type: type,
        amount: amount,
        currency: currency,
        description: description.trim(),
        timestamp: new Date()
      };
      
      transactions.push(transaction);
      
      // مسح النموذج
      amountInput.value = '';
      descriptionInput.value = '';
      
      // حفظ البيانات
      saveUserData();
      updateBalanceDisplay();
      
      showNotification(`تم إضافة ${type === 'income' ? 'الوارد' : 'الصادر'} بنجاح`);
    }

    function processTransfer() {
      const fromCurrencySelect = document.getElementById('fromCurrency');
      const toCurrencySelect = document.getElementById('toCurrency');
      const amountInput = document.getElementById('transferAmount');
      const exchangeRateInput = document.getElementById('exchangeRate');
      
      if (!fromCurrencySelect || !toCurrencySelect || !amountInput || !exchangeRateInput) return;
      
      const fromCurrency = fromCurrencySelect.value;
      const toCurrency = toCurrencySelect.value;
      const amount = parseFloat(amountInput.value);
      const exchangeRate = parseFloat(exchangeRateInput.value);
      
      if (fromCurrency === toCurrency) {
        showNotification('لا يمكن التحويل إلى نفس العملة', 'error');
        return;
      }
      
      if (!amount || amount <= 0) {
        showNotification('يرجى إدخال مبلغ صحيح', 'error');
        return;
      }
      
      if (!exchangeRate || exchangeRate <= 0) {
        showNotification('يرجى إدخال سعر صرف صحيح', 'error');
        return;
      }
      
      if ((balances[fromCurrency] || 0) < amount) {
        showNotification('الرصيد غير كافي', 'error');
        return;
      }
      
      // تنفيذ التحويل
      const convertedAmount = amount * exchangeRate;
      
      if (!balances[fromCurrency]) balances[fromCurrency] = 0;
      if (!balances[toCurrency]) balances[toCurrency] = 0;
      
      balances[fromCurrency] -= amount;
      balances[toCurrency] += convertedAmount;
      
      // إضافة معاملة التحويل
      const transaction = {
        id: generateId(),
        type: 'transfer',
        amount: amount,
        currency: fromCurrency,
        toCurrency: toCurrency,
        convertedAmount: convertedAmount,
        exchangeRate: exchangeRate,
        description: `تحويل من ${getCurrencyName(fromCurrency)} إلى ${getCurrencyName(toCurrency)}`,
        timestamp: new Date()
      };
      
      transactions.push(transaction);
      
      // مسح النموذج
      amountInput.value = '';
      exchangeRateInput.value = '';
      
      // حفظ البيانات
      saveUserData();
      updateBalanceDisplay();
      
      showNotification(`تم التحويل بنجاح: ${formatCurrency(amount, fromCurrency)} → ${formatCurrency(convertedAmount, toCurrency)}`);
    }

    function deleteTransaction(transactionId) {
      if (!confirm('هل أنت متأكد من حذف هذه المعاملة؟')) {
        return;
      }
      
      const transactionIndex = transactions.findIndex(t => t.id === transactionId);
      if (transactionIndex === -1) {
        showNotification('المعاملة غير موجودة', 'error');
        return;
      }
      
      const transaction = transactions[transactionIndex];
      
      // عكس تأثير المعاملة على الرصيد
      if (transaction.type === 'income') {
        balances[transaction.currency] -= transaction.amount;
      } else if (transaction.type === 'expense') {
        balances[transaction.currency] += transaction.amount;
      } else if (transaction.type === 'transfer') {
        balances[transaction.currency] += transaction.amount;
        balances[transaction.toCurrency] -= transaction.convertedAmount;
      }
      
      // حذف المعاملة
      transactions.splice(transactionIndex, 1);
      
      // حفظ البيانات
      saveUserData();
      updateBalanceDisplay();
      updateTransactionsDisplay();
      
      showNotification('تم حذف المعاملة بنجاح');
    }

    // وظائف الفلاتر
    function applyFilters() {
      const typeFilter = document.getElementById('filter-type');
      const currencyFilter = document.getElementById('filter-currency');
      const dateFromFilter = document.getElementById('filter-date-from');
      const dateToFilter = document.getElementById('filter-date-to');
      const descriptionFilter = document.getElementById('filter-description');
      const amountMinFilter = document.getElementById('filter-amount-min');
      const amountMaxFilter = document.getElementById('filter-amount-max');
      
      if (!typeFilter || !currencyFilter) return;
      
      const typeValue = typeFilter.value;
      const currencyValue = currencyFilter.value;
      const dateFromValue = dateFromFilter ? dateFromFilter.value : '';
      const dateToValue = dateToFilter ? dateToFilter.value : '';
      const descriptionValue = descriptionFilter ? descriptionFilter.value.toLowerCase() : '';
      const amountMinValue = amountMinFilter ? parseFloat(amountMinFilter.value) || 0 : 0;
      const amountMaxValue = amountMaxFilter ? parseFloat(amountMaxFilter.value) || Infinity : Infinity;
      
      filteredTransactions = transactions.filter(transaction => {
        // فلتر النوع
        if (typeValue && transaction.type !== typeValue) return false;
        
        // فلتر العملة
        if (currencyValue && transaction.currency !== currencyValue) return false;
        
        // فلتر التاريخ
        const transactionDate = new Date(transaction.timestamp).toISOString().split('T')[0];
        if (dateFromValue && transactionDate < dateFromValue) return false;
        if (dateToValue && transactionDate > dateToValue) return false;
        
        // فلتر الوصف
        if (descriptionValue && !transaction.description.toLowerCase().includes(descriptionValue)) return false;
        
        // فلتر المبلغ
        if (transaction.amount < amountMinValue || transaction.amount > amountMaxValue) return false;
        
        return true;
      });
      
      displayFilteredTransactions();
    }

    function clearFilters() {
      const filterElements = [
        'filter-type', 'filter-currency', 'filter-date-from', 
        'filter-date-to', 'filter-description', 'filter-amount-min', 'filter-amount-max'
      ];
      
      filterElements.forEach(elementId => {
        const element = document.getElementById(elementId);
        if (element) element.value = '';
      });
      
      applyFilters();
    }

    function displayFilteredTransactions() {
      const transactionsList = document.getElementById('transactions-list');
      if (!transactionsList) return;
      
      transactionsList.innerHTML = '';
      
      if (filteredTransactions.length === 0) {
        transactionsList.innerHTML = '<p style="text-align:center;color:#666;padding:20px">لا توجد معاملات تطابق الفلاتر المحددة</p>';
        return;
      }
      
      // ترتيب المعاملات حسب التاريخ (الأحدث أولاً)
      const sortedTransactions = [...filteredTransactions].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      
      sortedTransactions.forEach(transaction => {
        const transactionElement = document.createElement('div');
        transactionElement.className = 'debt-record';
        
        let typeIcon, typeText, typeColor;
        if (transaction.type === 'income') {
          typeIcon = 'fa-plus';
          typeText = 'وارد';
          typeColor = 'var(--success)';
        } else if (transaction.type === 'expense') {
          typeIcon = 'fa-minus';
          typeText = 'صادر';
          typeColor = 'var(--danger)';
        } else {
          typeIcon = 'fa-right-left';
          typeText = 'تحويل';
          typeColor = 'var(--primary)';
        }
        
        const date = new Date(transaction.timestamp).toLocaleDateString('ar-SA');
        const time = new Date(transaction.timestamp).toLocaleTimeString('ar-SA', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        
        transactionElement.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="display:flex;align-items:center;gap:8px">
              <i class="fas ${typeIcon}" style="color:${typeColor}"></i>
              <strong style="color:${typeColor}">${typeText}</strong>
            </div>
            <button class="btn-danger" onclick="deleteTransaction('${transaction.id}')" 
                    style="padding:4px 8px;font-size:12px">حذف</button>
          </div>
          <div style="margin-bottom:8px">
            <strong>${transaction.description}</strong>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;font-size:14px;color:#666">
            <div>
              ${formatCurrency(transaction.amount, transaction.currency)}
              ${transaction.type === 'transfer' ? 
                ` → ${formatCurrency(transaction.convertedAmount, transaction.toCurrency)}` : ''}
            </div>
            <div>${date} ${time}</div>
          </div>
        `;
        
        transactionsList.appendChild(transactionElement);
      });
    }

    // وظائف الإحصائيات
    function updateStatistics() {
      // حساب الإحصائيات
      let totalIncome = 0;
      let totalExpense = 0;
      let transactionCount = transactions.length;
      
      transactions.forEach(transaction => {
        if (transaction.type === 'income') {
          // تحويل إلى العملة الافتراضية للحساب
          totalIncome += convertToDefaultCurrency(transaction.amount, transaction.currency);
        } else if (transaction.type === 'expense') {
          totalExpense += convertToDefaultCurrency(transaction.amount, transaction.currency);
        }
      });
      
      const netBalance = totalIncome - totalExpense;
      
      // تحديث البطاقات
      const totalIncomeElement = document.getElementById('total-income');
      const totalExpenseElement = document.getElementById('total-expense');
      const netBalanceElement = document.getElementById('net-balance');
      const transactionCountElement = document.getElementById('transaction-count');
      
      if (totalIncomeElement) totalIncomeElement.textContent = formatCurrency(totalIncome, defaultCurrency);
      if (totalExpenseElement) totalExpenseElement.textContent = formatCurrency(totalExpense, defaultCurrency);
      if (netBalanceElement) netBalanceElement.textContent = formatCurrency(netBalance, defaultCurrency);
      if (transactionCountElement) transactionCountElement.textContent = transactionCount;
      
      // رسم الإحصائيات
      drawMonthlyChart();
      drawCurrencyChart();
    }

    function convertToDefaultCurrency(amount, fromCurrency) {
      // تحويل مبسط - في التطبيق الحقيقي يجب استخدام أسعار صرف حقيقية
      if (fromCurrency === defaultCurrency) return amount;
      
      const exchangeRates = {
        'SDG': 1,
        'USD': 600, // سعر تقريبي
        'EUR': 650  // سعر تقريبي
      };
      
      return amount * (exchangeRates[fromCurrency] || 1);
    }

    function drawMonthlyChart() {
      const ctx = document.getElementById('monthly-chart');
      if (!ctx) return;
      
      // تجميع البيانات حسب الشهر
      const monthlyData = {};
      
      transactions.forEach(transaction => {
        const date = new Date(transaction.timestamp);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        
        if (!monthlyData[monthKey]) {
          monthlyData[monthKey] = { income: 0, expense: 0 };
        }
        
        const amount = convertToDefaultCurrency(transaction.amount, transaction.currency);
        
        if (transaction.type === 'income') {
          monthlyData[monthKey].income += amount;
        } else if (transaction.type === 'expense') {
          monthlyData[monthKey].expense += amount;
        }
      });
      
      const labels = Object.keys(monthlyData).sort();
      const incomeData = labels.map(month => monthlyData[month].income);
      const expenseData = labels.map(month => monthlyData[month].expense);
      
      try {
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'الوارد',
              data: incomeData,
              backgroundColor: 'rgba(40, 167, 69, 0.8)',
              borderColor: 'rgba(40, 167, 69, 1)',
              borderWidth: 1
            }, {
              label: 'الصادر',
              data: expenseData,
              backgroundColor: 'rgba(220, 53, 69, 0.8)',
              borderColor: 'rgba(220, 53, 69, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      } catch (error) {
        console.error('Error drawing monthly chart:', error);
      }
    }

    function drawCurrencyChart() {
      const ctx = document.getElementById('currency-chart');
      if (!ctx) return;
      
      // استخدام العملات الفعلية والأرصدة الحقيقية
      const actualCurrencies = Object.keys(balances).filter(currency => balances[currency] > 0);
      const actualBalances = actualCurrencies.map(currency => balances[currency]);
      
      // إذا لم توجد أرصدة، عرض رسالة
      if (actualCurrencies.length === 0) {
        ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
        const context = ctx.getContext('2d');
        context.font = '16px Tajawal';
        context.fillStyle = '#666';
        context.textAlign = 'center';
        context.fillText('لا توجد أرصدة لعرضها', ctx.width / 2, ctx.height / 2);
        return;
      }
      
      const colors = [
        'rgba(44, 120, 108, 0.8)',
        'rgba(255, 209, 102, 0.8)',
        'rgba(0, 68, 69, 0.8)',
        'rgba(220, 53, 69, 0.8)',
        'rgba(40, 167, 69, 0.8)',
        'rgba(23, 162, 184, 0.8)',
        'rgba(255, 193, 7, 0.8)'
      ];
      
      try {
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: actualCurrencies.map(currency => getCurrencyName(currency)),
            datasets: [{
              data: actualBalances,
              backgroundColor: colors.slice(0, actualCurrencies.length),
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      } catch (error) {
        console.error('Error drawing currency chart:', error);
      }
    }

    // وظائف الإعدادات
    function showSettingsTab(tabName) {
      // إخفاء جميع التبويبات
      const tabs = document.querySelectorAll('.tab-content');
      tabs.forEach(tab => tab.classList.remove('active'));
      
      const buttons = document.querySelectorAll('.tab-button');
      buttons.forEach(button => button.classList.remove('active'));
      
      // عرض التبويب المطلوب
      const targetTab = document.getElementById(`${tabName}-tab`);
      if (targetTab) {
        targetTab.classList.add('active');
      }
      
      // تحديث زر التبويب النشط
      const activeButton = Array.from(buttons).find(button => 
        button.textContent.includes(tabName === 'account' ? 'الحساب' : 
                                   tabName === 'database' ? 'قاعدة البيانات' :
                                   tabName === 'interface' ? 'الواجهة' : 'العملات'));
      if (activeButton) {
        activeButton.classList.add('active');
      }
    }

    function addCurrency() {
      const currencySelect = document.getElementById('currency-select');
      if (!currencySelect) return;
      
      const newCurrency = currencySelect.value;
      
      if (currencies.includes(newCurrency)) {
        showNotification('العملة موجودة بالفعل', 'warning');
        return;
      }
      
      currencies.push(newCurrency);
      if (!balances[newCurrency]) {
        balances[newCurrency] = 0;
      }
      
      saveUserData();
      updateUI();
      showNotification(`تم إضافة ${getCurrencyName(newCurrency)} بنجاح`);
    }

    function removeCurrency(currency) {
      if (currency === defaultCurrency) {
        showNotification('لا يمكن حذف العملة الافتراضية', 'error');
        return;
      }
      
      if (!confirm(`هل أنت متأكد من حذف ${getCurrencyName(currency)}؟`)) {
        return;
      }
      
      currencies = currencies.filter(c => c !== currency);
      delete balances[currency];
      
      // حذف المعاملات المرتبطة بهذه العملة
      transactions = transactions.filter(t => t.currency !== currency && t.toCurrency !== currency);
      
      saveUserData();
      updateUI();
      showNotification(`تم حذف ${getCurrencyName(currency)} بنجاح`);
    }

    function changeDefaultCurrency() {
      const defaultCurrencySelect = document.getElementById('default-currency-select');
      if (!defaultCurrencySelect) return;
      
      const newDefaultCurrency = defaultCurrencySelect.value;
      defaultCurrency = newDefaultCurrency;
      
      saveUserData();
      updateUI();
      showNotification(`تم تغيير العملة الافتراضية إلى ${getCurrencyName(newDefaultCurrency)}`);
    }

    function changeLanguage() {
      const languageSelect = document.getElementById('language-select');
      if (!languageSelect) return;
      
      const newLanguage = languageSelect.value;
      currentLanguage = newLanguage;
      
      // هنا يمكن إضافة منطق تغيير اللغة
      saveUserData();
      showNotification('تم تغيير اللغة بنجاح');
    }

    function changeTheme() {
      const themeSelect = document.getElementById('theme-select');
      if (!themeSelect) return;
      
      const newTheme = themeSelect.value;
      document.body.setAttribute('data-theme', newTheme);
      
      const themeIcon = document.getElementById('theme-icon');
      if (themeIcon) {
        themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      }
      
      saveUserData();
      showNotification('تم تغيير المظهر بنجاح');
    }

    // دالة إظهار وإخفاء الفلاتر المتقدمة
    function toggleFilters() {
      const advancedFilters = document.getElementById('advanced-filters');
      const toggleBtn = document.querySelector('.filter-toggle-btn');
      const chevron = document.getElementById('filter-chevron');
      
      if (!advancedFilters || !toggleBtn || !chevron) return;
      
      const isVisible = advancedFilters.style.display !== 'none';
      
      if (isVisible) {
        advancedFilters.style.display = 'none';
        toggleBtn.classList.remove('active');
        chevron.style.transform = 'rotate(0deg)';
      } else {
        advancedFilters.style.display = 'block';
        toggleBtn.classList.add('active');
        chevron.style.transform = 'rotate(180deg)';
      }
    }

    function toggleTheme() {
      const currentTheme = document.body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      document.body.setAttribute('data-theme', newTheme);
      
      const themeSelect = document.getElementById('theme-select');
      if (themeSelect) themeSelect.value = newTheme;
      
      const themeIcon = document.getElementById('theme-icon');
      if (themeIcon) {
        themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      }
      
      saveUserData();
    }

    function toggleLanguage() {
      // منطق تبديل اللغة
      currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
      
      // تحديث اتجاه الصفحة ولغتها
      const html = document.documentElement;
      if (currentLanguage === 'ar') {
        html.setAttribute('lang', 'ar');
        html.setAttribute('dir', 'rtl');
      } else {
        html.setAttribute('lang', 'en');
        html.setAttribute('dir', 'ltr');
      }
      
      // تحديث نص زر اللغة
      const languageBtn = document.querySelector('.header-btn:nth-child(2)');
      if (languageBtn) {
        languageBtn.textContent = currentLanguage === 'ar' ? 'EN' : 'ع';
      }
      
      // تحديث نص زر اللغة في الإعدادات
      const settingsLanguageBtn = document.querySelector('[onclick="toggleLanguage()"]');
      if (settingsLanguageBtn) {
        settingsLanguageBtn.innerHTML = `<i class="fas fa-language"></i> اللغة ${currentLanguage === 'ar' ? 'العربية / English' : 'English / العربية'}`;
      }
      
      saveUserData();
      showNotification(currentLanguage === 'ar' ? 'تم تغيير اللغة إلى العربية' : 'Language changed to English');
    }

    function exportData() {
      const data = {
        currencies,
        balances,
        transactions,
        preferences: {
          language: currentLanguage,
          theme: document.body.getAttribute('data-theme'),
          defaultCurrency
        },
        exportDate: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(data, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `financial-data-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      showNotification('تم تصدير البيانات بنجاح');
    }

    function resetAllData() {
      if (!confirm('هل أنت متأكد من حذف جميع البيانات؟ هذا الإجراء لا يمكن التراجع عنه!')) {
        return;
      }
      
      if (!confirm('تأكيد أخير: سيتم حذف جميع الأرصدة والمعاملات نهائياً!')) {
        return;
      }
      
      // إعادة تعيين البيانات
      currencies = ['SDG', 'USD', 'EUR'];
      balances = { SDG: 0, USD: 0, EUR: 0 };
      transactions = [];
      defaultCurrency = 'SDG';
      
      saveUserData();
      updateUI();
      showNotification('تم حذف جميع البيانات بنجاح');
    }

    // تهيئة التطبيق
    document.addEventListener('DOMContentLoaded', function() {
      // ربط أحداث أزرار تسجيل الدخول
      const loginButton = document.querySelector('button[onclick="handleLogin()"]');
      if (loginButton) {
        loginButton.addEventListener('click', function(e) {
          e.preventDefault();
          handleLogin();
        });
      }

      const googleLoginButtons = document.querySelectorAll('button[onclick="signInWithGoogle()"]');
      googleLoginButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          signInWithGoogle();
        });
      });

      const signupButton = document.querySelector('button[onclick="handleSignup()"]');
      if (signupButton) {
        signupButton.addEventListener('click', function(e) {
          e.preventDefault();
          handleSignup();
        });
      }

      // مراقبة حالة المصادقة
      if (firebaseInitialized && auth) {
        auth.onAuthStateChanged(user => {
          if (user) {
            currentUser = user;
            loadUserData();
            showApp();
    // دالة عرض معلومات الحساب
    function showAccountInfo() {
      showPage('account-info');
      
      // تحديث حقول معلومات الحساب
      if (currentUser) {
        const userNameInput = document.getElementById('user-name');
        const userEmailInput = document.getElementById('user-email');
        
        if (userNameInput) {
          userNameInput.value = currentUser.displayName || '';
        }
        if (userEmailInput) {
          userEmailInput.value = currentUser.email || '';
        }
      }
    }

    // دالة تحديث معلومات الحساب
    function updateProfile() {
      if (!currentUser) {
        showNotification('لا يوجد مستخدم مسجل دخول', 'error');
        return;
      }

      const newName = document.getElementById('user-name').value.trim();
      const newPassword = document.getElementById('new-password').value;

      if (!newName && !newPassword) {
        showNotification('يرجى إدخال الاسم الجديد أو كلمة المرور الجديدة', 'error');
        return;
      }

      let updatePromises = [];

      // تحديث الاسم
      if (newName && newName !== currentUser.displayName) {
        if (newName.length < 2) {
          showNotification('يجب أن يكون الاسم مكوناً من حرفين على الأقل', 'error');
          return;
        }
        updatePromises.push(
          currentUser.updateProfile({ displayName: newName })
            .then(() => showNotification('تم تحديث الاسم بنجاح'))
        );
      }

      // تحديث كلمة المرور
      if (newPassword) {
        if (!validatePassword(newPassword)) {
          showNotification('كلمة المرور يجب أن تحتوي على: حرف كبير، حرف صغير، رقم، رمز خاص، وأن تكون 8 أحرف على الأقل', 'error');
          return;
        }
        updatePromises.push(
          currentUser.updatePassword(newPassword)
            .then(() => {
              showNotification('تم تحديث كلمة المرور بنجاح');
              document.getElementById('new-password').value = '';
            })
        );
      }

      // تنفيذ التحديثات
      Promise.all(updatePromises)
        .then(() => {
          if (updatePromises.length > 1) {
            showNotification('تم تحديث معلومات الحساب بنجاح');
          }
          saveUserData();
        })
        .catch(error => {
          console.error('Profile update error:', error);
          let errorMessage = 'حدث خطأ أثناء تحديث معلومات الحساب';
          
          switch(error.code) {
            case 'auth/weak-password':
              errorMessage = 'كلمة المرور ضعيفة جداً. يرجى استخدام كلمة مرور أقوى.';
              break;
            case 'auth/requires-recent-login':
              errorMessage = 'يتطلب تسجيل دخول حديث لتحديث كلمة المرور. يرجى تسجيل الخروج والدخول مرة أخرى.';
              break;
            case 'auth/network-request-failed':
              errorMessage = 'مشكلة في الاتصال بالإنترنت. يرجى المحاولة لاحقاً.';
              break;
            default:
              errorMessage = `خطأ في التحديث: ${error.message || 'يرجى المحاولة لاحقاً'}`;
          }
          
          showNotification(errorMessage, 'error');
        });
    }

    // دالة تحديث حالة المظهر في الإعدادات
    function updateThemeStatus() {
      const themeStatus = document.getElementById('theme-status');
      const settingsThemeIcon = document.getElementById('settings-theme-icon');
      const currentTheme = document.body.getAttribute('data-theme');
      
      if (themeStatus) {
        themeStatus.textContent = currentTheme === 'dark' ? 'مظلم' : 'فاتح';
      }
      
      if (settingsThemeIcon) {
        settingsThemeIcon.className = currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      }
    }

    // تحديث دالة toggleTheme لتحديث حالة المظهر
    const originalToggleTheme = toggleTheme;
    toggleTheme = function() {
      if (originalToggleTheme) {
        originalToggleTheme();
      } else {
        // تنفيذ تبديل المظهر الأساسي
        const currentTheme = document.body.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', newTheme);
        
        const themeIcon = document.getElementById('theme-icon');
        if (themeIcon) {
          themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }
    // تهيئة التطبيق
    document.addEventListener('DOMContentLoaded', function() {
      // التأكد من إخفاء التطبيق في البداية
      const appContainer = document.getElementById('app-container');
      const authContainer = document.getElementById('auth-container');
      
      if (appContainer) appContainer.style.display = 'none';
      if (authContainer) authContainer.style.display = 'flex';
      
      // مراقبة حالة المصادقة
      if (firebaseInitialized && auth) {
        auth.onAuthStateChanged(user => {
          if (user && user.emailVerified !== false) {
            // التحقق من صحة المستخدم
            currentUser = user;
            console.log('User authenticated:', user.email);
            loadUserData();
            showApp();
          } else {
            // إذا لم يكن هناك مستخدم أو المستخدم غير مؤكد
            console.log('No authenticated user or unverified email');
            currentUser = null;
            showAuth();
          }
        });
      } else {
        // إذا لم يكن Firebase متاحاً، عرض واجهة المصادقة مع رسالة خطأ
        console.error('Firebase not initialized');
        showAuth();
        showNotification('Firebase غير متاح. يرجى التحقق من الإعدادات.', 'error');
      }
      
      // إعداد مراقبة كلمة المرور
      const passwordInput = document.getElementById('signup-password');
      const requirements = document.getElementById('password-requirements');
      
      if (passwordInput && requirements) {
        passwordInput.addEventListener('focus', () => {
          requirements.style.display = 'block';
        });
        
        passwordInput.addEventListener('blur', () => {
          requirements.style.display = 'none';
        });
      }
      
      // تهيئة الفلاتر
      setTimeout(() => {
        updateCurrencySelects();
        updateThemeStatus(); // تحديث حالة المظهر عند التحميل
      }, 1000);
      
      // إضافة مستمع للنقر خارج النافذة المنبثقة لإغلاقها
      const balanceModal = document.getElementById('balance-modal');
      if (balanceModal) {
        balanceModal.addEventListener('click', function(event) {
          if (event.target === balanceModal) {
            closeBalanceModal();
          }
        });
      }
    });

    }
      
      saveUserData();
      updateThemeStatus();
    }

  </script>

  <!-- نافذة منبثقة لإدارة الرصيد -->
  <div id="balance-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 id="balance-modal-title">إدارة الرصيد</h3>
      <div class="form-row">
        <label for="balance-currency">العملة</label>
        <select id="balance-currency"></select>
      </div>
      <div class="form-row">
        <label for="balance-amount">المبلغ</label>
        <input type="number" id="balance-amount" placeholder="0.00" step="0.01" min="0">
      </div>
      <div class="form-row">
        <label for="balance-description">الوصف (اختياري)</label>
        <input type="text" id="balance-description" placeholder="وصف العملية">
      </div>
      <div class="modal-buttons">
        <button onclick="closeBalanceModal()">إلغاء</button>
        <button id="balance-confirm-btn" onclick="processBalanceChange()">تأكيد</button>
      </div>
    </div>
  </div>

</body>
</html>