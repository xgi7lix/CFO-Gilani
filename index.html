<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>نظام الإدارة المالية المتقدم</title>

  <!-- خط -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <!-- أيقونات -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- html2canvas (للتصدير مستقبلاً إن احتجت) -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --primary:#2C786C;
      --secondary:#004445;
      --accent:#FFD166;
      --light:#f8f9fa;
      --dark:#333;
      --danger:#dc3545;
      --danger-hover:#c82333;
      --shadow:0 4px 6px rgba(0,0,0,.1);
      --t:all .25s ease;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Tajawal',sans-serif;
      background:var(--light);
      color:var(--dark);
      line-height:1.6;
    }

    /* رأس */
    header{
      background:var(--primary);
      color:#fff;
      box-shadow:var(--shadow);
    }
    #main-header{padding:16px 0}
    #main-header h1{margin:0;font-size:1.4rem;text-align:center}
    #page-header{display:none;align-items:center;gap:12px;padding:10px 12px}
    #page-title{margin:0;font-size:1.1rem}

    /* حاوية */
    .container{max-width:1100px;margin:0 auto;padding:14px}

    /* شبكة البطاقات */
    .main-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    @media(min-width:768px){.main-grid{grid-template-columns:repeat(3,1fr)}}
    .main-card{
      background:#fff;border:2px solid var(--primary);border-radius:12px;
      padding:18px;text-align:center;cursor:pointer;transition:var(--t);
      min-height:120px;display:flex;flex-direction:column;justify-content:center;align-items:center
    }
    .main-card i{font-size:28px;color:var(--primary);margin-bottom:8px}
    .main-card:hover{transform:translateY(-4px);background:var(--primary);color:#fff}
    .main-card:hover i{color:#fff}

    /* الصفحات */
    .page{display:none;background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:14px;margin-top:14px}
    .active-page{display:block}
    .page-header{display:flex;align-items:center;gap:8px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #eee}
    .page-header i{color:var(--primary)}

    /* عناصر نموذج */
    .form-row{margin-bottom:12px}
    label{display:block;margin-bottom:6px;font-weight:700}
    input,select,textarea,button{
      width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-family:'Tajawal',sans-serif;font-size:14px
    }
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(44,120,108,.15)}
    textarea{resize:vertical}
    button{cursor:pointer;background:var(--primary);color:#fff;border:none;font-weight:700;transition:var(--t)}
    button:hover{background:var(--secondary)}
    .btn-danger{background:var(--danger)}
    .btn-danger:hover{background:var(--danger-hover)}
    .btn-wide{display:block;width:100%;padding:14px;margin:10px 0;text-align:right}

    .balance-item{padding:10px;margin:6px 0;background:#f7f7f8;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
    .debt-records-container{padding:8px;background:#f7f7f8;border-radius:8px;max-height:300px;overflow:auto}
    .debt-record{padding:8px;margin:6px 0;background:#fff;border:1px solid #eee;border-radius:8px}

    /* توست */
    .notification{
      position:fixed;top:16px;left:50%;transform:translateX(-50%);
      background:#28a745;color:#fff;padding:10px 14px;border-radius:8px;z-index:9999;box-shadow:var(--shadow)
    }
    .notification.error{background:var(--danger)}

    /* مصادقة */
    #auth-container{min-height:100vh;display:flex;justify-content:center;align-items:center;padding:16px}
    .auth-box{background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:22px;max-width:400px;width:100%}
    .auth-box h2{margin:0 0 14px;color:var(--primary)}
    .auth-switch{margin-top:12px;text-align:center}
    .auth-switch a{color:var(--primary);cursor:pointer;font-weight:700}
    .auth-switch a:hover{text-decoration:underline}
    .google-btn{background:#4285F4}
    .google-btn:hover{background:#357ae8}
    .or-sep{margin:14px 0;text-align:center;color:#999}

    /* لودر */
    .loader{
      display:none;border:4px solid #eee;border-top:4px solid var(--primary);
      border-radius:50%;width:28px;height:28px;margin:10px auto;animation:spin 1s linear infinite
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* زر رجوع */
    .back-button{background:rgba(255,255,255,.2);border:none;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
  </style>
</head>
<body>

  <!-- واجهة المصادقة -->
  <div id="auth-container">
    <div class="auth-box">
      <!-- تسجيل الدخول -->
      <div id="login-form">
        <h2>تسجيل الدخول</h2>
        <div class="form-row">
          <label for="login-email">البريد الإلكتروني</label>
          <input type="email" id="login-email" placeholder="email@example.com" required>
        </div>
        <div class="form-row">
          <label for="login-password">كلمة المرور</label>
          <input type="password" id="login-password" placeholder="********" required>
        </div>
        <div class="form-row" style="text-align:left;margin:-6px 0 10px">
          <a href="#" onclick="handlePasswordReset(event)" class="auth-switch">نسيت كلمة المرور؟</a>
        </div>
        <button type="button" onclick="handleLogin()">تسجيل الدخول</button>
        <div class="loader" id="login-loader"></div>

        <div class="or-sep">أو</div>

        <button type="button" class="google-btn" onclick="signInWithGoogle()">
          <i class="fab fa-google"></i> المتابعة باستخدام Google
        </button>
        <div class="loader" id="google-loader"></div>

        <p class="auth-switch">ليس لديك حساب؟ <a onclick="toggleAuthForms()">إنشاء حساب جديد</a></p>
      </div>

      <!-- إنشاء حساب -->
      <div id="signup-form" style="display:none">
        <h2>إنشاء حساب جديد</h2>
        <div class="form-row">
          <label for="signup-firstname">الاسم الأول</label>
          <input id="signup-firstname" type="text" placeholder="مثال: أحمد" required>
        </div>
        <div class="form-row">
          <label for="signup-lastname">الاسم الأخير</label>
          <input id="signup-lastname" type="text" placeholder="مثال: محمد" required>
        </div>
        <div class="form-row">
          <label for="signup-email">البريد الإلكتروني</label>
          <input id="signup-email" type="email" placeholder="email@example.com" required>
        </div>
        <div class="form-row">
          <label for="signup-password">كلمة المرور</label>
          <input id="signup-password" type="password" placeholder="حرف كبير، صغير، رقم، رمز خاص" required>
          <div id="password-requirements" style="font-size:12px;color:#666;margin-top:4px;display:none">
            <div>• حرف كبير واحد على الأقل (A-Z)</div>
            <div>• حرف صغير واحد على الأقل (a-z)</div>
            <div>• رقم واحد على الأقل (0-9)</div>
            <div>• رمز خاص واحد على الأقل ($&#@!%*?&)</div>
            <div>• 8 أحرف على الأقل</div>
          </div>
        </div>
        <button type="button" onclick="handleSignup()">إنشاء حساب</button>
        <div class="loader" id="signup-loader"></div>

        <div class="or-sep">أو</div>

        <button type="button" class="google-btn" onclick="signInWithGoogle()">
          <i class="fab fa-google"></i> المتابعة باستخدام Google
        </button>
        <div class="loader" id="google-loader-signup"></div>

        <p class="auth-switch">لديك حساب بالفعل؟ <a onclick="toggleAuthForms()">تسجيل الدخول</a></p>
      </div>
    </div>
  </div>

  <!-- التطبيق -->
  <div id="app-container" style="display:none">
    <!-- رأس رئيسي -->
    <header id="main-header">
      <div class="container">
        <h1><i class="fas fa-wallet"></i> نظام الإدارة المالية المتقدم</h1>
      </div>
    </header>

    <!-- رأس صفحات -->
    <header id="page-header">
      <div class="container" style="display:flex;align-items:center;gap:10px">
        <button class="back-button" onclick="goBack()"><i class="fas fa-arrow-right"></i> رجوع</button>
        <h1 id="page-title"></h1>
      </div>
    </header>

    <main class="container" id="main-content">
      <div class="main-grid">
        <div class="main-card" onclick="showPage('balances-page')">
          <i class="fas fa-wallet"></i><h3>كشف الحساب</h3>
        </div>
        <div class="main-card" onclick="showPage('transfers-page')">
          <i class="fas fa-right-left"></i><h3>التحويلات</h3>
        </div>
        <div class="main-card" onclick="showPage('expenses-page')">
          <i class="fas fa-money-bill-wave"></i><h3>الصادر والوارد</h3>
        </div>
        <div class="main-card" onclick="showPage('transactions-page')">
          <i class="fas fa-list"></i><h3>كل المعاملات</h3>
        </div>
        <div class="main-card" onclick="showPage('customerDebtsPage')">
          <i class="fas fa-users"></i><h3>ديون العملاء</h3>
        </div>
        <div class="main-card" onclick="showPage('settings-page')">
          <i class="fas fa-gear"></i><h3>الإعدادات</h3>
        </div>
      </div>
    </main>

    <!-- كشف الحساب -->
    <div class="container page" id="balances-page">
      <div class="page-header"><i class="fas fa-wallet"></i><h2>كشف الحساب</h2></div>
      <div id="balancesList"></div>
      <h3 style="margin-top:12px">أحدث المعاملات</h3>
      <div id="recentTransactions"></div>
    </div>

    <!-- التحويلات -->
    <div class="container page" id="transfers-page">
      <div class="page-header"><i class="fas fa-right-left"></i><h2>التحويلات</h2></div>
      <div class="form-row"><label>من:</label><select id="fromCurrency"></select></div>
      <div class="form-row"><label>إلى:</label><select id="toCurrency"></select></div>
      <div class="form-row"><label>المبلغ:</label><input id="transferAmount" type="number" placeholder="أدخل المبلغ"></div>
      <div class="form-row">
        <label>سعر الصرف:</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="exchangeRate" type="number" step="0.0001" placeholder="أدخل سعر الصرف">
          <button id="rateModeBtn" type="button" style="width:auto" onclick="toggleRateMode()">×</button>
        </div>
      </div>
      <div class="form-row"><label>تعليق (اختياري):</label><input id="transferComment" type="text" placeholder="تعليق"></div>
      <button type="button" onclick="performTransfer()"><i class="fas fa-check"></i> تنفيذ التحويل</button>
    </div>

    <!-- الصادر والوارد -->
    <div class="container page" id="expenses-page">
      <div class="page-header"><i class="fas fa-money-bill-wave"></i><h2>الصادر والوارد</h2></div>
      <div class="form-row"><label>الاسم:</label><input id="expensePerson" type="text" placeholder="اسم العميل/المورد"></div>
      <div class="form-row"><label>نوع العملية:</label>
        <select id="expenseType"><option value="صادر">صادر</option><option value="وارد">وارد</option></select>
      </div>
      <div class="form-row"><label>المبلغ:</label><input id="expenseAmount" type="number" placeholder="المبلغ"></div>
      <div class="form-row"><label>العملة:</label><select id="expenseCurrency"></select></div>
      <div class="form-row"><label>تفاصيل:</label><textarea id="expenseDetails" rows="3" placeholder="تفاصيل العملية"></textarea></div>
      <button type="button" onclick="performExpense()"><i class="fas fa-check"></i> تنفيذ العملية</button>
    </div>

    <!-- كل المعاملات -->
    <div class="container page" id="transactions-page">
      <div class="page-header"><i class="fas fa-list"></i><h2>كل المعاملات</h2></div>
      <div class="form-row"><input id="transactionSearch" type="text" placeholder="ابحث..." oninput="searchTransactions()"></div>
      <div id="transactionsList"></div>
    </div>

    <!-- ديون العملاء -->
    <div class="container page" id="customerDebtsPage">
      <div class="page-header"><i class="fas fa-users"></i><h2>ديون العملاء</h2></div>
      <div id="overallDebtSummary" class="balance-item"></div>

      <div class="form-row" style="display:flex;gap:8px">
        <button type="button" onclick="toggleAddClient()">إضافة عميل</button>
        <button type="button" onclick="toggleRemoveClient()">إزالة عميل</button>
      </div>

      <div id="addClientSection" class="page" style="display:none;padding:10px;margin:0">
        <h3>إضافة عميل جديد</h3>
        <div class="form-row"><label>الاسم:</label><input id="newClientName" type="text"></div>
        <div class="form-row"><label>الهاتف:</label><input id="newClientPhone" type="text"></div>
        <div class="form-row"><label>ملاحظة:</label><input id="newClientNote" type="text"></div>
        <button type="button" onclick="addClientDebt()">تسجيل العميل</button>
      </div>

      <div id="removeClientSection" class="page" style="display:none;padding:10px;margin:8px 0 0">
        <h3>إزالة عميل</h3>
        <select id="removeClientDropdown"></select>
        <button type="button" class="btn-danger" onclick="removeClientFromDropdown()">حذف</button>
      </div>

      <div style="margin-top:10px">
        <h3>العملاء المسجّلون</h3>
        <div id="clientsListDisplay"></div>
      </div>
    </div>

    <!-- تفاصيل عميل -->
    <div class="container page" id="debtDetailsPage">
      <div class="page-header"><i class="fas fa-user"></i><h2>تفاصيل ديون العميل: <span id="clientDetailsName"></span></h2></div>
      <div id="clientDebtSummary" class="balance-item"></div>

      <div class="form-row"><label>نوع العملية:</label>
        <select id="clientDebtType"><option value="لك">لك (يطلب منك)</option><option value="له">له (تطالبه)</option></select>
      </div>
      <div class="form-row"><label>المبلغ:</label><input id="clientDebtAmount" type="number"></div>
      <div class="form-row"><label>العملة:</label><select id="clientDebtCurrency"></select></div>
      <div class="form-row"><label>تفاصيل:</label><input id="clientDebtComment" type="text" placeholder="ملاحظة"></div>
      <button type="button" onclick="addOrUpdateClientDebt()">إضافة / تعديل</button>

      <h3 style="margin-top:14px">السجلات</h3>
      <div id="clientDebtDetails" class="debt-records-container"></div>
    </div>

    <!-- الإعدادات -->
    <div class="container page" id="settings-page">
      <div class="page-header"><i class="fas fa-gear"></i><h2>الإعدادات</h2></div>
      <button class="btn-wide" onclick="showSettingsPage('currency-settings')"><i class="fas fa-coins"></i> إدارة العملات</button>
      <button class="btn-wide" onclick="showSettingsPage('balance-settings')"><i class="fas fa-wallet"></i> إدارة الرصيد</button>
      <button class="btn-wide btn-danger" onclick="resetAllData()"><i class="fas fa-trash"></i> مسح جميع البيانات</button>
      <button class="btn-wide" onclick="handleLogout()"><i class="fas fa-right-from-bracket"></i> تسجيل الخروج</button>
    </div>

    <!-- إدارة العملات -->
    <div class="container page" id="currency-settings-page">
      <div class="page-header"><i class="fas fa-coins"></i><h2>إدارة العملات</h2></div>
      <div class="page" style="display:block;padding:0;margin:0;background:transparent;box-shadow:none">
        <div class="balance-item" style="flex-direction:column;align-items:stretch">
          <div class="form-row">
            <label>اختر العملة لإضافتها:</label>
            <select id="currency-select">
              <option value="USD">دولار أمريكي (USD)</option>
              <option value="EUR">يورو (EUR)</option>
              <option value="GBP">جنيه إسترليني (GBP)</option>
              <option value="SAR">ريال سعودي (SAR)</option>
              <option value="AED">درهم إماراتي (AED)</option>
              <option value="EGP">جنيه مصري (EGP)</option>
              <option value="SDG">جنيه سوداني (SDG)</option>
              <option value="QAR">ريال قطري (QAR)</option>
            </select>
          </div>
          <button type="button" onclick="addCurrency()"><i class="fas fa-plus"></i> إضافة</button>
        </div>
        <div class="page" style="display:block;background:#fff;padding:10px;border-radius:8px">
          <h3 style="margin:0 0 10px">العملات المضافة</h3>
          <div id="currenciesList"></div>
        </div>
      </div>
    </div>

    <!-- إدارة الرصيد -->
    <div class="container page" id="balance-settings-page">
      <div class="page-header"><i class="fas fa-wallet"></i><h2>إدارة الرصيد</h2></div>
      <div class="form-row"><label>العملة:</label><select id="balance-currency"></select></div>
      <div class="form-row"><label>الرصيد الحالي:</label><input id="current-balance" type="number" step="0.01" placeholder="0.00" readonly></div>
      <div class="form-row"><label>المبلغ الجديد:</label><input id="new-balance" type="number" step="0.01" placeholder="أدخل الرصيد الجديد"></div>
      <button type="button" onclick="updateBalance()"><i class="fas fa-check"></i> تحديث الرصيد</button>
    </div>
  </div>

  <script>
    // إعداد Firebase
    const firebaseConfig = {
  apiKey: "AIzaSyD7eKVMk4-lZ48_3n88fsextFrziqiK-Mw",
  authDomain: "gilani-financial.firebaseapp.com",
  projectId: "gilani-financial",
  storageBucket: "gilani-financial.firebasestorage.app",
  messagingSenderId: "685744108797",
  appId: "1:685744108797:web:2feddfaf3f04d6028b7a94",
  measurementId: "G-1XDCKR6E5F"
};

    // تهيئة Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // متغيرات عامة
    let currentUser = null;
    let currencies = ['USD', 'EUR', 'SAR'];
    let balances = {};
    let transactions = [];
    let clientDebts = {};

    // دوال المصادقة
    function handleLogin() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      if (!email || !password) {
        showNotification('يرجى إدخال البريد الإلكتروني وكلمة المرور', 'error');
        return;
      }

      showLoader('login-loader');
      
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          currentUser = userCredential.user;
          showNotification('مرحباً بك! تم تسجيل الدخول بنجاح');
          loadUserData();
          showApp();
        })
        .catch((error) => {
          console.error('خطأ في تسجيل الدخول:', error);
          let errorMessage = 'حدث خطأ غير متوقع';
          
          if (error.code === 'auth/user-not-found') {
            errorMessage = 'لا يوجد حساب مسجل بهذا البريد الإلكتروني. يرجى إنشاء حساب جديد أولاً';
          } else if (error.code === 'auth/wrong-password') {
            errorMessage = 'كلمة المرور غير صحيحة. يرجى المحاولة مرة أخرى';
          } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'البريد الإلكتروني غير صحيح';
          } else if (error.code === 'auth/user-disabled') {
            errorMessage = 'تم تعطيل هذا الحساب. يرجى التواصل مع الدعم الفني';
          } else if (error.code === 'auth/too-many-requests') {
            errorMessage = 'تم تجاوز عدد المحاولات المسموح. يرجى المحاولة لاحقاً';
          }
          
          showNotification(errorMessage, 'error');
        })
        .finally(() => {
          hideLoader('login-loader');
        });
    }

    function handleSignup() {
      const firstName = document.getElementById('signup-firstname').value;
      const lastName = document.getElementById('signup-lastname').value;
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      
      if (!firstName || !lastName || !email || !password) {
        showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
        return;
      }

      // التحقق من شروط كلمة المرور
      if (!validatePassword(password)) {
        showNotification('كلمة المرور لا تلبي الشروط المطلوبة', 'error');
        return;
      }

      showLoader('signup-loader');
      
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          currentUser = userCredential.user;
          
          // تحديث ملف المستخدم
          return currentUser.updateProfile({
            displayName: `${firstName} ${lastName}`
          });
        })
        .then(() => {
          showNotification('أهلاً وسهلاً! تم إنشاء حسابك بنجاح');
          initializeUserData();
          showApp();
        })
        .catch((error) => {
          console.error('خطأ في إنشاء الحساب:', error);
          let errorMessage = 'حدث خطأ في إنشاء الحساب';
          
          if (error.code === 'auth/email-already-in-use') {
            errorMessage = 'هذا البريد الإلكتروني مستخدم بالفعل. يرجى تسجيل الدخول أو استخدام بريد آخر';
          } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'البريد الإلكتروني غير صحيح';
          } else if (error.code === 'auth/weak-password') {
            errorMessage = 'كلمة المرور ضعيفة جداً';
          }
          
          showNotification(errorMessage, 'error');
        })
        .finally(() => {
          hideLoader('signup-loader');
        });
    }

    // دالة التحقق من شروط كلمة المرور
    function validatePassword(password) {
      const hasUpperCase = /[A-Z]/.test(password);
      const hasLowerCase = /[a-z]/.test(password);
      const hasNumbers = /\d/.test(password);
      const hasSpecialChar = /[$&#@!%*?&]/.test(password);
      const hasMinLength = password.length >= 8;
      
      return hasUpperCase && hasLowerCase && hasNumbers && hasSpecialChar && hasMinLength;
    }

    // إظهار/إخفاء شروط كلمة المرور
    document.addEventListener('DOMContentLoaded', function() {
      const passwordInput = document.getElementById('signup-password');
      const requirementsDiv = document.getElementById('password-requirements');
      
      if (passwordInput && requirementsDiv) {
        passwordInput.addEventListener('focus', function() {
          requirementsDiv.style.display = 'block';
        });
        
        passwordInput.addEventListener('blur', function() {
          setTimeout(() => {
            requirementsDiv.style.display = 'none';
          }, 200);
        });
      }
    });

    function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      showLoader('google-loader');
      showLoader('google-loader-signup');
      
      auth.signInWithPopup(provider)
        .then((result) => {
          currentUser = result.user;
          showNotification('مرحباً بك! تم تسجيل الدخول بنجاح عبر Google');
          loadUserData();
          showApp();
        })
        .catch((error) => {
          console.error('خطأ في تسجيل الدخول بـ Google:', error);
          let errorMessage = 'حدث خطأ في تسجيل الدخول عبر Google';
          
          if (error.code === 'auth/popup-closed-by-user') {
            errorMessage = 'تم إلغاء عملية تسجيل الدخول';
          } else if (error.code === 'auth/popup-blocked') {
            errorMessage = 'تم حظر النافذة المنبثقة. يرجى السماح بالنوافذ المنبثقة والمحاولة مرة أخرى';
          } else if (error.code === 'auth/account-exists-with-different-credential') {
            errorMessage = 'يوجد حساب بهذا البريد الإلكتروني بطريقة تسجيل دخول مختلفة';
          }
          
          showNotification(errorMessage, 'error');
        })
        .finally(() => {
          hideLoader('google-loader');
          hideLoader('google-loader-signup');
        });
    }

    function handlePasswordReset(event) {
      event.preventDefault();
      const email = document.getElementById('login-email').value;
      
      if (!email) {
        showNotification('يرجى إدخال البريد الإلكتروني أولاً', 'error');
        return;
      }

      auth.sendPasswordResetEmail(email)
        .then(() => {
          showNotification('تم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني. يرجى التحقق من صندوق الوارد');
        })
        .catch((error) => {
          console.error('خطأ في إرسال رابط إعادة التعيين:', error);
          let errorMessage = 'حدث خطأ في إرسال رابط إعادة التعيين';
          
          if (error.code === 'auth/user-not-found') {
            errorMessage = 'لا يوجد حساب مسجل بهذا البريد الإلكتروني';
          } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'البريد الإلكتروني غير صحيح';
          }
          
          showNotification(errorMessage, 'error');
        });
    }

    function handleLogout() {
      auth.signOut().then(() => {
        currentUser = null;
        showAuth();
        showNotification('تم تسجيل الخروج بنجاح');
      });
    }

    function toggleAuthForms() {
      const loginForm = document.getElementById('login-form');
      const signupForm = document.getElementById('signup-form');
      
      if (loginForm.style.display === 'none') {
        loginForm.style.display = 'block';
        signupForm.style.display = 'none';
      } else {
        loginForm.style.display = 'none';
        signupForm.style.display = 'block';
      }
    }

    // دوال التطبيق
    function showApp() {
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('app-container').style.display = 'block';
      updateCurrencySelects();
      loadBalances();
      loadTransactions();
    }

    function showAuth() {
      document.getElementById('auth-container').style.display = 'flex';
      document.getElementById('app-container').style.display = 'none';
    }

    function showPage(pageId) {
      // إخفاء جميع الصفحات
      const pages = document.querySelectorAll('.page');
      pages.forEach(page => page.style.display = 'none');
      
      // إخفاء المحتوى الرئيسي
      document.getElementById('main-content').style.display = 'none';
      
      // إظهار رأس الصفحات
      document.getElementById('page-header').style.display = 'flex';
      
      // إظهار الصفحة المطلوبة
      const targetPage = document.getElementById(pageId);
      if (targetPage) {
        targetPage.style.display = 'block';
        
        // تحديث عنوان الصفحة
        const pageTitle = targetPage.querySelector('h2').textContent;
        document.getElementById('page-title').textContent = pageTitle;
      }
    }

    function goBack() {
      // إخفاء جميع الصفحات
      const pages = document.querySelectorAll('.page');
      pages.forEach(page => page.style.display = 'none');
      
      // إخفاء رأس الصفحات
      document.getElementById('page-header').style.display = 'none';
      
      // إظهار المحتوى الرئيسي
      document.getElementById('main-content').style.display = 'block';
    }

    function showSettingsPage(pageId) {
      showPage(pageId + '-page');
    }

    // دوال المساعدة
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type === 'error' ? 'error' : ''}`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 3000);
    }

    function showLoader(loaderId) {
      const loader = document.getElementById(loaderId);
      if (loader) loader.style.display = 'block';
    }

    function hideLoader(loaderId) {
      const loader = document.getElementById(loaderId);
      if (loader) loader.style.display = 'none';
    }

    // دوال البيانات
    function loadUserData() {
      if (!currentUser) return;
      
      // تحميل العملات
      db.collection('users').doc(currentUser.uid).collection('currencies').get()
        .then((querySnapshot) => {
          currencies = [];
          querySnapshot.forEach((doc) => {
            currencies.push(doc.id);
          });
          if (currencies.length === 0) {
            currencies = ['USD', 'EUR', 'SAR'];
          }
          updateCurrencySelects();
        });
      
      // تحميل الأرصدة
      db.collection('users').doc(currentUser.uid).collection('balances').get()
        .then((querySnapshot) => {
          balances = {};
          querySnapshot.forEach((doc) => {
            balances[doc.id] = doc.data().amount;
          });
          loadBalances();
        });
      
      // تحميل المعاملات
      db.collection('users').doc(currentUser.uid).collection('transactions')
        .orderBy('timestamp', 'desc')
        .get()
        .then((querySnapshot) => {
          transactions = [];
          querySnapshot.forEach((doc) => {
            transactions.push({id: doc.id, ...doc.data()});
          });
          loadTransactions();
        });
    }

    function initializeUserData() {
      if (!currentUser) return;
      
      // إضافة العملات الافتراضية
      currencies.forEach(currency => {
        db.collection('users').doc(currentUser.uid).collection('currencies').doc(currency).set({
          name: currency,
          added: firebase.firestore.FieldValue.serverTimestamp()
        });
      });
      
      // إضافة أرصدة افتراضية
      currencies.forEach(currency => {
        balances[currency] = 0;
        db.collection('users').doc(currentUser.uid).collection('balances').doc(currency).set({
          amount: 0
        });
      });
      
      updateCurrencySelects();
      loadBalances();
    }

    function updateCurrencySelects() {
      const selects = [
        'fromCurrency', 'toCurrency', 'expenseCurrency', 
        'clientDebtCurrency', 'balance-currency'
      ];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
          select.innerHTML = '';
          currencies.forEach(currency => {
            const option = document.createElement('option');
            option.value = currency;
            option.textContent = currency;
            select.appendChild(option);
          });
        }
      });
    }

    function loadBalances() {
      const balancesList = document.getElementById('balancesList');
      if (!balancesList) return;
      
      balancesList.innerHTML = '';
      
      currencies.forEach(currency => {
        const balance = balances[currency] || 0;
        const balanceItem = document.createElement('div');
        balanceItem.className = 'balance-item';
        balanceItem.innerHTML = `
          <span>${currency}</span>
          <span>${balance.toFixed(2)}</span>
        `;
        balancesList.appendChild(balanceItem);
      });
    }

    function loadTransactions() {
      const transactionsList = document.getElementById('transactionsList');
      const recentTransactions = document.getElementById('recentTransactions');
      
      if (transactionsList) {
        transactionsList.innerHTML = '';
        transactions.forEach(transaction => {
          const transactionItem = document.createElement('div');
          transactionItem.className = 'balance-item';
          transactionItem.innerHTML = `
            <div>
              <strong>${transaction.type}</strong><br>
              <small>${new Date(transaction.timestamp?.toDate()).toLocaleString('ar')}</small>
            </div>
            <span>${transaction.amount} ${transaction.currency}</span>
          `;
          transactionsList.appendChild(transactionItem);
        });
      }
      
      if (recentTransactions) {
        recentTransactions.innerHTML = '';
        transactions.slice(0, 5).forEach(transaction => {
          const transactionItem = document.createElement('div');
          transactionItem.className = 'balance-item';
          transactionItem.innerHTML = `
            <div>
              <strong>${transaction.type}</strong><br>
              <small>${new Date(transaction.timestamp?.toDate()).toLocaleString('ar')}</small>
            </div>
            <span>${transaction.amount} ${transaction.currency}</span>
          `;
          recentTransactions.appendChild(transactionItem);
        });
      }
    }

    // دوال العمليات المالية
    function performTransfer() {
      const fromCurrency = document.getElementById('fromCurrency').value;
      const toCurrency = document.getElementById('toCurrency').value;
      const amount = parseFloat(document.getElementById('transferAmount').value);
      const rate = parseFloat(document.getElementById('exchangeRate').value);
      const comment = document.getElementById('transferComment').value;
      
      if (!amount || amount <= 0) {
        showNotification('يرجى إدخال مبلغ صحيح', 'error');
        return;
      }
      
      if (!rate || rate <= 0) {
        showNotification('يرجى إدخال سعر صرف صحيح', 'error');
        return;
      }
      
      if (fromCurrency === toCurrency) {
        showNotification('لا يمكن التحويل إلى نفس العملة', 'error');
        return;
      }
      
      if ((balances[fromCurrency] || 0) < amount) {
        showNotification('الرصيد غير كافي', 'error');
        return;
      }
      
      // تنفيذ التحويل
      const convertedAmount = amount * rate;
      
      balances[fromCurrency] = (balances[fromCurrency] || 0) - amount;
      balances[toCurrency] = (balances[toCurrency] || 0) + convertedAmount;
      
      // حفظ في قاعدة البيانات
      if (currentUser) {
        db.collection('users').doc(currentUser.uid).collection('balances').doc(fromCurrency).set({
          amount: balances[fromCurrency]
        });
        
        db.collection('users').doc(currentUser.uid).collection('balances').doc(toCurrency).set({
          amount: balances[toCurrency]
        });
        
        // إضافة المعاملة
        const transaction = {
          type: 'تحويل',
          fromCurrency,
          toCurrency,
          amount,
          convertedAmount,
          rate,
          comment,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        db.collection('users').doc(currentUser.uid).collection('transactions').add(transaction);
        transactions.unshift({...transaction, timestamp: new Date()});
      }
      
      loadBalances();
      loadTransactions();
      showNotification('تم التحويل بنجاح');
      
      // مسح النموذج
      document.getElementById('transferAmount').value = '';
      document.getElementById('exchangeRate').value = '';
      document.getElementById('transferComment').value = '';
    }

    function performExpense() {
      const person = document.getElementById('expensePerson').value;
      const type = document.getElementById('expenseType').value;
      const amount = parseFloat(document.getElementById('expenseAmount').value);
      const currency = document.getElementById('expenseCurrency').value;
      const details = document.getElementById('expenseDetails').value;
      
      if (!person || !amount || amount <= 0) {
        showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
        return;
      }
      
      // تحديث الرصيد
      if (type === 'صادر') {
        if ((balances[currency] || 0) < amount) {
          showNotification('الرصيد غير كافي', 'error');
          return;
        }
        balances[currency] = (balances[currency] || 0) - amount;
      } else {
        balances[currency] = (balances[currency] || 0) + amount;
      }
      
      // حفظ في قاعدة البيانات
      if (currentUser) {
        db.collection('users').doc(currentUser.uid).collection('balances').doc(currency).set({
          amount: balances[currency]
        });
        
        // إضافة المعاملة
        const transaction = {
          type: `${type} - ${person}`,
          amount: type === 'صادر' ? -amount : amount,
          currency,
          details,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        db.collection('users').doc(currentUser.uid).collection('transactions').add(transaction);
        transactions.unshift({...transaction, timestamp: new Date()});
      }
      
      loadBalances();
      loadTransactions();
      showNotification('تم تسجيل العملية بنجاح');
      
      // مسح النموذج
      document.getElementById('expensePerson').value = '';
      document.getElementById('expenseAmount').value = '';
      document.getElementById('expenseDetails').value = '';
    }

    // دوال إدارة العملات
    function addCurrency() {
      const select = document.getElementById('currency-select');
      const currency = select.value;
      
      if (currencies.includes(currency)) {
        showNotification('العملة موجودة بالفعل', 'error');
        return;
      }
      
      currencies.push(currency);
      balances[currency] = 0;
      
      // حفظ في قاعدة البيانات
      if (currentUser) {
        db.collection('users').doc(currentUser.uid).collection('currencies').doc(currency).set({
          name: currency,
          added: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        db.collection('users').doc(currentUser.uid).collection('balances').doc(currency).set({
          amount: 0
        });
      }
      
      updateCurrencySelects();
      loadBalances();
      loadCurrenciesList();
      showNotification('تم إضافة العملة بنجاح');
    }

    function loadCurrenciesList() {
      const currenciesList = document.getElementById('currenciesList');
      if (!currenciesList) return;
      
      currenciesList.innerHTML = '';
      
      currencies.forEach(currency => {
        const currencyItem = document.createElement('div');
        currencyItem.className = 'balance-item';
        currencyItem.innerHTML = `
          <span>${currency}</span>
          <button type="button" class="btn-danger" style="width:auto;padding:5px 10px" onclick="removeCurrency('${currency}')">حذف</button>
        `;
        currenciesList.appendChild(currencyItem);
      });
    }

    function removeCurrency(currency) {
      if (currencies.length <= 1) {
        showNotification('يجب أن تبقى عملة واحدة على الأقل', 'error');
        return;
      }
      
      currencies = currencies.filter(c => c !== currency);
      delete balances[currency];
      
      // حذف من قاعدة البيانات
      if (currentUser) {
        db.collection('users').doc(currentUser.uid).collection('currencies').doc(currency).delete();
        db.collection('users').doc(currentUser.uid).collection('balances').doc(currency).delete();
      }
      
      updateCurrencySelects();
      loadBalances();
      loadCurrenciesList();
      showNotification('تم حذف العملة بنجاح');
    }

    // دوال إدارة الرصيد
    function updateBalance() {
      const currency = document.getElementById('balance-currency').value;
      const newBalance = parseFloat(document.getElementById('new-balance').value);
      
      if (isNaN(newBalance)) {
        showNotification('يرجى إدخال رصيد صحيح', 'error');
        return;
      }
      
      balances[currency] = newBalance;
      
      // حفظ في قاعدة البيانات
      if (currentUser) {
        db.collection('users').doc(currentUser.uid).collection('balances').doc(currency).set({
          amount: newBalance
        });
      }
      
      loadBalances();
      showNotification('تم تحديث الرصيد بنجاح');
      
      document.getElementById('new-balance').value = '';
      document.getElementById('current-balance').value = newBalance.toFixed(2);
    }

    // دوال أخرى
    function searchTransactions() {
      const searchTerm = document.getElementById('transactionSearch').value.toLowerCase();
      const filteredTransactions = transactions.filter(transaction => 
        transaction.type.toLowerCase().includes(searchTerm) ||
        (transaction.details && transaction.details.toLowerCase().includes(searchTerm))
      );
      
      const transactionsList = document.getElementById('transactionsList');
      if (!transactionsList) return;
      
      transactionsList.innerHTML = '';
      filteredTransactions.forEach(transaction => {
        const transactionItem = document.createElement('div');
        transactionItem.className = 'balance-item';
        transactionItem.innerHTML = `
          <div>
            <strong>${transaction.type}</strong><br>
            <small>${new Date(transaction.timestamp?.toDate ? transaction.timestamp.toDate() : transaction.timestamp).toLocaleString('ar')}</small>
          </div>
          <span>${transaction.amount} ${transaction.currency}</span>
        `;
        transactionsList.appendChild(transactionItem);
      });
    }

    function toggleRateMode() {
      // وظيفة لتبديل وضع سعر الصرف (ضرب/قسمة)
      const btn = document.getElementById('rateModeBtn');
      if (btn.textContent === '×') {
        btn.textContent = '÷';
      } else {
        btn.textContent = '×';
      }
    }

    function resetAllData() {
      if (!confirm('هل أنت متأكد من حذف جميع البيانات؟ هذا الإجراء لا يمكن التراجع عنه.')) {
        return;
      }
      
      // مسح البيانات المحلية
      currencies = ['USD'];
      balances = {USD: 0};
      transactions = [];
      clientDebts = {};
      
      // مسح البيانات من قاعدة البيانات
      if (currentUser) {
        // حذف جميع المجموعات
        const collections = ['currencies', 'balances', 'transactions', 'clientDebts'];
        collections.forEach(collection => {
          db.collection('users').doc(currentUser.uid).collection(collection).get()
            .then(querySnapshot => {
              querySnapshot.forEach(doc => {
                doc.ref.delete();
              });
            });
        });
        
        // إعادة تهيئة البيانات الافتراضية
        setTimeout(() => {
          initializeUserData();
        }, 1000);
      }
      
      updateCurrencySelects();
      loadBalances();
      loadTransactions();
      showNotification('تم مسح جميع البيانات بنجاح');
    }

    // دوال ديون العملاء (مبسطة)
    function toggleAddClient() {
      const section = document.getElementById('addClientSection');
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }

    function toggleRemoveClient() {
      const section = document.getElementById('removeClientSection');
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }

    function addClientDebt() {
      showNotification('ميزة ديون العملاء قيد التطوير');
    }

    function removeClientFromDropdown() {
      showNotification('ميزة ديون العملاء قيد التطوير');
    }

    function addOrUpdateClientDebt() {
      showNotification('ميزة ديون العملاء قيد التطوير');
    }

    // مراقبة حالة المصادقة
    auth.onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        loadUserData();
        showApp();
      } else {
        currentUser = null;
        showAuth();
      }
    });

    // تهيئة التطبيق عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', function() {
      // إضافة مستمعي الأحداث للنماذج
      document.getElementById('login-email').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          handleLogin();
        }
      });
      
      document.getElementById('login-password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          handleLogin();
        }
      });
      
      // تحديث الرصيد الحالي عند تغيير العملة
      const balanceCurrencySelect = document.getElementById('balance-currency');
      if (balanceCurrencySelect) {
        balanceCurrencySelect.addEventListener('change', function() {
          const currency = this.value;
          const currentBalance = balances[currency] || 0;
          document.getElementById('current-balance').value = currentBalance.toFixed(2);
        });
      }
      
      // تحميل قائمة العملات عند فتح صفحة إدارة العملات
      const currencySettingsPage = document.getElementById('currency-settings-page');
      if (currencySettingsPage) {
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
              if (currencySettingsPage.style.display === 'block') {
                loadCurrenciesList();
              }
            }
          });
        });
        observer.observe(currencySettingsPage, { attributes: true });
      }
    });
  </script>
</body>
</html>

