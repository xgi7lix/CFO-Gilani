<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>نظام الإدارة المالية المتقدم</title>

  <!-- خط -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <!-- أيقونات -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- html2canvas (للتصدير مستقبلاً إن احتجت) -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <!-- Chart.js للرسوم البيانية -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --primary:#2C786C;
      --secondary:#004445;
      --accent:#FFD166;
      --light:#f8f9fa;
      --dark:#333;
      --danger:#dc3545;
      --danger-hover:#c82333;
      --shadow:0 4px 6px rgba(0,0,0,.1);
      --t:all .25s ease;
      --success:#28a745;
      --success-hover:#218838;
    }

    /* الوضع المظلم */
    [data-theme="dark"] {
      --light:#1a1a1a;
      --dark:#f8f9fa;
      --shadow:0 4px 6px rgba(255,255,255,.1);
    }

    [data-theme="dark"] body {
      background:var(--light);
      color:var(--dark);
    }

    [data-theme="dark"] .main-card,
    [data-theme="dark"] .page,
    [data-theme="dark"] .auth-box,
    [data-theme="dark"] .balance-item,
    [data-theme="dark"] .debt-record,
    [data-theme="dark"] .modal-content {
      background:#2d2d2d;
      color:var(--dark);
      border-color:#444;
    }

    [data-theme="dark"] input,
    [data-theme="dark"] select,
    [data-theme="dark"] textarea {
      background:#2d2d2d;
      color:var(--dark);
      border-color:#444;
    }

    [data-theme="dark"] .debt-records-container {
      background:#2d2d2d;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Tajawal',sans-serif;
      background:var(--light);
      color:var(--dark);
      line-height:1.6;
      transition:var(--t);
    }

    /* رأس */
    header{
      background:var(--primary);
      color:#fff;
      box-shadow:var(--shadow);
    }
    #main-header{padding:16px 0;position:relative}
    #main-header h1{margin:0;font-size:1.4rem;text-align:center}
    #page-header{display:none;align-items:center;gap:12px;padding:10px 12px}
    #page-title{margin:0;font-size:1.1rem}

    /* أزرار التحكم في الرأس */
    .header-controls {
      position:absolute;
      top:50%;
      right:20px;
      transform:translateY(-50%);
      display:flex;
      gap:10px;
    }

    .header-btn {
      background:rgba(255,255,255,.2);
      border:none;
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-size:14px;
      transition:var(--t);
    }

    .header-btn:hover {
      background:rgba(255,255,255,.3);
    }

    /* حاوية */
    .container{max-width:1100px;margin:0 auto;padding:14px}

    /* شبكة البطاقات */
    .main-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
    @media(min-width:768px){.main-grid{grid-template-columns:repeat(3,1fr)}}
    .main-card{
      background:#fff;border:2px solid var(--primary);border-radius:12px;
      padding:18px;text-align:center;cursor:pointer;transition:var(--t);
      min-height:120px;display:flex;flex-direction:column;justify-content:center;align-items:center
    }
    .main-card i{font-size:28px;color:var(--primary);margin-bottom:8px}
    .main-card:hover{transform:translateY(-4px);background:var(--primary);color:#fff}
    .main-card:hover i{color:#fff}

    /* الصفحات */
    .page{display:none;background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:14px;margin-top:14px}
    .active-page{display:block}
    .page-header{display:flex;align-items:center;gap:8px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #eee}
    .page-header i{color:var(--primary)}

    /* عناصر نموذج */
    .form-row{margin-bottom:12px}
    label{display:block;margin-bottom:6px;font-weight:700}
    input,select,textarea,button{
      width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-family:'Tajawal',sans-serif;font-size:14px;transition:var(--t)
    }
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(44,120,108,.15)}
    textarea{resize:vertical}
    button{cursor:pointer;background:var(--primary);color:#fff;border:none;font-weight:700;transition:var(--t)}
    button:hover{background:var(--secondary)}
    .btn-danger{background:var(--danger)}
    .btn-danger:hover{background:var(--danger-hover)}
    .btn-success{background:var(--success)}
    .btn-success:hover{background:var(--success-hover)}
    .btn-wide{display:block;width:100%;padding:14px;margin:10px 0;text-align:right}

    .balance-item{padding:10px;margin:6px 0;background:#f7f7f8;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
    .debt-records-container{padding:8px;background:#f7f7f8;border-radius:8px;max-height:300px;overflow:auto}
    .debt-record{padding:8px;margin:6px 0;background:#fff;border:1px solid #eee;border-radius:8px}

    /* توست محسن */
    .notification{
      position:fixed;top:20px;left:50%;transform:translateX(-50%);
      background:var(--success);color:#fff;padding:12px 20px;border-radius:8px;z-index:9999;
      box-shadow:var(--shadow);display:flex;align-items:center;gap:8px;
      animation:slideDown 0.3s ease-out;
    }
    .notification.error{background:var(--danger)}
    .notification.warning{background:#ffc107;color:#000}
    .notification.info{background:#17a2b8}

    @keyframes slideDown {
      from { transform:translateX(-50%) translateY(-100%); opacity:0; }
      to { transform:translateX(-50%) translateY(0); opacity:1; }
    }

    /* مصادقة */
    #auth-container{min-height:100vh;display:flex;justify-content:center;align-items:center;padding:16px}
    .auth-box{background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:22px;max-width:400px;width:100%}
    .auth-box h2{margin:0 0 14px;color:var(--primary)}
    .auth-switch{margin-top:12px;text-align:center}
    .auth-switch a{color:var(--primary);cursor:pointer;font-weight:700}
    .auth-switch a:hover{text-decoration:underline}
    .google-btn{background:#4285F4}
    .google-btn:hover{background:#357ae8}
    .or-sep{margin:14px 0;text-align:center;color:#999}

    /* لودر */
    .loader{
      display:none;border:4px solid #eee;border-top:4px solid var(--primary);
      border-radius:50%;width:28px;height:28px;margin:10px auto;animation:spin 1s linear infinite
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* زر رجوع */
    .back-button{background:rgba(255,255,255,.2);border:none;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}

    /* فلاتر البحث المختصرة */
    .compact-filters {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #e9ecef;
    }

    .filter-toggle-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      transition: var(--t);
    }

    .filter-toggle-btn:hover {
      background: var(--secondary);
    }

    .filter-toggle-btn i:last-child {
      transition: transform 0.3s ease;
    }

    .filter-toggle-btn.active i:last-child {
      transform: rotate(180deg);
    }

    .quick-filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .compact-select, .compact-input, .compact-date, .compact-number {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      min-width: 100px;
      height: 32px;
    }

    .compact-select {
      min-width: 120px;
    }

    .compact-input {
      min-width: 150px;
      flex: 1;
    }

    .compact-date, .compact-number {
      min-width: 110px;
    }

    .clear-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      height: 32px;
      min-width: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .clear-btn:hover {
      background: #c82333;
    }

    .advanced-filters {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e9ecef;
      display: none;
    }

    .advanced-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
    }

    .advanced-group {
      display: flex;
      flex-direction: column;
    }

    .advanced-group label {
      font-size: 11px;
      margin-bottom: 4px;
      color: #666;
      font-weight: 500;
    }

    /* تحسينات الاستجابة للفلاتر المختصرة */
    @media (max-width: 768px) {
      .quick-filters {
        flex-direction: column;
        align-items: stretch;
      }

      .compact-select, .compact-input, .compact-date, .compact-number {
        min-width: auto;
        width: 100%;
      }

      .advanced-row {
        grid-template-columns: 1fr;
      }
    }

    /* الأنماط القديمة للفلاتر */
    .search-filters {
      background:#f8f9fa;
      border-radius:8px;
      padding:15px;
      margin-bottom:15px;
      border:1px solid #e9ecef;
    }

    .filter-row {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:10px;
      margin-bottom:10px;
    }

    .filter-group {
      display:flex;
      flex-direction:column;
    }

    .filter-group label {
      font-size:12px;
      margin-bottom:4px;
      color:#666;
    }

    /* إحصائيات */
    .stats-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:15px;
      margin-bottom:20px;
    }

    .stat-card {
      background:#fff;
      border-radius:8px;
      padding:15px;
      box-shadow:var(--shadow);
      text-align:center;
      border-left:4px solid var(--primary);
    }

    .stat-value {
      font-size:24px;
      font-weight:700;
      color:var(--primary);
      margin-bottom:5px;
    }

    .stat-label {
      font-size:14px;
      color:#666;
    }

    /* رسم بياني */
    .chart-container {
      background:#fff;
      border-radius:8px;
      padding:20px;
      box-shadow:var(--shadow);
      margin-bottom:20px;
    }

    .chart-title {
      font-size:18px;
      font-weight:700;
      margin-bottom:15px;
      color:var(--primary);
    }

    /* تبويبات */
    .tabs {
      border-bottom:2px solid #e9ecef;
      margin-bottom:20px;
    }

    .tab-buttons {
      display:flex;
      gap:0;
    }

    .tab-button {
      background:none;
      border:none;
      padding:12px 20px;
      cursor:pointer;
      border-bottom:3px solid transparent;
      transition:var(--t);
      font-weight:600;
    }

    .tab-button.active {
      color:var(--primary);
      border-bottom-color:var(--primary);
    }

    .tab-content {
      display:none;
    }

    .tab-content.active {
      display:block;
    }

    /* مؤشر النسخ الاحتياطي */
    .backup-indicator {
      position:fixed;
      bottom:20px;
      right:20px;
      background:var(--success);
      color:#fff;
      padding:8px 12px;
      border-radius:20px;
      font-size:12px;
      display:flex;
      align-items:center;
      gap:5px;
      z-index:1000;
      transition:var(--t);
    }

    .backup-indicator.syncing {
      background:#ffc107;
      color:#000;
    }

    .backup-indicator.error {
      background:var(--danger);
    }

    .backup-indicator i {
      animation:none;
    }

    .backup-indicator.syncing i {
      animation:spin 1s linear infinite;
    }

    /* تحسينات الاستجابة */
    @media (max-width: 768px) {
      .header-controls {
        position:static;
        transform:none;
        justify-content:center;
        margin-top:10px;
      }

      .filter-row {
        grid-template-columns:1fr;
      }

      .stats-grid {
        grid-template-columns:1fr;
      }

      .tab-buttons {
        flex-wrap:wrap;
      }

      .tab-button {
        flex:1;
        min-width:120px;
      }
    }

    /* أزرار إدارة الرصيد */
    .balance-controls {
      display:flex;
      gap:10px;
      margin-top:15px;
    }

    .balance-controls button {
      flex:1;
      padding:8px 12px;
      font-size:12px;
    }

    /* إصلاح النافذة المنبثقة */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      box-shadow: var(--shadow);
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .modal-buttons button {
      flex: 1;
    }

    /* قائمة المعاملات */
    .transaction-item {
      background: #fff;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--t);
    }

    .transaction-item:hover {
      box-shadow: var(--shadow);
    }

    .transaction-info {
      flex: 1;
    }

    .transaction-type {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .transaction-type.income {
      color: var(--success);
    }

    .transaction-type.expense {
      color: var(--danger);
    }

    .transaction-type.transfer {
      color: var(--primary);
    }

    .transaction-description {
      font-size: 12px;
      color: #666;
      margin-bottom: 2px;
    }

    .transaction-date {
      font-size: 11px;
      color: #999;
    }

    .transaction-amount {
      font-weight: 700;
      font-size: 16px;
    }

    .transaction-actions {
      display: flex;
      gap: 5px;
      margin-left: 10px;
    }

    .transaction-actions button {
      width: auto;
      padding: 4px 8px;
      font-size: 11px;
      min-width: 30px;
    }

    /* صفحة معلومات الحساب */
    .account-info-section {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    .account-info-section h3 {
      margin: 0 0 15px 0;
      color: var(--primary);
      border-bottom: 2px solid var(--primary);
      padding-bottom: 8px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-weight: 600;
      color: #666;
    }

    .info-value {
      font-weight: 700;
      color: var(--dark);
    }

    /* تحسينات إضافية للاستجابة */
    @media (max-width: 480px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
      
      .transaction-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .transaction-actions {
        margin-left: 0;
        width: 100%;
        justify-content: flex-end;
      }
    }

  </style>
</head>
<body data-theme="light">

  <!-- مؤشر النسخ الاحتياطي -->
  <div id="backup-indicator" class="backup-indicator" style="display:none">
    <i class="fas fa-cloud"></i>
    <span id="backup-text">تم الحفظ</span>
  </div>

  <!-- واجهة المصادقة -->
  <div id="auth-container">
    <div class="auth-box">
      <!-- تسجيل الدخول -->
      <div id="login-form">
        <h2>تسجيل الدخول</h2>
        <div class="form-row">
          <label for="login-email">البريد الإلكتروني</label>
          <input type="email" id="login-email" placeholder="email@example.com" required>
        </div>
        <div class="form-row">
          <label for="login-password">كلمة المرور</label>
          <input type="password" id="login-password" placeholder="********" required>
        </div>
        <div class="form-row" style="display: flex; align-items: center; gap: 8px; margin: 10px 0;">
          <input type="checkbox" id="remember-me" style="width: auto; margin: 0;">
          <label for="remember-me" style="margin: 0; font-weight: normal; cursor: pointer;">حفظ تسجيل الدخول</label>
        </div>
        <div class="form-row" style="text-align:left;margin:-6px 0 10px">
          <a href="#" id="forgot-password-link" class="auth-switch">نسيت كلمة المرور؟</a>
        </div>
        <button type="button" id="login-btn">تسجيل الدخول</button>
        <div class="loader" id="login-loader"></div>

        <div class="or-sep">أو</div>

        <button type="button" class="google-btn" id="google-login-btn">
          <i class="fab fa-google"></i> المتابعة باستخدام Google
        </button>
        <div class="loader" id="google-loader"></div>

        <p class="auth-switch">ليس لديك حساب؟ <a href="#" id="show-signup-link">إنشاء حساب جديد</a></p>
      </div>

      <!-- إنشاء حساب -->
      <div id="signup-form" style="display:none">
        <h2>إنشاء حساب جديد</h2>
        <div class="form-row">
          <label for="signup-firstname">الاسم الأول</label>
          <input id="signup-firstname" type="text" placeholder="مثال: أحمد" required>
        </div>
        <div class="form-row">
          <label for="signup-lastname">الاسم الأخير</label>
          <input id="signup-lastname" type="text" placeholder="مثال: محمد" required>
        </div>
        <div class="form-row">
          <label for="signup-email">البريد الإلكتروني</label>
          <input id="signup-email" type="email" placeholder="email@example.com" required>
        </div>
        <div class="form-row">
          <label for="signup-password">كلمة المرور</label>
          <input id="signup-password" type="password" placeholder="حرف كبير، صغير، رقم، رمز خاص" required>
          <div id="password-requirements" style="font-size:12px;color:#666;margin-top:4px;display:none">
            <div>• حرف كبير واحد على الأقل (A-Z)</div>
            <div>• حرف صغير واحد على الأقل (a-z)</div>
            <div>• رقم واحد على الأقل (0-9)</div>
            <div>• رمز خاص واحد على الأقل ($&#@!%*?&)</div>
            <div>• 8 أحرف على الأقل</div>
          </div>
        </div>
        <button type="button" id="signup-btn">إنشاء حساب</button>
        <div class="loader" id="signup-loader"></div>

        <div class="or-sep">أو</div>

        <button type="button" class="google-btn" id="google-signup-btn">
          <i class="fab fa-google"></i> المتابعة باستخدام Google
        </button>
        <div class="loader" id="google-loader-signup"></div>

        <p class="auth-switch">لديك حساب بالفعل؟ <a href="#" id="show-login-link">تسجيل الدخول</a></p>
      </div>
    </div>
  </div>

  <!-- التطبيق -->
  <div id="app-container" style="display:none">
    <!-- رأس رئيسي -->
    <header>
      <div id="main-header">
        <h1><i class="fas fa-wallet"></i> نظام الإدارة المالية المتقدم</h1>
        <div class="header-controls">
          <button class="header-btn" id="theme-toggle-btn">
            <i class="fas fa-moon" id="theme-icon"></i>
          </button>
          <button class="header-btn" id="language-toggle-btn">EN</button>
          <button class="header-btn" id="logout-btn">خروج</button>
        </div>
      </div>
      <div id="page-header">
        <button class="back-button" id="back-to-main-btn">رجوع</button>
        <h2 id="page-title">الصفحة</h2>
      </div>
    </header>

    <div class="container">
      <!-- القائمة الرئيسية -->
      <div id="main-menu">
        <div class="main-grid">
          <div class="main-card" data-page="balance">
            <i class="fas fa-wallet"></i>
            <div>كشف الحساب</div>
          </div>
          <div class="main-card" data-page="transfers">
            <i class="fas fa-right-left"></i>
            <div>التحويلات</div>
          </div>
          <div class="main-card" data-page="income-expense">
            <i class="fas fa-dollar-sign"></i>
            <div>الصادر والوارد</div>
          </div>
          <div class="main-card" data-page="debts">
            <i class="fas fa-handshake"></i>
            <div>الديون</div>
          </div>
          <div class="main-card" data-page="transactions">
            <i class="fas fa-list"></i>
            <div>كل المعاملات</div>
          </div>
          <div class="main-card" data-page="settings">
            <i class="fas fa-cog"></i>
            <div>الإعدادات</div>
          </div>
        </div>
      </div>

      <!-- صفحة كشف الحساب -->
      <div id="balance" class="page">
        <div class="page-header"><i class="fas fa-wallet"></i><h2 id="balance-header">كشف الحساب</h2></div>
        <div id="balance-list"></div>
        <div class="balance-controls">
          <button class="btn-success" onclick="openBalanceModal('add')">إضافة رصيد</button>
          <button class="btn-danger" onclick="openBalanceModal('subtract')">خصم رصيد</button>
        </div>
      </div>

      <!-- صفحة التحويلات -->
      <div id="transfers" class="page">
        <div class="page-header"><i class="fas fa-right-left"></i><h2 id="transfers-header">التحويلات</h2></div>
        <div class="form-row">
          <label for="fromCurrency">من العملة</label>
          <select id="fromCurrency">
            <option value="SDG">جنيه سوداني (SDG)</option>
            <option value="USD">دولار أمريكي (USD)</option>
            <option value="EUR">يورو (EUR)</option>
          </select>
        </div>
        <div class="form-row">
          <label for="toCurrency">إلى العملة</label>
          <select id="toCurrency">
            <option value="SDG">جنيه سوداني (SDG)</option>
            <option value="USD">دولار أمريكي (USD)</option>
            <option value="EUR">يورو (EUR)</option>
          </select>
        </div>
        <div class="form-row">
          <label for="transferAmount">المبلغ</label>
          <input type="number" id="transferAmount" placeholder="0.00" step="0.01" min="0">
        </div>
        <div class="form-row">
          <label for="exchangeRate">سعر الصرف</label>
          <input type="number" id="exchangeRate" placeholder="1.00" step="0.01" min="0">
        </div>
        <div class="form-row">
          <label for="operationType">العملية</label>
          <select id="operationType">
            <option value="multiply">ضرب (×)</option>
            <option value="divide">قسمة (÷)</option>
          </select>
        </div>
        <button id="process-transfer-btn">تحويل</button>
      </div>

      <!-- صفحة الصادر والوارد -->
      <div id="income-expense" class="page">
        <div class="page-header"><i class="fas fa-dollar-sign"></i><h2 id="income-expense-header">الصادر والوارد</h2></div>
        <div class="form-row">
          <label for="transactionType">نوع المعاملة</label>
          <select id="transactionType">
            <option value="income">وارد</option>
            <option value="expense">صادر</option>
          </select>
        </div>
        <div class="form-row">
          <label for="transactionAmount">المبلغ</label>
          <input type="number" id="transactionAmount" placeholder="0.00" step="0.01" min="0">
        </div>
        <div class="form-row">
          <label for="transactionCurrency">العملة</label>
          <select id="transactionCurrency">
            <option value="SDG">جنيه سوداني (SDG)</option>
            <option value="USD">دولار أمريكي (USD)</option>
            <option value="EUR">يورو (EUR)</option>
          </select>
        </div>
        <div class="form-row">
          <label for="transactionDescription">الوصف</label>
          <input type="text" id="transactionDescription" placeholder="وصف المعاملة">
        </div>
        <button id="add-transaction-btn">إضافة معاملة</button>
      </div>

      <!-- صفحة الديون -->
      <div id="debts" class="page">
        <div class="page-header"><i class="fas fa-handshake"></i><h2 id="debts-header">الديون</h2></div>
        
        <div class="form-row">
          <label for="debtType">نوع الدين</label>
          <select id="debtType">
            <option value="owed_to_me">له</option>
            <option value="i_owe">عليه</option>
          </select>
        </div>
        
        <div class="form-row">
          <label for="debtPerson">اسم الشخص</label>
          <input type="text" id="debtPerson" placeholder="اسم المدين أو الدائن">
        </div>
        
        <div class="form-row">
          <label for="debtAmount">المبلغ</label>
          <input type="number" id="debtAmount" placeholder="0.00" step="0.01" min="0">
        </div>
        
        <div class="form-row">
          <label for="debtCurrency">العملة</label>
          <select id="debtCurrency">
            <option value="SDG">جنيه سوداني (SDG)</option>
            <option value="USD">دولار أمريكي (USD)</option>
            <option value="EUR">يورو (EUR)</option>
          </select>
        </div>
        
        <div class="form-row">
          <label for="debtDescription">الوصف</label>
          <input type="text" id="debtDescription" placeholder="وصف الدين">
        </div>
        
        <div class="form-row">
          <label for="debtDate">تاريخ الدين</label>
          <input type="date" id="debtDate">
        </div>
        
        <button id="add-debt-btn">إضافة دين</button>
        
        <div id="debts-list" class="debt-records-container" style="margin-top: 20px;">
          <!-- سيتم عرض الديون هنا -->
        </div>
      </div>

      <!-- صفحة كل المعاملات -->
      <div id="transactions" class="page">
        <div class="page-header"><i class="fas fa-list"></i><h2 id="transactions-header">كل المعاملات</h2></div>
        
        <!-- فلاتر البحث المختصرة -->
        <div class="compact-filters">
          <button class="filter-toggle-btn" id="filter-toggle-btn">
            <i class="fas fa-filter"></i>
            <span>فلترة</span>
            <i class="fas fa-chevron-down" id="filter-chevron"></i>
          </button>
          
          <div class="quick-filters">
            <select id="filter-type" class="compact-select">
              <option value="">كل الأنواع</option>
              <option value="income">وارد</option>
              <option value="expense">صادر</option>
              <option value="transfer">تحويل</option>
              <option value="debt">دين</option>
            </select>
            
            <select id="filter-currency" class="compact-select">
              <option value="">كل العملات</option>
              <option value="SDG">SDG</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
            </select>
            
            <input type="text" id="filter-description" placeholder="بحث..." class="compact-input">
            
            <button class="clear-btn" id="clear-filters-btn" title="مسح الفلاتر">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <div class="advanced-filters" id="advanced-filters">
            <div class="advanced-row">
              <div class="advanced-group">
                <label>من تاريخ</label>
                <input type="date" id="filter-date-from" class="compact-date">
              </div>
              <div class="advanced-group">
                <label>إلى تاريخ</label>
                <input type="date" id="filter-date-to" class="compact-date">
              </div>
              <div class="advanced-group">
                <label>المبلغ من</label>
                <input type="number" id="filter-amount-min" placeholder="0" step="0.01" class="compact-number">
              </div>
              <div class="advanced-group">
                <label>المبلغ إلى</label>
                <input type="number" id="filter-amount-max" placeholder="∞" step="0.01" class="compact-number">
              </div>
            </div>
          </div>
        </div>

        <div id="transactions-list"></div>
      </div>

      <!-- صفحة الإحصائيات -->
      <div id="statistics" class="page">
        <div class="page-header"><i class="fas fa-chart-bar"></i><h2 id="statistics-header">الإحصائيات</h2></div>
        
        <!-- بطاقات الإحصائيات -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="total-income">0</div>
            <div class="stat-label">إجمالي الوارد</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="total-expense">0</div>
            <div class="stat-label">إجمالي الصادر</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="net-balance">0</div>
            <div class="stat-label">الرصيد الصافي</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="transaction-count">0</div>
            <div class="stat-label">عدد المعاملات</div>
          </div>
        </div>

        <!-- الرسم البياني -->
        <div class="chart-container">
          <div class="chart-title">الوارد والصادر الشهري</div>
          <canvas id="monthly-chart" width="400" height="200"></canvas>
        </div>

        <!-- رسم بياني للعملات -->
        <div class="chart-container">
          <div class="chart-title">توزيع الأرصدة حسب العملة</div>
          <canvas id="currency-chart" width="400" height="200"></canvas>
        </div>
      </div>

      <!-- صفحة معلومات الحساب -->
      <div id="account-info" class="page">
        <div class="page-header"><i class="fas fa-user"></i><h2>معلومات الحساب</h2></div>
        
        <div class="account-info-section">
          <h3><i class="fas fa-user-circle"></i> المعلومات الشخصية</h3>
          <div class="info-row">
            <span class="info-label">الاسم:</span>
            <span class="info-value" id="user-display-name">غير محدد</span>
          </div>
          <div class="info-row">
            <span class="info-label">البريد الإلكتروني:</span>
            <span class="info-value" id="user-email-display">غير محدد</span>
          </div>
          <div class="info-row">
            <span class="info-label">تاريخ إنشاء الحساب:</span>
            <span class="info-value" id="user-creation-date">غير محدد</span>
          </div>
          <div class="info-row">
            <span class="info-label">آخر تسجيل دخول:</span>
            <span class="info-value" id="user-last-login">غير محدد</span>
          </div>
        </div>

        <div class="account-info-section">
          <h3><i class="fas fa-edit"></i> تحديث المعلومات</h3>
          <div class="form-row">
            <label for="update-display-name">الاسم الكامل</label>
            <input type="text" id="update-display-name" placeholder="الاسم الكامل">
          </div>
          <div class="form-row">
            <label for="update-password">كلمة مرور جديدة (اختياري)</label>
            <input type="password" id="update-password" placeholder="كلمة مرور جديدة">
          </div>
          <button id="update-profile-btn">تحديث المعلومات</button>
        </div>

        <div class="account-info-section">
          <h3><i class="fas fa-chart-pie"></i> إحصائيات الحساب</h3>
          <div class="info-row">
            <span class="info-label">إجمالي المعاملات:</span>
            <span class="info-value" id="account-total-transactions">0</span>
          </div>
          <div class="info-row">
            <span class="info-label">العملات المستخدمة:</span>
            <span class="info-value" id="account-currencies-count">0</span>
          </div>
          <div class="info-row">
            <span class="info-label">آخر نشاط:</span>
            <span class="info-value" id="account-last-activity">غير محدد</span>
          </div>
        </div>
      </div>

      <!-- صفحة الإعدادات -->
      <div id="settings" class="page">
        <div class="page-header"><i class="fas fa-cog"></i><h2 id="settings-header">الإعدادات</h2></div>
        
        <!-- أزرار الإعدادات المتتالية -->
        <div style="display: flex; flex-direction: column; gap: 15px;">
          
          <!-- 1. اللغة -->
          <button class="btn-wide" id="language-settings-btn" style="background: var(--primary); display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-language"></i>
              <span>اللغة</span>
            </div>
            <span style="font-size: 12px; opacity: 0.8;" id="current-language-display">العربية</span>
          </button>

          <!-- 2. الوضع الداكن -->
          <button class="btn-wide" id="theme-settings-btn" style="background: var(--secondary); display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-moon" id="settings-theme-icon"></i>
              <span>الوضع الداكن</span>
            </div>
            <span style="font-size: 12px; opacity: 0.8;" id="theme-status">فاتح</span>
          </button>

          <!-- 3. الإحصائيات -->
          <button class="btn-wide" id="statistics-btn" style="background: #17a2b8; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-chart-bar"></i>
              <span>الإحصائيات</span>
            </div>
            <i class="fas fa-chevron-left" style="font-size: 12px;"></i>
          </button>

          <!-- 4. معلومات الحساب -->
          <button class="btn-wide" id="account-info-btn" style="background: #6f42c1; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-user"></i>
              <span>معلومات الحساب</span>
            </div>
            <i class="fas fa-chevron-left" style="font-size: 12px;"></i>
          </button>

          <!-- 5. إدارة العملات -->
          <button class="btn-wide" id="manage-currencies-btn" style="background: #fd7e14; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-coins"></i>
              <span>إدارة العملات</span>
            </div>
            <i class="fas fa-chevron-left" style="font-size: 12px;"></i>
          </button>

          <!-- 6. تصدير البيانات -->
          <button class="btn-wide" id="export-data-btn" style="background: #28a745; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-download"></i>
              <span>تصدير البيانات</span>
            </div>
            <i class="fas fa-chevron-left" style="font-size: 12px;"></i>
          </button>

          <!-- 7. حذف جميع البيانات -->
          <button class="btn-wide btn-danger" id="reset-data-btn" style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-trash"></i>
              <span>حذف جميع البيانات</span>
            </div>
            <i class="fas fa-exclamation-triangle" style="font-size: 12px;"></i>
          </button>

        </div>
      </div>

      <!-- صفحة إدارة العملات -->
      <div id="manage-currencies" class="page">
        <div class="page-header"><i class="fas fa-coins"></i><h2>إدارة العملات</h2></div>
        
        <div class="form-row">
          <label for="new-currency-code">رمز العملة الجديدة</label>
          <input type="text" id="new-currency-code" placeholder="مثال: SAR" maxlength="3" style="text-transform: uppercase;">
        </div>
        <div class="form-row">
          <label for="new-currency-name">اسم العملة</label>
          <input type="text" id="new-currency-name" placeholder="مثال: ريال سعودي">
        </div>
        <button id="add-currency-btn">إضافة عملة</button>
        
        <div id="currencies-list" style="margin-top: 20px;">
          <!-- سيتم عرض العملات هنا -->
        </div>
      </div>

    </div>
  </div>

  <!-- نافذة منبثقة لإدارة الرصيد -->
  <div id="balance-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 id="balance-modal-title">إدارة الرصيد</h3>
      <div class="form-row">
        <label for="balance-currency">العملة</label>
        <select id="balance-currency"></select>
      </div>
      <div class="form-row">
        <label for="balance-amount">المبلغ</label>
        <input type="number" id="balance-amount" placeholder="0.00" step="0.01" min="0">
      </div>
      <div class="form-row">
        <label for="balance-description">الوصف (اختياري)</label>
        <input type="text" id="balance-description" placeholder="وصف العملية">
      </div>
      <div class="modal-buttons">
        <button onclick="closeBalanceModal()">إلغاء</button>
        <button id="balance-confirm-btn" onclick="processBalanceChange()">تأكيد</button>
      </div>
    </div>
  </div>

  <!-- نافذة منبثقة للتأكيد -->
  <div id="confirm-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 id="confirm-modal-title">تأكيد العملية</h3>
      <p id="confirm-modal-message">هل أنت متأكد من هذه العملية؟</p>
      <div class="modal-buttons">
        <button onclick="closeConfirmModal()">إلغاء</button>
        <button id="confirm-modal-btn" class="btn-danger">تأكيد</button>
      </div>
    </div>
  </div>

  <script>
    // إعدادات Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyD7eKVMk4-lZ48_3n88fsextFrziqiK-Mw",
      authDomain: "gilani-financial.firebaseapp.com",
      projectId: "gilani-financial",
      storageBucket: "gilani-financial.firebasestorage.app",
      messagingSenderId: "685744108797",
      appId: "1:685744108797:web:2feddfaf3f04d6028b7a94",
      measurementId: "G-1XDCKR6E5F"
    };

    // تهيئة Firebase
    let app, auth, db;
    let firebaseInitialized = false;
    
    try {
      app = firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
      firebaseInitialized = true;
      console.log('Firebase initialized successfully');
    } catch (error) {
      console.error('Firebase initialization failed:', error);
      firebaseInitialized = false;
    }

    // متغيرات عامة
    let currentUser = null;
    let currentLanguage = 'ar';
    let currencies = ['SDG', 'USD', 'EUR'];
    let defaultCurrency = 'SDG';
    let balances = { SDG: 0, USD: 0, EUR: 0 };
    let transactions = [];
    let debts = [];
    let filteredTransactions = [];
    let currentBalanceAction = '';
    let monthlyChart = null;
    let currencyChart = null;

    // النصوص متعددة اللغات
    const translations = {
      ar: {
        title: 'نظام الإدارة المالية المتقدم',
        login: 'تسجيل الدخول',
        signup: 'إنشاء حساب جديد',
        email: 'البريد الإلكتروني',
        password: 'كلمة المرور',
        balance: 'كشف الحساب',
        transfers: 'التحويلات',
        incomeExpense: 'الصادر والوارد',
        debts: 'الديون',
        transactions: 'كل المعاملات',
        settings: 'الإعدادات',
        statistics: 'الإحصائيات',
        accountInfo: 'معلومات الحساب',
        logout: 'خروج',
        back: 'رجوع',
        save: 'حفظ',
        cancel: 'إلغاء',
        confirm: 'تأكيد',
        delete: 'حذف',
        edit: 'تعديل',
        add: 'إضافة',
        currency: 'العملة',
        amount: 'المبلغ',
        description: 'الوصف',
        date: 'التاريخ',
        type: 'النوع',
        income: 'وارد',
        expense: 'صادر',
        transfer: 'تحويل',
        debt: 'دين',
        totalIncome: 'إجمالي الوارد',
        totalExpense: 'إجمالي الصادر',
        netBalance: 'الرصيد الصافي',
        transactionCount: 'عدد المعاملات',
        language: 'اللغة',
        theme: 'الوضع الداكن',
        light: 'فاتح',
        dark: 'مظلم',
        exportData: 'تصدير البيانات',
        resetData: 'حذف جميع البيانات',
        manageCurrencies: 'إدارة العملات',
        addCurrency: 'إضافة عملة',
        currencyCode: 'رمز العملة',
        currencyName: 'اسم العملة',
        addBalance: 'إضافة رصيد',
        subtractBalance: 'خصم رصيد',
        processTransfer: 'تحويل',
        addTransaction: 'إضافة معاملة',
        addDebt: 'إضافة دين',
        filter: 'فلترة',
        search: 'بحث',
        clearFilters: 'مسح الفلاتر',
        allTypes: 'كل الأنواع',
        allCurrencies: 'كل العملات',
        fromDate: 'من تاريخ',
        toDate: 'إلى تاريخ',
        minAmount: 'المبلغ من',
        maxAmount: 'المبلغ إلى',
        owedToMe: 'له',
        iOwe: 'عليه',
        personName: 'اسم الشخص',
        debtDate: 'تاريخ الدين',
        fromCurrency: 'من العملة',
        toCurrency: 'إلى العملة',
        exchangeRate: 'سعر الصرف',
        operationType: 'العملية',
        multiply: 'ضرب (×)',
        divide: 'قسمة (÷)',
        updateProfile: 'تحديث المعلومات',
        displayName: 'الاسم الكامل',
        newPassword: 'كلمة مرور جديدة',
        personalInfo: 'المعلومات الشخصية',
        accountStats: 'إحصائيات الحساب',
        creationDate: 'تاريخ إنشاء الحساب',
        lastLogin: 'آخر تسجيل دخول',
        totalTransactions: 'إجمالي المعاملات',
        currenciesUsed: 'العملات المستخدمة',
        lastActivity: 'آخر نشاط',
        notSpecified: 'غير محدد',
        monthlyChart: 'الوارد والصادر الشهري',
        currencyDistribution: 'توزيع الأرصدة حسب العملة',
        dataExported: 'تم تصدير البيانات بنجاح',
        dataReset: 'تم حذف جميع البيانات بنجاح',
        currencyAdded: 'تم إضافة العملة بنجاح',
        currencyRemoved: 'تم حذف العملة بنجاح',
        balanceUpdated: 'تم تحديث الرصيد بنجاح',
        transactionAdded: 'تم إضافة المعاملة بنجاح',
        debtAdded: 'تم إضافة الدين بنجاح',
        transferCompleted: 'تم التحويل بنجاح',
        profileUpdated: 'تم تحديث المعلومات بنجاح',
        languageChanged: 'تم تغيير اللغة إلى العربية',
        themeChanged: 'تم تغيير الوضع',
        loginSuccess: 'تم تسجيل الدخول بنجاح',
        signupSuccess: 'تم إنشاء الحساب بنجاح',
        logoutSuccess: 'تم تسجيل الخروج بنجاح',
        error: 'خطأ',
        success: 'نجح',
        warning: 'تحذير',
        info: 'معلومات',
        loading: 'جاري التحميل...',
        saving: 'جاري الحفظ...',
        saved: 'تم الحفظ',
        syncing: 'جاري المزامنة...',
        syncError: 'خطأ في المزامنة',
        fillAllFields: 'يرجى ملء جميع الحقول المطلوبة',
        invalidEmail: 'يرجى إدخال بريد إلكتروني صحيح',
        weakPassword: 'كلمة المرور ضعيفة جداً',
        passwordRequirements: 'كلمة المرور يجب أن تحتوي على: حرف كبير، حرف صغير، رقم، رمز خاص، وأن تكون 8 أحرف على الأقل',
        confirmDelete: 'هل أنت متأكد من حذف هذا العنصر؟',
        confirmReset: 'هل أنت متأكد من حذف جميع البيانات؟',
        noTransactions: 'لا توجد معاملات',
        noDebts: 'لا توجد ديون',
        noData: 'لا توجد بيانات',
        rememberMe: 'حفظ تسجيل الدخول',
        forgotPassword: 'نسيت كلمة المرور؟',
        alreadyHaveAccount: 'لديك حساب بالفعل؟',
        dontHaveAccount: 'ليس لديك حساب؟',
        continueWithGoogle: 'المتابعة باستخدام Google',
        or: 'أو'
      },
      en: {
        title: 'Advanced Financial Management System',
        login: 'Login',
        signup: 'Sign Up',
        email: 'Email',
        password: 'Password',
        balance: 'Account Balance',
        transfers: 'Transfers',
        incomeExpense: 'Income & Expense',
        debts: 'Debts',
        transactions: 'All Transactions',
        settings: 'Settings',
        statistics: 'Statistics',
        accountInfo: 'Account Info',
        logout: 'Logout',
        back: 'Back',
        save: 'Save',
        cancel: 'Cancel',
        confirm: 'Confirm',
        delete: 'Delete',
        edit: 'Edit',
        add: 'Add',
        currency: 'Currency',
        amount: 'Amount',
        description: 'Description',
        date: 'Date',
        type: 'Type',
        income: 'Income',
        expense: 'Expense',
        transfer: 'Transfer',
        debt: 'Debt',
        totalIncome: 'Total Income',
        totalExpense: 'Total Expense',
        netBalance: 'Net Balance',
        transactionCount: 'Transaction Count',
        language: 'Language',
        theme: 'Dark Mode',
        light: 'Light',
        dark: 'Dark',
        exportData: 'Export Data',
        resetData: 'Reset All Data',
        manageCurrencies: 'Manage Currencies',
        addCurrency: 'Add Currency',
        currencyCode: 'Currency Code',
        currencyName: 'Currency Name',
        addBalance: 'Add Balance',
        subtractBalance: 'Subtract Balance',
        processTransfer: 'Transfer',
        addTransaction: 'Add Transaction',
        addDebt: 'Add Debt',
        filter: 'Filter',
        search: 'Search',
        clearFilters: 'Clear Filters',
        allTypes: 'All Types',
        allCurrencies: 'All Currencies',
        fromDate: 'From Date',
        toDate: 'To Date',
        minAmount: 'Min Amount',
        maxAmount: 'Max Amount',
        owedToMe: 'Owed to Me',
        iOwe: 'I Owe',
        personName: 'Person Name',
        debtDate: 'Debt Date',
        fromCurrency: 'From Currency',
        toCurrency: 'To Currency',
        exchangeRate: 'Exchange Rate',
        operationType: 'Operation',
        multiply: 'Multiply (×)',
        divide: 'Divide (÷)',
        updateProfile: 'Update Profile',
        displayName: 'Display Name',
        newPassword: 'New Password',
        personalInfo: 'Personal Information',
        accountStats: 'Account Statistics',
        creationDate: 'Creation Date',
        lastLogin: 'Last Login',
        totalTransactions: 'Total Transactions',
        currenciesUsed: 'Currencies Used',
        lastActivity: 'Last Activity',
        notSpecified: 'Not Specified',
        monthlyChart: 'Monthly Income & Expense',
        currencyDistribution: 'Balance Distribution by Currency',
        dataExported: 'Data exported successfully',
        dataReset: 'All data reset successfully',
        currencyAdded: 'Currency added successfully',
        currencyRemoved: 'Currency removed successfully',
        balanceUpdated: 'Balance updated successfully',
        transactionAdded: 'Transaction added successfully',
        debtAdded: 'Debt added successfully',
        transferCompleted: 'Transfer completed successfully',
        profileUpdated: 'Profile updated successfully',
        languageChanged: 'Language changed to English',
        themeChanged: 'Theme changed',
        loginSuccess: 'Login successful',
        signupSuccess: 'Account created successfully',
        logoutSuccess: 'Logout successful',
        error: 'Error',
        success: 'Success',
        warning: 'Warning',
        info: 'Info',
        loading: 'Loading...',
        saving: 'Saving...',
        saved: 'Saved',
        syncing: 'Syncing...',
        syncError: 'Sync Error',
        fillAllFields: 'Please fill all required fields',
        invalidEmail: 'Please enter a valid email',
        weakPassword: 'Password is too weak',
        passwordRequirements: 'Password must contain: uppercase, lowercase, number, special character, and be at least 8 characters',
        confirmDelete: 'Are you sure you want to delete this item?',
        confirmReset: 'Are you sure you want to reset all data?',
        noTransactions: 'No transactions',
        noDebts: 'No debts',
        noData: 'No data',
        rememberMe: 'Remember Me',
        forgotPassword: 'Forgot Password?',
        alreadyHaveAccount: 'Already have an account?',
        dontHaveAccount: "Don't have an account?",
        continueWithGoogle: 'Continue with Google',
        or: 'Or'
      }
    };

    // وظائف المساعدة
    function t(key) {
      return translations[currentLanguage][key] || key;
    }

    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}"></i>
        <span>${message}</span>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    function formatCurrency(amount, currency) {
      const hasDecimals = amount % 1 !== 0;
      const minimumFractionDigits = hasDecimals ? 2 : 0;
      const maximumFractionDigits = 2;
      
      return new Intl.NumberFormat(currentLanguage === 'ar' ? 'ar-SA' : 'en-US', {
        style: 'currency',
        currency: currency,
        minimumFractionDigits: minimumFractionDigits,
        maximumFractionDigits: maximumFractionDigits
      }).format(amount);
    }

    function getCurrencyName(currency) {
      const names = {
        'SDG': currentLanguage === 'ar' ? 'جنيه سوداني (SDG)' : 'Sudanese Pound (SDG)',
        'USD': currentLanguage === 'ar' ? 'دولار أمريكي (USD)' : 'US Dollar (USD)',
        'EUR': currentLanguage === 'ar' ? 'يورو (EUR)' : 'Euro (EUR)',
        'GBP': currentLanguage === 'ar' ? 'جنيه إسترليني (GBP)' : 'British Pound (GBP)',
        'JPY': currentLanguage === 'ar' ? 'ين ياباني (JPY)' : 'Japanese Yen (JPY)',
        'SAR': currentLanguage === 'ar' ? 'ريال سعودي (SAR)' : 'Saudi Riyal (SAR)',
        'AED': currentLanguage === 'ar' ? 'درهم إماراتي (AED)' : 'UAE Dirham (AED)'
      };
      return names[currency] || currency;
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function formatDate(date) {
      if (!date) return t('notSpecified');
      const d = new Date(date);
      return d.toLocaleDateString(currentLanguage === 'ar' ? 'ar-SA' : 'en-US');
    }

    function updateBackupIndicator(status, text) {
      const indicator = document.getElementById('backup-indicator');
      const textElement = document.getElementById('backup-text');
      
      if (indicator && textElement) {
        indicator.className = `backup-indicator ${status}`;
        textElement.textContent = text;
        indicator.style.display = 'flex';
        
        if (status === 'syncing') {
          setTimeout(() => {
            indicator.className = 'backup-indicator';
            textElement.textContent = t('saved');
          }, 2000);
        }
      }
    }

    // وظائف Firebase
    function saveUserData() {
      if (currentUser && db && firebaseInitialized) {
        updateBackupIndicator('syncing', t('saving'));
        
        const userData = {
          currencies,
          balances,
          transactions,
          debts,
          preferences: {
            language: currentLanguage,
            theme: document.body.getAttribute('data-theme'),
            defaultCurrency
          },
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        };

        db.collection('users').doc(currentUser.uid).set(userData, { merge: true })
          .then(() => {
            updateBackupIndicator('', t('saved'));
          })
          .catch(error => {
            console.error('Error saving data:', error);
            updateBackupIndicator('error', t('syncError'));
          });
      }
    }

    function loadUserData() {
      if (currentUser && db && firebaseInitialized) {
        updateBackupIndicator('syncing', t('loading'));
        
        db.collection('users').doc(currentUser.uid).get()
          .then(doc => {
            if (doc.exists) {
              const data = doc.data();
              
              if (data.currencies) currencies = data.currencies;
              if (data.balances) balances = data.balances;
              if (data.transactions) transactions = data.transactions;
              if (data.debts) debts = data.debts;
              if (data.preferences) {
                if (data.preferences.language) {
                  currentLanguage = data.preferences.language;
                  updateLanguageDisplay();
                }
                if (data.preferences.theme) {
                  document.body.setAttribute('data-theme', data.preferences.theme);
                  updateThemeDisplay();
                }
                if (data.preferences.defaultCurrency) defaultCurrency = data.preferences.defaultCurrency;
              }
              
              updateBackupIndicator('', t('saved'));
            } else {
              initializeUserData();
            }
            
            updateUI();
          })
          .catch(error => {
            console.error('Error loading data:', error);
            updateBackupIndicator('error', t('syncError'));
            initializeUserData();
            updateUI();
          });
      } else {
        updateUI();
      }
    }

    function initializeUserData() {
      currencies = ['SDG', 'USD', 'EUR'];
      balances = { SDG: 0, USD: 0, EUR: 0 };
      transactions = [];
      debts = [];
      defaultCurrency = 'SDG';
      saveUserData();
    }

    // وظائف المصادقة
    function validatePassword(password) {
      const minLength = 8;
      const hasUpperCase = /[A-Z]/.test(password);
      const hasLowerCase = /[a-z]/.test(password);
      const hasNumbers = /\d/.test(password);
      const hasSpecialChar = /[$&#@!%*?&]/.test(password);
      
      return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumbers && hasSpecialChar;
    }

    function handleLogin() {
      console.log('handleLogin called');
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const rememberMe = document.getElementById('remember-me').checked;
      
      if (!email || !password) {
        showNotification(t('fillAllFields'), 'error');
        return;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showNotification(t('invalidEmail'), 'error');
        return;
      }

      if (!firebaseInitialized) {
        showNotification('خدمة المصادقة غير متاحة حالياً', 'error');
        return;
      }

      const loginLoader = document.getElementById('login-loader');
      if (loginLoader) loginLoader.style.display = 'block';

      const persistence = rememberMe ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION;
      
      auth.setPersistence(persistence)
        .then(() => {
          return auth.signInWithEmailAndPassword(email, password);
        })
        .then(userCredential => {
          if (!userCredential || !userCredential.user) {
            throw new Error('فشل في تسجيل الدخول');
          }
          
          currentUser = userCredential.user;
          console.log('Login successful for:', currentUser.email);
          
          const welcomeMessage = rememberMe ? 
            'مرحباً بك! تم تسجيل الدخول بنجاح وسيتم حفظ جلستك' : 
            'مرحباً بك! تم تسجيل الدخول بنجاح';
          showNotification(welcomeMessage, 'success');
          
          document.getElementById('login-email').value = '';
          document.getElementById('login-password').value = '';
          document.getElementById('remember-me').checked = false;
          
          loadUserData();
          showApp();
        })
        .catch(error => {
          console.error('Login error:', error);
          let errorMessage = 'حدث خطأ أثناء تسجيل الدخول';
          
          switch(error.code) {
            case 'auth/user-not-found':
              errorMessage = 'لا يوجد حساب مسجل بهذا البريد الإلكتروني';
              break;
            case 'auth/wrong-password':
              errorMessage = 'كلمة المرور غير صحيحة';
              break;
            case 'auth/invalid-email':
              errorMessage = 'تنسيق البريد الإلكتروني غير صحيح';
              break;
            case 'auth/user-disabled':
              errorMessage = 'تم تعطيل هذا الحساب';
              break;
            case 'auth/too-many-requests':
              errorMessage = 'تم تجاوز عدد المحاولات المسموح';
              break;
            case 'auth/network-request-failed':
              errorMessage = 'مشكلة في الاتصال بالإنترنت';
              break;
            case 'auth/invalid-login-credentials':
              errorMessage = 'بيانات تسجيل الدخول غير صحيحة';
              break;
            default:
              errorMessage = `خطأ: ${error.message || 'يرجى المحاولة لاحقاً'}`;
          }
          
          showNotification(errorMessage, 'error');
          currentUser = null;
          showAuth();
        })
        .finally(() => {
          const loginLoader = document.getElementById('login-loader');
          if (loginLoader) loginLoader.style.display = 'none';
        });
    }

    function handleSignup() {
      console.log('handleSignup called');
      const firstName = document.getElementById('signup-firstname').value.trim();
      const lastName = document.getElementById('signup-lastname').value.trim();
      const email = document.getElementById('signup-email').value.trim();
      const password = document.getElementById('signup-password').value;
      
      if (!firstName || !lastName || !email || !password) {
        showNotification(t('fillAllFields'), 'error');
        return;
      }

      if (firstName.length < 2 || lastName.length < 2) {
        showNotification('يجب أن يكون الاسم مكوناً من حرفين على الأقل', 'error');
        return;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showNotification(t('invalidEmail'), 'error');
        return;
      }

      if (!validatePassword(password)) {
        showNotification(t('passwordRequirements'), 'error');
        return;
      }

      if (!firebaseInitialized) {
        showNotification('خدمة المصادقة غير متاحة حالياً', 'error');
        return;
      }

      const signupLoader = document.getElementById('signup-loader');
      if (signupLoader) signupLoader.style.display = 'block';

      auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          currentUser = userCredential.user;
          
          return currentUser.updateProfile({
            displayName: `${firstName} ${lastName}`
          });
        })
        .then(() => {
          showNotification(`مرحباً ${firstName}! تم إنشاء حسابك بنجاح`, 'success');
          initializeUserData();
          showApp();
        })
        .catch(error => {
          console.error('Signup error:', error);
          let errorMessage = 'حدث خطأ أثناء إنشاء الحساب';
          
          switch(error.code) {
            case 'auth/email-already-in-use':
              errorMessage = 'هذا البريد الإلكتروني مستخدم بالفعل';
              break;
            case 'auth/invalid-email':
              errorMessage = 'تنسيق البريد الإلكتروني غير صحيح';
              break;
            case 'auth/weak-password':
              errorMessage = 'كلمة المرور ضعيفة جداً';
              break;
            case 'auth/operation-not-allowed':
              errorMessage = 'إنشاء الحسابات غير مفعل حالياً';
              break;
            default:
              errorMessage = `خطأ: ${error.message || 'يرجى المحاولة لاحقاً'}`;
          }
          
          showNotification(errorMessage, 'error');
        })
        .finally(() => {
          const signupLoader = document.getElementById('signup-loader');
          if (signupLoader) signupLoader.style.display = 'none';
        });
    }

    function signInWithGoogle() {
      console.log('signInWithGoogle called');
      if (!firebaseInitialized) {
        showNotification('خدمة المصادقة غير متاحة حالياً', 'error');
        return;
      }

      const provider = new firebase.auth.GoogleAuthProvider();
      provider.addScope('profile');
      provider.addScope('email');
      
      auth.signInWithPopup(provider)
        .then(result => {
          currentUser = result.user;
          const userName = result.user.displayName || 'المستخدم';
          showNotification(`مرحباً ${userName}! تم تسجيل الدخول بنجاح`, 'success');
          loadUserData();
          showApp();
        })
        .catch(error => {
          console.error('Google sign-in error:', error);
          let errorMessage = 'حدث خطأ أثناء تسجيل الدخول بـ Google';
          
          switch(error.code) {
            case 'auth/popup-closed-by-user':
              errorMessage = 'تم إغلاق نافذة تسجيل الدخول';
              break;
            case 'auth/popup-blocked':
              errorMessage = 'تم حظر النافذة المنبثقة';
              break;
            case 'auth/cancelled-popup-request':
              errorMessage = 'تم إلغاء طلب تسجيل الدخول';
              break;
            default:
              errorMessage = `خطأ في تسجيل الدخول: ${error.message || 'يرجى المحاولة لاحقاً'}`;
          }
          
          showNotification(errorMessage, 'error');
        });
    }

    function handlePasswordReset() {
      const email = document.getElementById('login-email').value.trim();
      
      if (!email) {
        showNotification('يرجى إدخال البريد الإلكتروني أولاً', 'error');
        return;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showNotification(t('invalidEmail'), 'error');
        return;
      }

      if (!firebaseInitialized) {
        showNotification('خدمة المصادقة غير متاحة حالياً', 'error');
        return;
      }

      auth.sendPasswordResetEmail(email)
        .then(() => {
          showNotification(`تم إرسال رابط إعادة تعيين كلمة المرور إلى ${email}`, 'success');
        })
        .catch(error => {
          console.error('Password reset error:', error);
          let errorMessage = 'حدث خطأ أثناء إرسال رابط إعادة التعيين';
          
          switch(error.code) {
            case 'auth/user-not-found':
              errorMessage = 'لا يوجد حساب مسجل بهذا البريد الإلكتروني';
              break;
            case 'auth/invalid-email':
              errorMessage = 'تنسيق البريد الإلكتروني غير صحيح';
              break;
            default:
              errorMessage = `خطأ: ${error.message || 'يرجى المحاولة لاحقاً'}`;
          }
          
          showNotification(errorMessage, 'error');
        });
    }

    function handleLogout() {
      if (!firebaseInitialized || !auth) {
        showAuth();
        return;
      }

      auth.signOut()
        .then(() => {
          currentUser = null;
          showNotification(t('logoutSuccess'), 'success');
          showAuth();
        })
        .catch(error => {
          console.error('Logout error:', error);
          showNotification('حدث خطأ أثناء تسجيل الخروج', 'error');
        });
    }

    function toggleAuthForms() {
      const loginForm = document.getElementById("login-form");
      const signupForm = document.getElementById("signup-form");
      
      if (loginForm.style.display === "none") {
        loginForm.style.display = "block";
        signupForm.style.display = "none";
      } else {
        loginForm.style.display = "none";
        signupForm.style.display = "block";
      }
    }

    // وظائف التنقل
    function showPage(pageId) {
      document.getElementById('main-menu').style.display = 'none';
      document.getElementById('main-header').style.display = 'none';
      document.getElementById('page-header').style.display = 'flex';
      
      const pages = document.querySelectorAll('.page');
      pages.forEach(page => page.classList.remove('active-page'));
      
      const targetPage = document.getElementById(pageId);
      if (targetPage) {
        targetPage.classList.add('active-page');
        
        const pageTitle = targetPage.querySelector('h2').textContent;
        document.getElementById('page-title').textContent = pageTitle;
        
        switch(pageId) {
          case 'balance':
            updateBalanceDisplay();
            break;
          case 'transactions':
            updateTransactionsDisplay();
            break;
          case 'statistics':
            updateStatistics();
            break;
          case 'settings':
            updateSettingsDisplay();
            break;
          case 'debts':
            updateDebtsDisplay();
            break;
          case 'account-info':
            updateAccountInfoDisplay();
            break;
          case 'manage-currencies':
            updateCurrenciesManagement();
            break;
        }
      }
    }

    function showMainMenu() {
      document.getElementById('main-menu').style.display = 'block';
      document.getElementById('main-header').style.display = 'block';
      document.getElementById('page-header').style.display = 'none';
      
      const pages = document.querySelectorAll('.page');
      pages.forEach(page => page.classList.remove('active-page'));
    }

    function showApp() {
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('app-container').style.display = 'block';
      document.getElementById('backup-indicator').style.display = 'flex';
      updateUI();
    }

    function showAuth() {
      document.getElementById('auth-container').style.display = 'flex';
      document.getElementById('app-container').style.display = 'none';
      document.getElementById('backup-indicator').style.display = 'none';
    }

    // وظائف واجهة المستخدم
    function updateUI() {
      updateCurrencySelects();
      updateBalanceDisplay();
      updateTransactionsDisplay();
      updateSettingsDisplay();
      updateLanguageDisplay();
      updateThemeDisplay();
    }

    function updateLanguageDisplay() {
      const html = document.documentElement;
      if (currentLanguage === 'ar') {
        html.setAttribute('lang', 'ar');
        html.setAttribute('dir', 'rtl');
      } else {
        html.setAttribute('lang', 'en');
        html.setAttribute('dir', 'ltr');
      }
      
      const languageBtn = document.getElementById('language-toggle-btn');
      if (languageBtn) {
        languageBtn.textContent = currentLanguage === 'ar' ? 'EN' : 'ع';
      }
      
      const currentLanguageDisplay = document.getElementById('current-language-display');
      if (currentLanguageDisplay) {
        currentLanguageDisplay.textContent = currentLanguage === 'ar' ? 'العربية' : 'English';
      }
      
      // تحديث النصوص في الواجهة
      document.title = t('title');
    }

    function updateThemeDisplay() {
      const currentTheme = document.body.getAttribute('data-theme');
      
      const themeIcon = document.getElementById('theme-icon');
      if (themeIcon) {
        themeIcon.className = currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      }
      
      const settingsThemeIcon = document.getElementById('settings-theme-icon');
      if (settingsThemeIcon) {
        settingsThemeIcon.className = currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      }
      
      const themeStatus = document.getElementById('theme-status');
      if (themeStatus) {
        themeStatus.textContent = currentTheme === 'dark' ? t('dark') : t('light');
      }
    }

    function updateCurrencySelects() {
      const selects = [
        'fromCurrency', 'toCurrency', 'transactionCurrency', 'debtCurrency',
        'filter-currency', 'balance-currency'
      ];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
          select.innerHTML = '';
          if (selectId === 'filter-currency') {
            select.innerHTML = `<option value="">${t('allCurrencies')}</option>`;
          }
          
          currencies.forEach(currency => {
            const option = document.createElement('option');
            option.value = currency;
            option.textContent = getCurrencyName(currency);
            if (currency === defaultCurrency) {
              option.selected = true;
            }
            select.appendChild(option);
          });
        }
      });
    }

    function updateBalanceDisplay() {
      const balanceList = document.getElementById('balance-list');
      if (!balanceList) return;
      
      balanceList.innerHTML = '';
      
      currencies.forEach(currency => {
        const balance = balances[currency] || 0;
        const balanceItem = document.createElement('div');
        balanceItem.className = 'balance-item';
        balanceItem.innerHTML = `
          <div>
            <strong>${getCurrencyName(currency)}</strong>
            ${currency === defaultCurrency ? `<span style="color:var(--primary);font-size:12px"> (${currentLanguage === 'ar' ? 'افتراضية' : 'default'})</span>` : ''}
          </div>
          <div style="font-weight:700;color:${balance >= 0 ? 'var(--success)' : 'var(--danger)'}">
            ${formatCurrency(balance, currency)}
          </div>
        `;
        balanceList.appendChild(balanceItem);
      });
    }

    function updateTransactionsDisplay() {
      applyFilters();
    }

    function updateDebtsDisplay() {
      const debtsList = document.getElementById('debts-list');
      if (!debtsList) return;
      
      debtsList.innerHTML = '';
      
      if (debts.length === 0) {
        debtsList.innerHTML = `<p style="text-align:center;color:#666;padding:20px">${t('noDebts')}</p>`;
        return;
      }
      
      debts.forEach(debt => {
        const debtItem = document.createElement('div');
        debtItem.className = 'debt-record';
        debtItem.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div style="font-weight:700;color:${debt.type === 'owed_to_me' ? 'var(--success)' : 'var(--danger)'}">
                ${debt.type === 'owed_to_me' ? t('owedToMe') : t('iOwe')}: ${debt.person}
              </div>
              <div style="font-size:12px;color:#666;margin:2px 0;">
                ${debt.description || t('noData')}
              </div>
              <div style="font-size:11px;color:#999;">
                ${formatDate(debt.date)}
              </div>
            </div>
            <div style="text-align:left;">
              <div style="font-weight:700;font-size:16px;">
                ${formatCurrency(debt.amount, debt.currency)}
              </div>
              <button onclick="deleteDebt('${debt.id}')" class="btn-danger" style="width:auto;padding:4px 8px;font-size:11px;margin-top:5px;">
                ${t('delete')}
              </button>
            </div>
          </div>
        `;
        debtsList.appendChild(debtItem);
      });
    }

    function updateAccountInfoDisplay() {
      if (!currentUser) return;
      
      const userDisplayName = document.getElementById('user-display-name');
      const userEmailDisplay = document.getElementById('user-email-display');
      const userCreationDate = document.getElementById('user-creation-date');
      const userLastLogin = document.getElementById('user-last-login');
      const accountTotalTransactions = document.getElementById('account-total-transactions');
      const accountCurrenciesCount = document.getElementById('account-currencies-count');
      const accountLastActivity = document.getElementById('account-last-activity');
      
      if (userDisplayName) userDisplayName.textContent = currentUser.displayName || t('notSpecified');
      if (userEmailDisplay) userEmailDisplay.textContent = currentUser.email || t('notSpecified');
      if (userCreationDate) userCreationDate.textContent = formatDate(currentUser.metadata.creationTime);
      if (userLastLogin) userLastLogin.textContent = formatDate(currentUser.metadata.lastSignInTime);
      if (accountTotalTransactions) accountTotalTransactions.textContent = transactions.length;
      if (accountCurrenciesCount) accountCurrenciesCount.textContent = currencies.length;
      if (accountLastActivity) accountLastActivity.textContent = formatDate(new Date());
      
      const updateDisplayName = document.getElementById('update-display-name');
      if (updateDisplayName) updateDisplayName.value = currentUser.displayName || '';
    }

    function updateCurrenciesManagement() {
      const currenciesList = document.getElementById('currencies-list');
      if (!currenciesList) return;
      
      currenciesList.innerHTML = '';
      
      currencies.forEach(currency => {
        const currencyItem = document.createElement('div');
        currencyItem.className = 'balance-item';
        currencyItem.innerHTML = `
          <div>
            <strong>${getCurrencyName(currency)}</strong>
            ${currency === defaultCurrency ? `<span style="color:var(--primary);font-size:12px"> (${currentLanguage === 'ar' ? 'افتراضية' : 'default'})</span>` : ''}
          </div>
          <button class="btn-danger" onclick="removeCurrency('${currency}')" 
                  ${currency === defaultCurrency ? 'disabled' : ''}>${t('delete')}</button>
        `;
        currenciesList.appendChild(currencyItem);
      });
    }

    function updateSettingsDisplay() {
      if (currentUser) {
        const emailInput = document.getElementById('user-email');
        const nameInput = document.getElementById('user-name');
        if (emailInput) emailInput.value = currentUser.email || '';
        if (nameInput) nameInput.value = currentUser.displayName || '';
      }
      
      updateCurrenciesManagement();
      updateLanguageDisplay();
      updateThemeDisplay();
    }

    // وظائف الأعمال
    function applyFilters() {
      const transactionsList = document.getElementById('transactions-list');
      if (!transactionsList) return;
      
      const typeFilter = document.getElementById('filter-type')?.value || '';
      const currencyFilter = document.getElementById('filter-currency')?.value || '';
      const descriptionFilter = document.getElementById('filter-description')?.value.toLowerCase() || '';
      const dateFromFilter = document.getElementById('filter-date-from')?.value || '';
      const dateToFilter = document.getElementById('filter-date-to')?.value || '';
      const amountMinFilter = parseFloat(document.getElementById('filter-amount-min')?.value) || 0;
      const amountMaxFilter = parseFloat(document.getElementById('filter-amount-max')?.value) || Infinity;
      
      filteredTransactions = transactions.filter(transaction => {
        const matchesType = !typeFilter || transaction.type === typeFilter;
        const matchesCurrency = !currencyFilter || transaction.currency === currencyFilter;
        const matchesDescription = !descriptionFilter || 
          (transaction.description && transaction.description.toLowerCase().includes(descriptionFilter));
        const matchesDateFrom = !dateFromFilter || new Date(transaction.date) >= new Date(dateFromFilter);
        const matchesDateTo = !dateToFilter || new Date(transaction.date) <= new Date(dateToFilter);
        const matchesAmountMin = transaction.amount >= amountMinFilter;
        const matchesAmountMax = transaction.amount <= amountMaxFilter;
        
        return matchesType && matchesCurrency && matchesDescription && 
               matchesDateFrom && matchesDateTo && matchesAmountMin && matchesAmountMax;
      });
      
      transactionsList.innerHTML = '';
      
      if (filteredTransactions.length === 0) {
        transactionsList.innerHTML = `<p style="text-align:center;color:#666;padding:20px">${t('noTransactions')}</p>`;
        return;
      }
      
      filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      filteredTransactions.forEach(transaction => {
        const transactionItem = document.createElement('div');
        transactionItem.className = 'transaction-item';
        transactionItem.innerHTML = `
          <div class="transaction-info">
            <div class="transaction-type ${transaction.type}">
              ${t(transaction.type)}: ${formatCurrency(transaction.amount, transaction.currency)}
            </div>
            <div class="transaction-description">
              ${transaction.description || t('noData')}
            </div>
            <div class="transaction-date">
              ${formatDate(transaction.date)}
            </div>
          </div>
          <div class="transaction-actions">
            <button onclick="editTransaction('${transaction.id}')" class="btn-success" title="${t('edit')}">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="deleteTransaction('${transaction.id}')" class="btn-danger" title="${t('delete')}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        transactionsList.appendChild(transactionItem);
      });
    }

    function updateStatistics() {
      const totalIncomeElement = document.getElementById('total-income');
      const totalExpenseElement = document.getElementById('total-expense');
      const netBalanceElement = document.getElementById('net-balance');
      const transactionCountElement = document.getElementById('transaction-count');
      
      let totalIncome = 0;
      let totalExpense = 0;
      
      // حساب الإحصائيات بالعملة الافتراضية
      transactions.forEach(transaction => {
        if (transaction.type === 'income') {
          totalIncome += transaction.amount;
        } else if (transaction.type === 'expense') {
          totalExpense += transaction.amount;
        }
      });
      
      const netBalance = totalIncome - totalExpense;
      
      if (totalIncomeElement) totalIncomeElement.textContent = formatCurrency(totalIncome, defaultCurrency);
      if (totalExpenseElement) totalExpenseElement.textContent = formatCurrency(totalExpense, defaultCurrency);
      if (netBalanceElement) {
        netBalanceElement.textContent = formatCurrency(netBalance, defaultCurrency);
        netBalanceElement.style.color = netBalance >= 0 ? 'var(--success)' : 'var(--danger)';
      }
      if (transactionCountElement) transactionCountElement.textContent = transactions.length;
      
      // تحديث الرسوم البيانية
      updateCharts();
    }

    function updateCharts() {
      updateMonthlyChart();
      updateCurrencyChart();
    }

    function updateMonthlyChart() {
      const ctx = document.getElementById('monthly-chart');
      if (!ctx) return;
      
      if (monthlyChart) {
        monthlyChart.destroy();
      }
      
      // بيانات وهمية للرسم البياني
      const monthlyData = {
        labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
        datasets: [{
          label: t('income'),
          data: [1200, 1900, 3000, 5000, 2000, 3000],
          backgroundColor: 'rgba(40, 167, 69, 0.2)',
          borderColor: 'rgba(40, 167, 69, 1)',
          borderWidth: 2
        }, {
          label: t('expense'),
          data: [1000, 1500, 2000, 3000, 1500, 2500],
          backgroundColor: 'rgba(220, 53, 69, 0.2)',
          borderColor: 'rgba(220, 53, 69, 1)',
          borderWidth: 2
        }]
      };
      
      monthlyChart = new Chart(ctx, {
        type: 'line',
        data: monthlyData,
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function updateCurrencyChart() {
      const ctx = document.getElementById('currency-chart');
      if (!ctx) return;
      
      if (currencyChart) {
        currencyChart.destroy();
      }
      
      const currencyData = {
        labels: currencies.map(currency => getCurrencyName(currency)),
        datasets: [{
          data: currencies.map(currency => Math.abs(balances[currency] || 0)),
          backgroundColor: [
            'rgba(44, 120, 108, 0.8)',
            'rgba(0, 68, 69, 0.8)',
            'rgba(255, 209, 102, 0.8)',
            'rgba(220, 53, 69, 0.8)',
            'rgba(40, 167, 69, 0.8)',
            'rgba(23, 162, 184, 0.8)'
          ],
          borderWidth: 2
        }]
      };
      
      currencyChart = new Chart(ctx, {
        type: 'doughnut',
        data: currencyData,
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
            }
          }
        }
      });
    }

    // وظائف الأعمال المتقدمة
    function openBalanceModal(action) {
      currentBalanceAction = action;
      const modal = document.getElementById('balance-modal');
      const title = document.getElementById('balance-modal-title');
      const confirmBtn = document.getElementById('balance-confirm-btn');
      
      if (action === 'add') {
        title.textContent = t('addBalance');
        confirmBtn.textContent = t('add');
        confirmBtn.className = 'btn-success';
      } else {
        title.textContent = t('subtractBalance');
        confirmBtn.textContent = t('subtract');
        confirmBtn.className = 'btn-danger';
      }
      
      updateCurrencySelects();
      modal.classList.add('show');
    }

    function closeBalanceModal() {
      const modal = document.getElementById('balance-modal');
      modal.classList.remove('show');
      
      // مسح النموذج
      document.getElementById('balance-amount').value = '';
      document.getElementById('balance-description').value = '';
    }

    function processBalanceChange() {
      const currency = document.getElementById('balance-currency').value;
      const amount = parseFloat(document.getElementById('balance-amount').value);
      const description = document.getElementById('balance-description').value;
      
      if (!currency || !amount || amount <= 0) {
        showNotification(t('fillAllFields'), 'error');
        return;
      }
      
      const changeAmount = currentBalanceAction === 'add' ? amount : -amount;
      
      if (!balances[currency]) {
        balances[currency] = 0;
      }
      
      balances[currency] += changeAmount;
      
      // إضافة معاملة
      const transaction = {
        id: generateId(),
        type: currentBalanceAction === 'add' ? 'income' : 'expense',
        amount: amount,
        currency: currency,
        description: description || (currentBalanceAction === 'add' ? 'إضافة رصيد' : 'خصم رصيد'),
        date: new Date().toISOString().split('T')[0]
      };
      
      transactions.push(transaction);
      
      saveUserData();
      updateBalanceDisplay();
      closeBalanceModal();
      showNotification(t('balanceUpdated'), 'success');
    }

    function processTransfer() {
      const fromCurrency = document.getElementById('fromCurrency').value;
      const toCurrency = document.getElementById('toCurrency').value;
      const amount = parseFloat(document.getElementById('transferAmount').value);
      const exchangeRate = parseFloat(document.getElementById('exchangeRate').value);
      const operationType = document.getElementById('operationType').value;
      
      if (!fromCurrency || !toCurrency || !amount || !exchangeRate || amount <= 0 || exchangeRate <= 0) {
        showNotification(t('fillAllFields'), 'error');
        return;
      }
      
      if (fromCurrency === toCurrency) {
        showNotification('لا يمكن التحويل إلى نفس العملة', 'error');
        return;
      }
      
      if (!balances[fromCurrency] || balances[fromCurrency] < amount) {
        showNotification('الرصيد غير كافي', 'error');
        return;
      }
      
      const convertedAmount = operationType === 'multiply' ? amount * exchangeRate : amount / exchangeRate;
      
      balances[fromCurrency] -= amount;
      if (!balances[toCurrency]) balances[toCurrency] = 0;
      balances[toCurrency] += convertedAmount;
      
      // إضافة معاملة التحويل
      const transaction = {
        id: generateId(),
        type: 'transfer',
        amount: amount,
        currency: fromCurrency,
        description: `تحويل من ${getCurrencyName(fromCurrency)} إلى ${getCurrencyName(toCurrency)} (${convertedAmount.toFixed(2)} ${toCurrency})`,
        date: new Date().toISOString().split('T')[0],
        transferDetails: {
          fromCurrency,
          toCurrency,
          fromAmount: amount,
          toAmount: convertedAmount,
          exchangeRate,
          operationType
        }
      };
      
      transactions.push(transaction);
      
      // مسح النموذج
      document.getElementById('transferAmount').value = '';
      document.getElementById('exchangeRate').value = '';
      
      saveUserData();
      updateBalanceDisplay();
      showNotification(t('transferCompleted'), 'success');
    }

    function addTransaction() {
      const type = document.getElementById('transactionType').value;
      const amount = parseFloat(document.getElementById('transactionAmount').value);
      const currency = document.getElementById('transactionCurrency').value;
      const description = document.getElementById('transactionDescription').value;
      
      if (!type || !amount || !currency || amount <= 0) {
        showNotification(t('fillAllFields'), 'error');
        return;
      }
      
      const transaction = {
        id: generateId(),
        type: type,
        amount: amount,
        currency: currency,
        description: description || (type === 'income' ? 'وارد' : 'صادر'),
        date: new Date().toISOString().split('T')[0]
      };
      
      transactions.push(transaction);
      
      // تحديث الرصيد
      if (!balances[currency]) balances[currency] = 0;
      if (type === 'income') {
        balances[currency] += amount;
      } else {
        balances[currency] -= amount;
      }
      
      // مسح النموذج
      document.getElementById('transactionAmount').value = '';
      document.getElementById('transactionDescription').value = '';
      
      saveUserData();
      updateBalanceDisplay();
      showNotification(t('transactionAdded'), 'success');
    }

    function addDebt() {
      const type = document.getElementById('debtType').value;
      const person = document.getElementById('debtPerson').value.trim();
      const amount = parseFloat(document.getElementById('debtAmount').value);
      const currency = document.getElementById('debtCurrency').value;
      const description = document.getElementById('debtDescription').value;
      const date = document.getElementById('debtDate').value;
      
      if (!type || !person || !amount || !currency || amount <= 0) {
        showNotification(t('fillAllFields'), 'error');
        return;
      }
      
      const debt = {
        id: generateId(),
        type: type,
        person: person,
        amount: amount,
        currency: currency,
        description: description,
        date: date || new Date().toISOString().split('T')[0]
      };
      
      debts.push(debt);
      
      // مسح النموذج
      document.getElementById('debtPerson').value = '';
      document.getElementById('debtAmount').value = '';
      document.getElementById('debtDescription').value = '';
      document.getElementById('debtDate').value = '';
      
      saveUserData();
      updateDebtsDisplay();
      showNotification(t('debtAdded'), 'success');
    }

    function deleteDebt(debtId) {
      if (!confirm(t('confirmDelete'))) return;
      
      debts = debts.filter(debt => debt.id !== debtId);
      saveUserData();
      updateDebtsDisplay();
      showNotification('تم حذف الدين بنجاح', 'success');
    }

    function deleteTransaction(transactionId) {
      if (!confirm(t('confirmDelete'))) return;
      
      transactions = transactions.filter(transaction => transaction.id !== transactionId);
      saveUserData();
      updateTransactionsDisplay();
      showNotification('تم حذف المعاملة بنجاح', 'success');
    }

    function editTransaction(transactionId) {
      showNotification('وظيفة التعديل قيد التطوير', 'info');
    }

    function addCurrency() {
      const code = document.getElementById('new-currency-code').value.trim().toUpperCase();
      const name = document.getElementById('new-currency-name').value.trim();
      
      if (!code || !name || code.length !== 3) {
        showNotification('يرجى إدخال رمز عملة صحيح (3 أحرف) واسم العملة', 'error');
        return;
      }
      
      if (currencies.includes(code)) {
        showNotification('هذه العملة موجودة بالفعل', 'error');
        return;
      }
      
      currencies.push(code);
      balances[code] = 0;
      
      // مسح النموذج
      document.getElementById('new-currency-code').value = '';
      document.getElementById('new-currency-name').value = '';
      
      saveUserData();
      updateCurrenciesManagement();
      updateCurrencySelects();
      showNotification(t('currencyAdded'), 'success');
    }

    function removeCurrency(currency) {
      if (currency === defaultCurrency) {
        showNotification('لا يمكن حذف العملة الافتراضية', 'error');
        return;
      }
      
      if (!confirm(`هل أنت متأكد من حذف عملة ${getCurrencyName(currency)}؟`)) return;
      
      currencies = currencies.filter(c => c !== currency);
      delete balances[currency];
      
      // حذف المعاملات المرتبطة بهذه العملة
      transactions = transactions.filter(t => t.currency !== currency);
      debts = debts.filter(d => d.currency !== currency);
      
      saveUserData();
      updateCurrenciesManagement();
      updateCurrencySelects();
      updateBalanceDisplay();
      showNotification(t('currencyRemoved'), 'success');
    }

    function updateProfile() {
      const displayName = document.getElementById('update-display-name').value.trim();
      const newPassword = document.getElementById('update-password').value;
      
      if (!displayName) {
        showNotification('يرجى إدخال الاسم', 'error');
        return;
      }
      
      const promises = [];
      
      // تحديث الاسم
      if (displayName !== currentUser.displayName) {
        promises.push(currentUser.updateProfile({ displayName: displayName }));
      }
      
      // تحديث كلمة المرور
      if (newPassword) {
        if (!validatePassword(newPassword)) {
          showNotification(t('passwordRequirements'), 'error');
          return;
        }
        promises.push(currentUser.updatePassword(newPassword));
      }
      
      if (promises.length === 0) {
        showNotification('لا توجد تغييرات للحفظ', 'info');
        return;
      }
      
      Promise.all(promises)
        .then(() => {
          document.getElementById('update-password').value = '';
          updateAccountInfoDisplay();
          showNotification(t('profileUpdated'), 'success');
        })
        .catch(error => {
          console.error('Profile update error:', error);
          showNotification('حدث خطأ أثناء تحديث المعلومات', 'error');
        });
    }

    function toggleTheme() {
      const currentTheme = document.body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      document.body.setAttribute('data-theme', newTheme);
      updateThemeDisplay();
      saveUserData();
      showNotification(t('themeChanged'), 'success');
    }

    function toggleLanguage() {
      currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
      updateLanguageDisplay();
      saveUserData();
      showNotification(t('languageChanged'), 'success');
    }

    function toggleAdvancedFilters() {
      const advancedFilters = document.getElementById('advanced-filters');
      const toggleBtn = document.getElementById('filter-toggle-btn');
      const chevron = document.getElementById('filter-chevron');
      
      if (advancedFilters.style.display === 'none' || !advancedFilters.style.display) {
        advancedFilters.style.display = 'block';
        toggleBtn.classList.add('active');
      } else {
        advancedFilters.style.display = 'none';
        toggleBtn.classList.remove('active');
      }
    }

    function clearFilters() {
      document.getElementById('filter-type').value = '';
      document.getElementById('filter-currency').value = '';
      document.getElementById('filter-description').value = '';
      document.getElementById('filter-date-from').value = '';
      document.getElementById('filter-date-to').value = '';
      document.getElementById('filter-amount-min').value = '';
      document.getElementById('filter-amount-max').value = '';
      
      applyFilters();
    }

    function exportData() {
      const data = {
        currencies,
        balances,
        transactions,
        debts,
        preferences: {
          language: currentLanguage,
          theme: document.body.getAttribute('data-theme'),
          defaultCurrency
        },
        exportDate: new Date().toISOString(),
        userInfo: {
          email: currentUser?.email,
          displayName: currentUser?.displayName
        }
      };
      
      const dataStr = JSON.stringify(data, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `financial-data-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      showNotification(t('dataExported'), 'success');
    }

    function resetAllData() {
      if (!confirm(t('confirmReset'))) {
        return;
      }
      
      currencies = ['SDG', 'USD', 'EUR'];
      balances = { SDG: 0, USD: 0, EUR: 0 };
      transactions = [];
      debts = [];
      defaultCurrency = 'SDG';
      
      saveUserData();
      updateUI();
      showNotification(t('dataReset'), 'success');
    }

    // تهيئة التطبيق
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, setting up event listeners');
      
      // ربط أحداث أزرار تسجيل الدخول
      const loginBtn = document.getElementById('login-btn');
      const signupBtn = document.getElementById('signup-btn');
      const googleLoginBtn = document.getElementById('google-login-btn');
      const googleSignupBtn = document.getElementById('google-signup-btn');
      const showSignupLink = document.getElementById('show-signup-link');
      const showLoginLink = document.getElementById('show-login-link');
      const forgotPasswordLink = document.getElementById('forgot-password-link');
      
      if (loginBtn) {
        loginBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Login button clicked');
          handleLogin();
        });
      }
      
      if (signupBtn) {
        signupBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Signup button clicked');
          handleSignup();
        });
      }
      
      if (googleLoginBtn) {
        googleLoginBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Google login button clicked');
          signInWithGoogle();
        });
      }
      
      if (googleSignupBtn) {
        googleSignupBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Google signup button clicked');
          signInWithGoogle();
        });
      }
      
      if (showSignupLink) {
        showSignupLink.addEventListener('click', function(e) {
          e.preventDefault();
          toggleAuthForms();
        });
      }
      
      if (showLoginLink) {
        showLoginLink.addEventListener('click', function(e) {
          e.preventDefault();
          toggleAuthForms();
        });
      }
      
      if (forgotPasswordLink) {
        forgotPasswordLink.addEventListener('click', function(e) {
          e.preventDefault();
          handlePasswordReset();
        });
      }

      // ربط أحداث أزرار التطبيق
      const logoutBtn = document.getElementById('logout-btn');
      const themeToggleBtn = document.getElementById('theme-toggle-btn');
      const languageToggleBtn = document.getElementById('language-toggle-btn');
      const backToMainBtn = document.getElementById('back-to-main-btn');
      
      if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
      }
      
      if (themeToggleBtn) {
        themeToggleBtn.addEventListener('click', toggleTheme);
      }
      
      if (languageToggleBtn) {
        languageToggleBtn.addEventListener('click', toggleLanguage);
      }
      
      if (backToMainBtn) {
        backToMainBtn.addEventListener('click', showMainMenu);
      }

      // ربط أحداث بطاقات القائمة الرئيسية
      const mainCards = document.querySelectorAll('.main-card');
      mainCards.forEach(card => {
        card.addEventListener('click', function() {
          const pageId = this.getAttribute('data-page');
          if (pageId) {
            showPage(pageId);
          }
        });
      });

      // ربط أحداث أزرار الإعدادات
      const statisticsBtn = document.getElementById('statistics-btn');
      const accountInfoBtn = document.getElementById('account-info-btn');
      const exportDataBtn = document.getElementById('export-data-btn');
      const resetDataBtn = document.getElementById('reset-data-btn');
      const languageSettingsBtn = document.getElementById('language-settings-btn');
      const themeSettingsBtn = document.getElementById('theme-settings-btn');
      const manageCurrenciesBtn = document.getElementById('manage-currencies-btn');
      
      if (statisticsBtn) {
        statisticsBtn.addEventListener('click', () => showPage('statistics'));
      }
      
      if (accountInfoBtn) {
        accountInfoBtn.addEventListener('click', () => showPage('account-info'));
      }
      
      if (exportDataBtn) {
        exportDataBtn.addEventListener('click', exportData);
      }
      
      if (resetDataBtn) {
        resetDataBtn.addEventListener('click', resetAllData);
      }
      
      if (languageSettingsBtn) {
        languageSettingsBtn.addEventListener('click', toggleLanguage);
      }
      
      if (themeSettingsBtn) {
        themeSettingsBtn.addEventListener('click', toggleTheme);
      }
      
      if (manageCurrenciesBtn) {
        manageCurrenciesBtn.addEventListener('click', () => showPage('manage-currencies'));
      }

      // ربط أحداث أزرار العمليات
      const processTransferBtn = document.getElementById('process-transfer-btn');
      const addTransactionBtn = document.getElementById('add-transaction-btn');
      const addDebtBtn = document.getElementById('add-debt-btn');
      const addCurrencyBtn = document.getElementById('add-currency-btn');
      const updateProfileBtn = document.getElementById('update-profile-btn');
      
      if (processTransferBtn) {
        processTransferBtn.addEventListener('click', processTransfer);
      }
      
      if (addTransactionBtn) {
        addTransactionBtn.addEventListener('click', addTransaction);
      }
      
      if (addDebtBtn) {
        addDebtBtn.addEventListener('click', addDebt);
      }
      
      if (addCurrencyBtn) {
        addCurrencyBtn.addEventListener('click', addCurrency);
      }
      
      if (updateProfileBtn) {
        updateProfileBtn.addEventListener('click', updateProfile);
      }

      // ربط أحداث الفلاتر
      const filterToggleBtn = document.getElementById('filter-toggle-btn');
      const clearFiltersBtn = document.getElementById('clear-filters-btn');
      
      if (filterToggleBtn) {
        filterToggleBtn.addEventListener('click', toggleAdvancedFilters);
      }
      
      if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', clearFilters);
      }
      
      // ربط أحداث الفلاتر للتطبيق المباشر
      const filterInputs = [
        'filter-type', 'filter-currency', 'filter-description',
        'filter-date-from', 'filter-date-to', 'filter-amount-min', 'filter-amount-max'
      ];
      
      filterInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
          input.addEventListener('change', applyFilters);
          input.addEventListener('input', applyFilters);
        }
      });

      // إعداد مراقبة كلمة المرور
      const passwordInput = document.getElementById('signup-password');
      const requirements = document.getElementById('password-requirements');
      
      if (passwordInput && requirements) {
        passwordInput.addEventListener('focus', () => {
          requirements.style.display = 'block';
        });
        
        passwordInput.addEventListener('blur', () => {
          requirements.style.display = 'none';
        });
      }

      // مراقبة حالة المصادقة
      if (firebaseInitialized && auth) {
        auth.onAuthStateChanged(user => {
          if (user && user.emailVerified !== false) {
            currentUser = user;
            console.log('User authenticated:', user.email);
            loadUserData();
            showApp();
          } else {
            console.log('No authenticated user');
            currentUser = null;
            showAuth();
          }
        });
      } else {
        console.error('Firebase not initialized');
        showAuth();
        showNotification('Firebase غير متاح. يرجى التحقق من الإعدادات.', 'error');
      }
      
      console.log('Event listeners setup complete');
    });

    // وظائف النوافذ المنبثقة
    window.openBalanceModal = openBalanceModal;
    window.closeBalanceModal = closeBalanceModal;
    window.processBalanceChange = processBalanceChange;
    window.deleteDebt = deleteDebt;
    window.deleteTransaction = deleteTransaction;
    window.editTransaction = editTransaction;
    window.removeCurrency = removeCurrency;

  </script>

</body>
</html>

