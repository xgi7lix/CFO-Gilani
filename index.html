<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام الإدارة المالية المتقدم</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  
  <!-- Firebase SDKs (using compat libraries for easier transition) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --primary-color: #2C786C;
      --secondary-color: #004445;
      --accent-color: #FFD166;
      --light-color: #f8f9fa;
      --dark-color: #333;
      --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
      --danger-color: #dc3545;
      --danger-hover: #c82333;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Tajawal', sans-serif; 
      background: var(--light-color); 
      color: var(--dark-color);
      line-height: 1.6;
    }
    .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 15px; }
    header { background: var(--primary-color); color: white; padding: 15px 0; text-align: center; box-shadow: var(--card-shadow); margin-bottom: 20px; position: relative; }
    h1 { font-size: 1.5rem; margin: 0; }
    .back-button, .back-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; transition: var(--transition); }
    .back-btn { position: static; margin: 10px 0; }
    .back-button i, .back-btn i { margin-right: 5px; }
    .back-button:hover, .back-btn:hover { background: rgba(255,255,255,0.3); }
    .main-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
    @media (min-width: 768px) { .main-grid { grid-template-columns: repeat(3, 1fr); } }
    .main-card { background: white; border-radius: 10px; box-shadow: var(--card-shadow); padding: 20px; text-align: center; cursor: pointer; transition: var(--transition); border: 2px solid var(--primary-color); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px; }
    .main-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); background: var(--primary-color); color: white; }
    .main-card:hover i { color: white; }
    .main-card i { font-size: 2rem; color: var(--primary-color); margin-bottom: 10px; transition: var(--transition); }
    .main-card h3 { margin: 0; font-size: 1rem; }
    .page { display: none; background: white; border-radius: 10px; box-shadow: var(--card-shadow); padding: 15px; margin-top: 15px; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .active-page { display: block; }
    .page-header { display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
    .page-header i { margin-left: 10px; color: var(--primary-color); } 
    .settings-card { background: white; border-radius: 10px; box-shadow: var(--card-shadow); padding: 20px; margin-bottom: 15px; border-left: 4px solid var(--primary-color); }
    .settings-card h3 { color: var(--primary-color); margin-bottom: 15px; }
    .form-row { margin-bottom: 15px; }
    .form-row label { font-weight: bold; display: block; margin-bottom: 5px; }
    input, select, textarea, button { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; font-family: 'Tajawal', sans-serif; transition: var(--transition); }
    input:focus, select:focus, textarea:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px rgba(44, 120, 108, 0.2); }
    button { background: var(--primary-color); color: white; cursor: pointer; margin-top: 10px; font-weight: bold; border: none; transition: var(--transition); padding: 12px; }
    button:hover { background: var(--secondary-color); }
    .btn-wide { display: block; width: 100%; margin: 10px 0; text-align: right; padding: 15px; font-size: 1rem; }
    .btn-wide i { margin-left: 10px; }
    .btn-danger { background: var(--danger-color); }
    .btn-danger:hover { background: var(--danger-hover); }
    .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #28a745; color: white; padding: 10px 15px; border-radius: 5px; z-index: 2000; text-align: center; animation: slideIn 0.3s ease; box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
    .notification.error { background: var(--danger-color); }
    @keyframes slideIn { from { transform: translateY(-20px) translateX(-50%); opacity: 0; } to { transform: translateY(0) translateX(-50%); opacity: 1; } }
    .settings-buttons { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 15px; }
    @media (min-width: 480px) { .settings-buttons { grid-template-columns: repeat(2, 1fr); } }
    .balance-item { padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; display: flex; justify-content: space-between; }
    .debt-section { margin: 15px 0; }
    .debt-records-container { padding: 10px; background: #f8f9fa; border-radius: 5px; max-height: 300px; overflow-y: auto; }
    .debt-record { padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; }
    .transaction-button { width: 100%; padding: 10px; margin-bottom: 10px; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-size: 1rem; text-align: right; }
    
    /* Auth Page Styles */
    #auth-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
    .auth-box { background: white; padding: 30px; border-radius: 10px; box-shadow: var(--card-shadow); width: 100%; max-width: 400px; text-align: center; }
    .auth-box h2 { margin-bottom: 20px; color: var(--primary-color); }
    .auth-box .form-row { text-align: right; }
    .auth-box button { margin-top: 15px; }
    .auth-box .google-btn { background-color: #4285F4; color: white; }
    .auth-box .google-btn:hover { background-color: #357ae8; }
    .auth-box .or-separator { margin: 20px 0; display: flex; align-items: center; text-align: center; color: #aaa; }
    .auth-box .or-separator::before, .auth-box .or-separator::after { content: ''; flex: 1; border-bottom: 1px solid #ddd; }
    .auth-box .or-separator:not(:empty)::before { margin-left: .25em; }
    .auth-box .or-separator:not(:empty)::after { margin-right: .25em; }
    .auth-switch { margin-top: 20px; color: var(--dark-color); }
    .auth-switch a { color: var(--primary-color); cursor: pointer; font-weight: bold; }
    .auth-switch a:hover { text-decoration: underline; }
    #app-container { display: none; } /* Hidden by default */
  </style>
</head>
<body>

  <!-- واجهة المصادقة -->
  <div id="auth-container">
    <div class="auth-box">
      <!-- Login Form -->
      <div id="login-form">
        <h2>تسجيل الدخول</h2>
        <div class="form-row">
          <label for="login-email">البريد الإلكتروني</label>
          <input type="email" id="login-email" placeholder="email@example.com" required>
        </div>
        <div class="form-row">
          <label for="login-password">كلمة المرور</label>
          <input type="password" id="login-password" placeholder="********" required>
        </div>
        <button onclick="handleLogin()">تسجيل الدخول</button>
        <div class="or-separator">أو</div>
        <button class="google-btn" onclick="signInWithGoogle()"><i class="fab fa-google"></i> المتابعة باستخدام Google</button>
        <p class="auth-switch">ليس لديك حساب؟ <a onclick="toggleAuthForms()">إنشاء حساب جديد</a></p>
      </div>
      <!-- Signup Form -->
      <div id="signup-form" style="display: none;">
        <h2>إنشاء حساب جديد</h2>
        <div class="form-row">
          <label for="signup-email">البريد الإلكتروني</label>
          <input type="email" id="signup-email" placeholder="email@example.com" required>
        </div>
        <div class="form-row">
          <label for="signup-password">كلمة المرور</label>
          <input type="password" id="signup-password" placeholder="6 أحرف على الأقل" required>
        </div>
        <button onclick="handleSignup()">إنشاء حساب</button>
        <div class="or-separator">أو</div>
        <button class="google-btn" onclick="signInWithGoogle()"><i class="fab fa-google"></i> المتابعة باستخدام Google</button>
        <p class="auth-switch">لديك حساب بالفعل؟ <a onclick="toggleAuthForms()">تسجيل الدخول</a></p>
      </div>
    </div>
  </div>

  <!-- محتوى التطبيق الرئيسي (مخفي افتراضياً) -->
  <div id="app-container">
    <!-- الهيدر الرئيسي -->
    <header id="main-header">
      <div class="container">
        <h1><i class="fas fa-wallet"></i> نظام الإدارة المالية المتقدم</h1>
      </div>
    </header>

    <!-- هيدر الصفحات الفرعية -->
    <header id="page-header" style="display:none;">
      <button class="back-button" onclick="goBack()"><i class="fas fa-arrow-left"></i> العودة</button>
      <h1 id="page-title"></h1>
    </header>

    <!-- المحتوى الرئيسي مع البطاقات الست -->
    <main class="container" id="main-content">
      <div class="main-grid">
        <div class="main-card" onclick="showPage('balances-page')"><i class="fas fa-wallet"></i><h3>كشف الحساب</h3></div>
        <div class="main-card" onclick="showPage('transfers-page')"><i class="fas fa-exchange-alt"></i><h3>التحويلات</h3></div>
        <div class="main-card" onclick="showPage('expenses-page')"><i class="fas fa-money-bill-wave"></i><h3>الصادر والوارد</h3></div>
        <div class="main-card" onclick="showPage('transactions-page')"><i class="fas fa-list"></i><h3>كل المعاملات</h3></div>
        <div class="main-card" onclick="showPage('customerDebtsPage')"><i class="fas fa-users"></i><h3>ديون العملاء</h3></div>
        <div class="main-card" onclick="showPage('settings-page')"><i class="fas fa-cog"></i><h3>الإعدادات</h3></div>
      </div>
    </main>

    <!-- صفحة كشف الحساب -->
    <div class="container page" id="balances-page">
        <div class="page-header"><i class="fas fa-wallet"></i><h2>كشف الحساب</h2></div>
        <div id="balancesList"></div>
        <h3 style="margin-top: 20px;">أحدث المعاملات:</h3>
        <div id="recentTransactions"></div>
    </div>
    <!-- صفحة التحويلات -->
    <div class="container page" id="transfers-page">
        <div class="page-header"><i class="fas fa-exchange-alt"></i><h2>التحويلات</h2></div>
        <div class="form-row"><label>من:</label><select id="fromCurrency"></select></div>
        <div class="form-row"><label>إلى:</label><select id="toCurrency"></select></div>
        <div class="form-row"><label>المبلغ:</label><input type="number" id="transferAmount" placeholder="أدخل المبلغ"></div>
        <div class="form-row"><label>سعر الصرف:</label><div style="display:flex; align-items:center; gap:10px;"><input type="number" id="exchangeRate" placeholder="أدخل سعر الصرف" step="0.0001"><button id="rateModeBtn" type="button" onclick="toggleRateMode()" style="width:auto;padding:5px 10px;">×</button></div></div>
        <div class="form-row"><label>تعليق (اختياري):</label><input type="text" id="transferComment" placeholder="أدخل تعليقًا إذا لزم الأمر"></div>
        <button onclick="performTransfer()"><i class="fas fa-exchange-alt"></i> تنفيذ التحويل</button>
    </div>
    <!-- صفحة الصادر والوارد -->
    <div class="container page" id="expenses-page">
        <div class="page-header"><i class="fas fa-money-bill-wave"></i><h2>الصادر والوارد</h2></div>
        <div class="form-row"><label>الاسم:</label><input type="text" id="expensePerson" placeholder="اسم العميل أو المورد"></div>
        <div class="form-row"><label>نوع العملية:</label><select id="expenseType"><option value="صادر">صادر</option><option value="وارد">وارد</option></select></div>
        <div class="form-row"><label>المبلغ:</label><input type="number" id="expenseAmount" placeholder="أدخل المبلغ"></div>
        <div class="form-row"><label>العملة:</label><select id="expenseCurrency"></select></div>
        <div class="form-row"><label>تفاصيل:</label><textarea id="expenseDetails" placeholder="وصف العملية" rows="3"></textarea></div>
        <button onclick="performExpense()"><i class="fas fa-check"></i> تنفيذ العملية</button>
    </div>
    <!-- صفحة المعاملات -->
    <div class="container page" id="transactions-page">
        <div class="page-header"><i class="fas fa-list"></i><h2>كل المعاملات</h2></div>
        <div class="form-row"><input type="text" id="transactionSearch" placeholder="ابحث في المعاملات..." oninput="searchTransactions()"></div>
        <div id="transactionsList"></div>
    </div>
    <!-- صفحة ديون العملاء -->
    <div class="container page" id="customerDebtsPage">
        <button class="back-btn" onclick="goBack()">← رجوع</button><h2>ديون العملاء</h2>
        <div id="overallDebtSummary" class="balance-item"></div>
        <div class="debt-section"><button onclick="toggleAddClient()">إضافة عميل</button><button onclick="toggleRemoveClient()">إزالة عميل</button></div>
        <div id="addClientSection" class="debt-section" style="display:none;"><h3>إضافة عميل جديد</h3><div class="form-row"><label>اسم العميل:</label><input type="text" id="newClientName" placeholder="ادخل اسم العميل"></div><div class="form-row"><label>رقم الهاتف:</label><input type="text" id="newClientPhone" placeholder="ادخل رقم الهاتف"></div><div class="form-row"><label>ملاحظة (اختياري):</label><input type="text" id="newClientNote" placeholder="ادخل ملاحظة"></div><button onclick="addClientDebt()">تسجيل العميل</button></div>
        <div id="removeClientSection" class="debt-section" style="display:none;"><h3>إزالة عميل</h3><select id="removeClientDropdown"></select><button onclick="removeClientFromDropdown()">حذف العميل</button></div>
        <div class="debt-section"><h3>العملاء المُسجّلين</h3><div id="clientsListDisplay"></div></div>
    </div>
    <!-- صفحة تفاصيل ديون العميل -->
    <div class="container page" id="debtDetailsPage">
        <button class="back-btn" onclick="goBack()">← رجوع</button><h2>تفاصيل ديون العميل: <span id="clientDetailsName"></span></h2>
        <div id="clientDebtSummary" class="balance-item"></div>
        <div class="form-row"><label>نوع العملية:</label><select id="clientDebtType"><option value="لك">لك (تطلب منه)</option><option value="له">له (يطلب منك)</option></select></div>
        <div class="form-row"><label>المبلغ:</label><input type="number" id="clientDebtAmount" placeholder="ادخل المبلغ"></div>
        <div class="form-row"><label>العملة:</label><select id="clientDebtCurrency"></select></div>
        <div class="form-row"><label>تفاصيل:</label><input type="text" id="clientDebtComment" placeholder="تفاصيل أو ملاحظة"></div>
        <button onclick="addOrUpdateClientDebt()">إضافة / تعديل الدين</button>
        <h3 style="margin-top: 30px;">سجلات الديون</h3><div id="clientDebtDetails" class="debt-records-container"></div>
    </div>
    <!-- صفحة الإعدادات -->
    <div class="container page" id="settings-page">
        <div class="page-header"><i class="fas fa-cog"></i><h2>الإعدادات</h2></div>
        <button class="btn-wide" onclick="showSettingsPage('currency-settings')"><i class="fas fa-coins"></i> إدارة العملات</button>
        <button class="btn-wide" onclick="showSettingsPage('balance-settings')"><i class="fas fa-wallet"></i> إدارة الرصيد</button>
        <button class="btn-wide btn-danger" onclick="resetAllData()"><i class="fas fa-trash-alt"></i> مسح جميع البيانات</button>
        <button class="btn-wide" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button>
    </div>
    <!-- صفحة إدارة العملات -->
    <div class="container page" id="currency-settings-page">
        <div class="page-header"><i class="fas fa-coins"></i><h2>إدارة العملات</h2></div>
        <div class="settings-card"><h3>العملات المتاحة</h3><div class="form-row"><label>اختر العملة:</label><select id="currency-select"><option value="USD">دولار أمريكي (USD)</option><option value="EUR">يورو (EUR)</option><option value="GBP">جنيه إسترليني (GBP)</option><option value="SAR">ريال سعودي (SAR)</option><option value="AED">درهم إماراتي (AED)</option><option value="EGP">جنيه مصري (EGP)</option><option value="SDG">جنيه سوداني (SDG)</option><option value="QAR">ريال قطري (QAR)</option></select></div><button onclick="addCurrency()"><i class="fas fa-plus"></i> إضافة العملة</button></div>
        <div class="settings-card"><h3>العملات المضافة</h3><div id="active-currencies-list"></div></div>
    </div>
    <!-- صفحة إدارة الرصيد -->
    <div class="container page" id="balance-settings-page">
        <div class="page-header"><i class="fas fa-wallet"></i><h2>إدارة الرصيد</h2></div>
        <div class="settings-card"><h3>تعديل الرصيد</h3><div class="form-row"><label>اختر العملة:</label><select id="balance-currency-select"></select></div><div class="form-row"><label>المبلغ الجديد:</label><input type="number" id="new-balance" placeholder="أدخل المبلغ الجديد"></div><button onclick="updateBalance()"><i class="fas fa-save"></i> حفظ التغييرات</button></div>
    </div>
  </div>

  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDLgv4ruPM7rmodEa_q4QoI7Cn_p84Sqww",
      authDomain: "galmok-9d8e7.firebaseapp.com",
      projectId: "galmok-9d8e7",
      storageBucket: "galmok-9d8e7.appspot.com",
      messagingSenderId: "193906028682",
      appId: "1:193906028682:web:00dd06fd80d556294b7d73",
      measurementId: "G-2XFFDDFEDD"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;
    let userDocRef = null;

    // --- Auth UI Logic ---
    function toggleAuthForms() {
      const loginForm = document.getElementById('login-form');
      const signupForm = document.getElementById('signup-form');
      if (loginForm.style.display === 'none') {
        loginForm.style.display = 'block';
        signupForm.style.display = 'none';
      } else {
        loginForm.style.display = 'none';
        signupForm.style.display = 'block';
      }
    }

    // --- Auth Event Listener ---
    auth.onAuthStateChanged(user => {
      const authContainer = document.getElementById('auth-container');
      const appContainer = document.getElementById('app-container');
      if (user) {
        // User is signed in.
        currentUser = user;
        userDocRef = db.collection('users').doc(user.uid);
        authContainer.style.display = 'none';
        appContainer.style.display = 'block';
        loadData(); // Load user-specific data
      } else {
        // User is signed out.
        currentUser = null;
        userDocRef = null;
        authContainer.style.display = 'flex';
        appContainer.style.display = 'none';
      }
    });

    // --- Auth Functions ---
    function handleSignup() {
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      if (password.length < 6) {
        showNotification("يجب أن تكون كلمة المرور 6 أحرف على الأقل", true);
        return;
      }
      auth.createUserWithEmailAndPassword(email, password)
        .then(userCredential => {
          showNotification("تم إنشاء الحساب بنجاح! جاري تسجيل الدخول...");
          // The onAuthStateChanged listener will handle the UI switch and data initialization.
        })
        .catch(error => showNotification(`خطأ: ${getArabicAuthError(error.code)}`, true));
    }

    function handleLogin() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(userCredential => {
          showNotification("تم تسجيل الدخول بنجاح!");
        })
        .catch(error => showNotification(`خطأ: ${getArabicAuthError(error.code)}`, true));
    }

    function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => {
          showNotification(`أهلاً بك، ${result.user.displayName}!`);
        })
        .catch(error => showNotification(`خطأ: ${getArabicAuthError(error.code)}`, true));
    }

    function handleLogout() {
      auth.signOut().then(() => {
        showNotification("تم تسجيل الخروج بنجاح.");
        // Clear local state
        balances = {};
        currencies = {};
        transactions = [];
        clients = {};
        goBack(); // Return to main screen view before logout
      }).catch(error => showNotification(`خطأ في تسجيل الخروج: ${error.message}`, true));
    }
    
    function getArabicAuthError(errorCode) {
        switch (errorCode) {
            case 'auth/invalid-email':
                return 'البريد الإلكتروني غير صالح.';
            case 'auth/user-disabled':
                return 'تم تعطيل هذا الحساب.';
            case 'auth/user-not-found':
                return 'لا يوجد حساب بهذا البريد الإلكتروني.';
            case 'auth/wrong-password':
                return 'كلمة المرور غير صحيحة.';
            case 'auth/email-already-in-use':
                return 'هذا البريد الإلكتروني مستخدم بالفعل.';
            case 'auth/weak-password':
                return 'كلمة المرور ضعيفة جداً.';
            case 'auth/popup-closed-by-user':
                return 'تم إغلاق نافذة تسجيل الدخول. يرجى المحاولة مرة أخرى.';
            default:
                return 'حدث خطأ غير متوقع. يرجى المحاولة مرة أخرى.';
        }
    }

    // --- App State (now loaded from Firestore) ---
    let balances = {};
    let currencies = {};
    let transactions = [];
    let clients = {};
    let transactionIdCounter = 1101;
    let currentDebtClient = null;
    let isMultiplyMode = true;

    // --- Data Management (Firestore) ---
    async function loadData() {
        if (!userDocRef) return;

        try {
            const doc = await userDocRef.get();
            if (doc.exists) {
                const data = doc.data();
                balances = data.balances || { "SDG": 0, "QAR": 0 };
                currencies = data.currencies || { "SDG": "جنيه سوداني", "QAR": "ريال قطري" };
                transactions = data.transactions || [];
                clients = data.clients || {};
                transactionIdCounter = data.transactionIdCounter || 1101;
            } else {
                // First time login for this user, create initial data
                await initializeUserData();
            }
        } catch (error) {
            console.error("Error loading data: ", error);
            showNotification("حدث خطأ أثناء تحميل البيانات.", true);
        }

        // Update UI after loading data
        updateAllUI();
    }

    async function initializeUserData() {
        const initialData = {
            balances: { "SDG": 0, "QAR": 0 },
            currencies: { "SDG": "جنيه سوداني", "QAR": "ريال قطري" },
            transactions: [],
            clients: {},
            transactionIdCounter: 1101
        };
        await userDocRef.set(initialData);
        // Assign initial data to local state
        balances = initialData.balances;
        currencies = initialData.currencies;
        transactions = initialData.transactions;
        clients = initialData.clients;
        transactionIdCounter = initialData.transactionIdCounter;
    }

    async function saveData() {
        if (!userDocRef) return;
        const dataToSave = {
            balances,
            currencies,
            transactions,
            clients,
            transactionIdCounter
        };
        try {
            await userDocRef.set(dataToSave);
        } catch (error) {
            console.error("Error saving data: ", error);
            showNotification("فشل حفظ البيانات في السحابة.", true);
        }
    }
    
    function updateAllUI() {
        updateBalances();
        updateCurrencySelects();
        updateTransactionsUI();
        updateRecentTransactions();
        updateClientsListDisplay();
        updateActiveCurrenciesList();
        updateOverallDebtSummary();
    }

    // --- UI and Logic Functions ---
    function showPage(pageId) {
      document.getElementById("main-content").style.display = "none";
      document.getElementById("main-header").style.display = "none";
      document.getElementById("page-header").style.display = "block";
      const pageTitleEl = document.querySelector(`#${pageId} .page-header h2`);
      document.getElementById("page-title").textContent = pageTitleEl ? pageTitleEl.textContent : "";
      hideAllPages();
      document.getElementById(pageId).classList.add("active-page");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function showSettingsPage(pageId) {
      const titleEl = document.querySelector(`#${pageId}-page .page-header h2`);
      if (titleEl) {
        document.getElementById("page-title").textContent = titleEl.textContent;
      }
      hideAllPages();
      document.getElementById(`${pageId}-page`).classList.add("active-page");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function goBack() {
      const currentPage = document.querySelector(".page.active-page");
      if (currentPage && (currentPage.id.endsWith('-settings-page') || currentPage.id === 'debtDetailsPage')) {
          if (currentPage.id === 'debtDetailsPage') {
              showPage('customerDebtsPage');
          } else {
              showPage('settings-page');
          }
          return;
      }
      hideAllPages();
      document.getElementById("main-content").style.display = "block";
      document.getElementById("main-header").style.display = "block";
      document.getElementById("page-header").style.display = "none";
    }

    function hideAllPages() {
      document.querySelectorAll(".page").forEach(page => page.classList.remove("active-page"));
    }

    function updateBalances() {
      const list = document.getElementById("balancesList");
      if (!list) return;
      list.innerHTML = "";
      for (const [code, balance] of Object.entries(balances)) {
        const name = currencies[code] || code;
        const item = document.createElement("div");
        item.className = "balance-item";
        item.innerHTML = `<span>${name} (${code}):</span> <span>${balance.toFixed(2)}</span>`;
        list.appendChild(item);
      }
      updateCurrencySelects();
      updateBalanceSettingsSelect();
    }

    function updateCurrencySelects() {
      const currencySelects = document.querySelectorAll("#fromCurrency, #toCurrency, #expenseCurrency, #clientDebtCurrency");
      currencySelects.forEach(select => {
        select.innerHTML = "";
        for (const code in currencies) {
          const option = document.createElement("option");
          option.value = code;
          option.textContent = `${currencies[code]} (${code})`;
          select.appendChild(option);
        }
      });
    }

    function updateBalanceSettingsSelect() {
      const select = document.getElementById("balance-currency-select");
      if (!select) return;
      select.innerHTML = "";
      for (const code in balances) {
        const option = document.createElement("option");
        option.value = code;
        option.textContent = `${currencies[code]} (${code})`;
        select.appendChild(option);
      }
    }

    function updateActiveCurrenciesList() {
      const list = document.getElementById("active-currencies-list");
      if (!list) return;
      list.innerHTML = "";
      for (const code in currencies) {
        const item = document.createElement("div");
        item.className = "balance-item";
        item.innerHTML = `<span>${currencies[code]} (${code})</span> <button class="btn-danger" onclick="removeCurrency('${code}')">حذف</button>`;
        list.appendChild(item);
      }
    }

    function addCurrency() {
      const select = document.getElementById("currency-select");
      const code = select.value;
      const name = select.options[select.selectedIndex].text.split('(')[0].trim();

      if (!currencies[code]) {
        currencies[code] = name;
        balances[code] = 0;
        saveData();
        updateActiveCurrenciesList();
        updateCurrencySelects();
        updateBalances();
        showNotification(`تم إضافة ${name} بنجاح.`);
      } else {
        showNotification("هذه العملة موجودة بالفعل.", true);
      }
    }

    function removeCurrency(code) {
      if (confirm(`هل أنت متأكد من حذف عملة ${currencies[code]} (${code})؟ سيتم حذف جميع الأرصدة والمعاملات المرتبطة بها.`)) {
        delete currencies[code];
        delete balances[code];
        transactions = transactions.filter(t => t.currency !== code && !(t.fromCurrency === code || t.toCurrency === code));
        // Also filter client debts if they use this currency
        for (const clientId in clients) {
            clients[clientId].debts = clients[clientId].debts.filter(d => d.currency !== code);
        }
        saveData();
        updateActiveCurrenciesList();
        updateCurrencySelects();
        updateBalances();
        updateTransactionsUI();
        updateOverallDebtSummary();
        showNotification(`تم حذف ${code} بنجاح.`);
      }
    }

    function updateBalance() {
      const currencyCode = document.getElementById("balance-currency-select").value;
      const newBalance = parseFloat(document.getElementById("new-balance").value);

      if (isNaN(newBalance)) {
        showNotification("الرجاء إدخال مبلغ صحيح.", true);
        return;
      }

      const oldBalance = balances[currencyCode];
      balances[currencyCode] = newBalance;

      const transaction = {
        id: transactionIdCounter++,
        type: "تعديل رصيد",
        date: new Date().toLocaleString('ar-EG', { timeZone: 'Africa/Khartoum' }),
        currency: currencyCode,
        amount: newBalance - oldBalance,
        details: `تعديل الرصيد من ${oldBalance.toFixed(2)} إلى ${newBalance.toFixed(2)}`,
        balanceAfter: newBalance
      };
      transactions.unshift(transaction);
      saveData();
      updateBalances();
      updateTransactionsUI();
      updateRecentTransactions();
      showNotification("تم تحديث الرصيد بنجاح.");
      document.getElementById("new-balance").value = "";
    }

    function performTransfer() {
      const fromCurrency = document.getElementById("fromCurrency").value;
      const toCurrency = document.getElementById("toCurrency").value;
      const amount = parseFloat(document.getElementById("transferAmount").value);
      let exchangeRate = parseFloat(document.getElementById("exchangeRate").value);
      const comment = document.getElementById("transferComment").value;

      if (fromCurrency === toCurrency) {
        showNotification("لا يمكن التحويل بين نفس العملة.", true);
        return;
      }
      if (isNaN(amount) || amount <= 0) {
        showNotification("الرجاء إدخال مبلغ صحيح وموجب.", true);
        return;
      }
      if (isNaN(exchangeRate) || exchangeRate <= 0) {
        showNotification("الرجاء إدخال سعر صرف صحيح وموجب.", true);
        return;
      }
      if (balances[fromCurrency] < amount) {
        showNotification(`الرصيد غير كافٍ في ${currencies[fromCurrency]}.`, true);
        return;
      }

      let convertedAmount;
      if (isMultiplyMode) {
          convertedAmount = amount * exchangeRate;
      } else { // Divide mode
          convertedAmount = amount / exchangeRate;
      }

      balances[fromCurrency] -= amount;
      balances[toCurrency] += convertedAmount;

      const transaction = {
        id: transactionIdCounter++,
        type: "تحويل",
        date: new Date().toLocaleString('ar-EG', { timeZone: 'Africa/Khartoum' }),
        fromCurrency: fromCurrency,
        toCurrency: toCurrency,
        amount: amount,
        convertedAmount: convertedAmount,
        exchangeRate: exchangeRate,
        comment: comment,
        balanceAfterFrom: balances[fromCurrency],
        balanceAfterTo: balances[toCurrency]
      };
      transactions.unshift(transaction);
      saveData();
      updateBalances();
      updateTransactionsUI();
      updateRecentTransactions();
      showNotification("تم التحويل بنجاح.");
      document.getElementById("transferAmount").value = "";
      document.getElementById("exchangeRate").value = "";
      document.getElementById("transferComment").value = "";
    }

    function toggleRateMode() {
        isMultiplyMode = !isMultiplyMode;
        const rateModeBtn = document.getElementById('rateModeBtn');
        rateModeBtn.textContent = isMultiplyMode ? '×' : '÷';
        showNotification(`وضع سعر الصرف: ${isMultiplyMode ? 'ضرب' : 'قسمة'}`);
    }

    function performExpense() {
      const person = document.getElementById("expensePerson").value;
      const type = document.getElementById("expenseType").value;
      const amount = parseFloat(document.getElementById("expenseAmount").value);
      const currency = document.getElementById("expenseCurrency").value;
      const details = document.getElementById("expenseDetails").value;

      if (isNaN(amount) || amount <= 0) {
        showNotification("الرجاء إدخال مبلغ صحيح وموجب.", true);
        return;
      }
      if (!person.trim()) {
        showNotification("الرجاء إدخال اسم العميل أو المورد.", true);
        return;
      }

      if (type === "صادر") {
        if (balances[currency] < amount) {
          showNotification(`الرصيد غير كافٍ في ${currencies[currency]}.`, true);
          return;
        }
        balances[currency] -= amount;
      } else { // وارد
        balances[currency] += amount;
      }

      const transaction = {
        id: transactionIdCounter++,
        type: type,
        date: new Date().toLocaleString('ar-EG', { timeZone: 'Africa/Khartoum' }),
        person: person,
        amount: amount,
        currency: currency,
        details: details,
        balanceAfter: balances[currency]
      };
      transactions.unshift(transaction);
      saveData();
      updateBalances();
      updateTransactionsUI();
      updateRecentTransactions();
      showNotification(`تم تسجيل ${type} بنجاح.`);
      document.getElementById("expensePerson").value = "";
      document.getElementById("expenseAmount").value = "";
      document.getElementById("expenseDetails").value = "";
    }

    function updateTransactionsUI() {
      const list = document.getElementById("transactionsList");
      if (!list) return;
      list.innerHTML = "";
      const searchTerm = document.getElementById("transactionSearch").value.toLowerCase();

      const filteredTransactions = transactions.filter(t => 
        JSON.stringify(t).toLowerCase().includes(searchTerm)
      );

      if (filteredTransactions.length === 0) {
        list.innerHTML = "<p style='text-align: center; color: #666;'>لا توجد معاملات مطابقة.</p>";
        return;
      }

      filteredTransactions.forEach(t => {
        const item = document.createElement("div");
        item.className = "balance-item"; // Reusing style
        let detailsHtml = ``;
        if (t.type === "تحويل") {
          detailsHtml = `
            <p><strong>النوع:</strong> ${t.type}</p>
            <p><strong>من:</strong> ${currencies[t.fromCurrency]} (${t.fromCurrency})</p>
            <p><strong>إلى:</strong> ${currencies[t.toCurrency]} (${t.toCurrency})</p>
            <p><strong>المبلغ المحول:</strong> ${t.amount.toFixed(2)} ${t.fromCurrency}</p>
            <p><strong>المبلغ المستلم:</strong> ${t.convertedAmount.toFixed(2)} ${t.toCurrency}</p>
            <p><strong>سعر الصرف:</strong> ${t.exchangeRate}</p>
            ${t.comment ? `<p><strong>تعليق:</strong> ${t.comment}</p>` : ''}
            <p><strong>الرصيد بعد التحويل (${t.fromCurrency}):</strong> ${t.balanceAfterFrom.toFixed(2)}</p>
            <p><strong>الرصيد بعد التحويل (${t.toCurrency}):</strong> ${t.balanceAfterTo.toFixed(2)}</p>
          `;
        } else if (t.type === "صادر" || t.type === "وارد") {
          detailsHtml = `
            <p><strong>النوع:</strong> ${t.type}</p>
            <p><strong>الاسم:</strong> ${t.person}</p>
            <p><strong>المبلغ:</strong> ${t.amount.toFixed(2)} ${t.currency}</p>
            <p><strong>التفاصيل:</strong> ${t.details}</p>
            <p><strong>الرصيد بعد العملية:</strong> ${t.balanceAfter.toFixed(2)} ${t.currency}</p>
          `;
        } else if (t.type === "تعديل رصيد") {
            detailsHtml = `
                <p><strong>النوع:</strong> ${t.type}</p>
                <p><strong>العملة:</strong> ${t.currency}</p>
                <p><strong>التفاصيل:</strong> ${t.details}</p>
                <p><strong>الرصيد الجديد:</strong> ${t.balanceAfter.toFixed(2)} ${t.currency}</p>
            `;
        } else if (t.type === 


"دين عميل") {
            detailsHtml = `
                <p><strong>النوع:</strong> ${t.type}</p>
                <p><strong>العميل:</strong> ${t.clientName}</p>
                <p><strong>نوع الدين:</strong> ${t.debtType}</p>
                <p><strong>المبلغ:</strong> ${t.amount.toFixed(2)} ${t.currency}</p>
                <p><strong>التفاصيل:</strong> ${t.comment}</p>
            `;
        }

        item.innerHTML = `
          <div style="flex: 1;">
            <p><strong>رقم المعاملة:</strong> ${t.id}</p>
            <p><strong>التاريخ:</strong> ${t.date}</p>
            ${detailsHtml}
          </div>
          <button class="btn-danger" onclick="deleteTransaction(${t.id})" style="width: auto; margin: 0; padding: 5px 10px;">حذف</button>
        `;
        list.appendChild(item);
      });
    }

    function searchTransactions() {
      updateTransactionsUI();
    }

    function deleteTransaction(id) {
      if (confirm("هل أنت متأكد من حذف هذه المعاملة؟")) {
        transactions = transactions.filter(t => t.id !== id);
        saveData();
        updateTransactionsUI();
        updateRecentTransactions();
        showNotification("تم حذف المعاملة بنجاح.");
      }
    }

    function updateRecentTransactions() {
      const list = document.getElementById("recentTransactions");
      if (!list) return;
      list.innerHTML = "";
      const recentTransactions = transactions.slice(0, 5);
      if (recentTransactions.length === 0) {
        list.innerHTML = "<p style='text-align: center; color: #666;'>لا توجد معاملات حديثة.</p>";
        return;
      }
      recentTransactions.forEach(t => {
        const item = document.createElement("div");
        item.className = "balance-item";
        let summary = "";
        if (t.type === "تحويل") {
          summary = `تحويل ${t.amount.toFixed(2)} ${t.fromCurrency} إلى ${t.convertedAmount.toFixed(2)} ${t.toCurrency}`;
        } else if (t.type === "صادر" || t.type === "وارد") {
          summary = `${t.type}: ${t.amount.toFixed(2)} ${t.currency} - ${t.person}`;
        } else if (t.type === "تعديل رصيد") {
          summary = `تعديل رصيد ${t.currency}: ${t.amount > 0 ? '+' : ''}${t.amount.toFixed(2)}`;
        } else if (t.type === "دين عميل") {
          summary = `دين ${t.debtType}: ${t.amount.toFixed(2)} ${t.currency} - ${t.clientName}`;
        }
        item.innerHTML = `<span>${summary}</span><span style="font-size: 0.8em; color: #666;">${t.date}</span>`;
        list.appendChild(item);
      });
    }

    function resetAllData() {
      if (confirm("هل أنت متأكد من مسح جميع البيانات؟ هذا الإجراء لا يمكن التراجع عنه.")) {
        balances = { "SDG": 0, "QAR": 0 };
        currencies = { "SDG": "جنيه سوداني", "QAR": "ريال قطري" };
        transactions = [];
        clients = {};
        transactionIdCounter = 1101;
        saveData();
        updateAllUI();
        showNotification("تم مسح جميع البيانات بنجاح.");
      }
    }

    // --- Client Debt Management ---
    function toggleAddClient() {
      const section = document.getElementById("addClientSection");
      section.style.display = section.style.display === "none" ? "block" : "none";
      document.getElementById("removeClientSection").style.display = "none";
    }

    function toggleRemoveClient() {
      const section = document.getElementById("removeClientSection");
      section.style.display = section.style.display === "none" ? "block" : "none";
      document.getElementById("addClientSection").style.display = "none";
      updateRemoveClientDropdown();
    }

    function addClientDebt() {
      const name = document.getElementById("newClientName").value.trim();
      const phone = document.getElementById("newClientPhone").value.trim();
      const note = document.getElementById("newClientNote").value.trim();

      if (!name) {
        showNotification("الرجاء إدخال اسم العميل.", true);
        return;
      }

      const clientId = Date.now().toString();
      clients[clientId] = {
        name: name,
        phone: phone,
        note: note,
        debts: []
      };

      saveData();
      updateClientsListDisplay();
      updateOverallDebtSummary();
      showNotification(`تم إضافة العميل ${name} بنجاح.`);
      document.getElementById("newClientName").value = "";
      document.getElementById("newClientPhone").value = "";
      document.getElementById("newClientNote").value = "";
      document.getElementById("addClientSection").style.display = "none";
    }

    function updateRemoveClientDropdown() {
      const dropdown = document.getElementById("removeClientDropdown");
      dropdown.innerHTML = "<option value=''>اختر عميلاً لحذفه</option>";
      for (const [id, client] of Object.entries(clients)) {
        const option = document.createElement("option");
        option.value = id;
        option.textContent = client.name;
        dropdown.appendChild(option);
      }
    }

    function removeClientFromDropdown() {
      const dropdown = document.getElementById("removeClientDropdown");
      const clientId = dropdown.value;
      if (!clientId) {
        showNotification("الرجاء اختيار عميل لحذفه.", true);
        return;
      }

      const clientName = clients[clientId].name;
      if (confirm(`هل أنت متأكد من حذف العميل ${clientName} وجميع سجلات ديونه؟`)) {
        // Remove client debt transactions from main transactions list
        transactions = transactions.filter(t => !(t.type === "دين عميل" && t.clientId === clientId));
        delete clients[clientId];
        saveData();
        updateClientsListDisplay();
        updateOverallDebtSummary();
        updateTransactionsUI();
        updateRecentTransactions();
        showNotification(`تم حذف العميل ${clientName} بنجاح.`);
        document.getElementById("removeClientSection").style.display = "none";
      }
    }

    function updateClientsListDisplay() {
      const list = document.getElementById("clientsListDisplay");
      if (!list) return;
      list.innerHTML = "";

      if (Object.keys(clients).length === 0) {
        list.innerHTML = "<p style='text-align: center; color: #666;'>لا يوجد عملاء مسجلون.</p>";
        return;
      }

      for (const [id, client] of Object.entries(clients)) {
        const totalDebt = calculateClientTotalDebt(client.debts);
        const item = document.createElement("div");
        item.className = "transaction-button";
        item.style.backgroundColor = "#f8f9fa";
        item.style.color = "#333";
        item.onclick = () => showClientDebtDetails(id);

        let debtSummary = "";
        if (totalDebt.length === 0) {
          debtSummary = "لا توجد ديون";
        } else {
          debtSummary = totalDebt.map(debt => `${debt.amount.toFixed(2)} ${debt.currency} ${debt.type}`).join(" | ");
        }

        item.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>${client.name}</strong>
              ${client.phone ? `<br><small>📞 ${client.phone}</small>` : ''}
              ${client.note ? `<br><small>📝 ${client.note}</small>` : ''}
            </div>
            <div style="text-align: left; font-size: 0.9em;">
              ${debtSummary}
            </div>
          </div>
        `;
        list.appendChild(item);
      }
    }

    function calculateClientTotalDebt(debts) {
      const totals = {};
      debts.forEach(debt => {
        if (!totals[debt.currency]) {
          totals[debt.currency] = { لك: 0, له: 0 };
        }
        totals[debt.currency][debt.type] += debt.amount;
      });

      const result = [];
      for (const [currency, amounts] of Object.entries(totals)) {
        const net = amounts.لك - amounts.له;
        if (net !== 0) {
          result.push({
            currency: currency,
            amount: Math.abs(net),
            type: net > 0 ? "لك" : "له"
          });
        }
      }
      return result;
    }

    function updateOverallDebtSummary() {
      const summary = document.getElementById("overallDebtSummary");
      if (!summary) return;

      const allDebts = [];
      for (const client of Object.values(clients)) {
        allDebts.push(...client.debts);
      }

      const totalDebt = calculateClientTotalDebt(allDebts);
      if (totalDebt.length === 0) {
        summary.innerHTML = "<span>إجمالي الديون:</span> <span>لا توجد ديون</span>";
      } else {
        const debtText = totalDebt.map(debt => `${debt.amount.toFixed(2)} ${debt.currency} ${debt.type}`).join(" | ");
        summary.innerHTML = `<span>إجمالي الديون:</span> <span>${debtText}</span>`;
      }
    }

    function showClientDebtDetails(clientId) {
      currentDebtClient = clientId;
      const client = clients[clientId];
      document.getElementById("clientDetailsName").textContent = client.name;
      updateClientDebtSummary();
      updateClientDebtDetails();
      showPage("debtDetailsPage");
    }

    function updateClientDebtSummary() {
      const summary = document.getElementById("clientDebtSummary");
      if (!summary || !currentDebtClient) return;

      const client = clients[currentDebtClient];
      const totalDebt = calculateClientTotalDebt(client.debts);
      if (totalDebt.length === 0) {
        summary.innerHTML = "<span>إجمالي الديون:</span> <span>لا توجد ديون</span>";
      } else {
        const debtText = totalDebt.map(debt => `${debt.amount.toFixed(2)} ${debt.currency} ${debt.type}`).join(" | ");
        summary.innerHTML = `<span>إجمالي الديون:</span> <span>${debtText}</span>`;
      }
    }

    function addOrUpdateClientDebt() {
      if (!currentDebtClient) return;

      const type = document.getElementById("clientDebtType").value;
      const amount = parseFloat(document.getElementById("clientDebtAmount").value);
      const currency = document.getElementById("clientDebtCurrency").value;
      const comment = document.getElementById("clientDebtComment").value.trim();

      if (isNaN(amount) || amount <= 0) {
        showNotification("الرجاء إدخال مبلغ صحيح وموجب.", true);
        return;
      }

      const debt = {
        type: type,
        amount: amount,
        currency: currency,
        comment: comment,
        date: new Date().toLocaleString('ar-EG', { timeZone: 'Africa/Khartoum' })
      };

      clients[currentDebtClient].debts.push(debt);

      // Add to main transactions list
      const transaction = {
        id: transactionIdCounter++,
        type: "دين عميل",
        date: debt.date,
        clientId: currentDebtClient,
        clientName: clients[currentDebtClient].name,
        debtType: type,
        amount: amount,
        currency: currency,
        comment: comment
      };
      transactions.unshift(transaction);

      saveData();
      updateClientDebtSummary();
      updateClientDebtDetails();
      updateOverallDebtSummary();
      updateTransactionsUI();
      updateRecentTransactions();
      showNotification("تم إضافة الدين بنجاح.");
      document.getElementById("clientDebtAmount").value = "";
      document.getElementById("clientDebtComment").value = "";
    }

    function updateClientDebtDetails() {
      const container = document.getElementById("clientDebtDetails");
      if (!container || !currentDebtClient) return;

      const client = clients[currentDebtClient];
      container.innerHTML = "";

      if (client.debts.length === 0) {
        container.innerHTML = "<p style='text-align: center; color: #666;'>لا توجد سجلات ديون لهذا العميل.</p>";
        return;
      }

      client.debts.slice().reverse().forEach((debt, index) => {
        const item = document.createElement("div");
        item.className = "debt-record";
        item.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <p><strong>النوع:</strong> ${debt.type}</p>
              <p><strong>المبلغ:</strong> ${debt.amount.toFixed(2)} ${debt.currency}</p>
              <p><strong>التفاصيل:</strong> ${debt.comment}</p>
              <p><strong>التاريخ:</strong> ${debt.date}</p>
            </div>
            <button class="btn-danger" onclick="deleteClientDebt(${client.debts.length - 1 - index})" style="width: auto; margin: 0; padding: 5px 10px;">حذف</button>
          </div>
        `;
        container.appendChild(item);
      });
    }

    function deleteClientDebt(debtIndex) {
      if (!currentDebtClient) return;
      if (confirm("هل أنت متأكد من حذف هذا السجل؟")) {
        const client = clients[currentDebtClient];
        const deletedDebt = client.debts[debtIndex];
        client.debts.splice(debtIndex, 1);

        // Remove corresponding transaction from main list
        transactions = transactions.filter(t => !(
          t.type === "دين عميل" && 
          t.clientId === currentDebtClient && 
          t.amount === deletedDebt.amount && 
          t.currency === deletedDebt.currency && 
          t.date === deletedDebt.date
        ));

        saveData();
        updateClientDebtSummary();
        updateClientDebtDetails();
        updateOverallDebtSummary();
        updateTransactionsUI();
        updateRecentTransactions();
        showNotification("تم حذف السجل بنجاح.");
      }
    }

    // --- Notification System ---
    function showNotification(message, isError = false) {
      const notification = document.createElement("div");
      notification.className = `notification ${isError ? 'error' : ''}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // --- Screenshot functionality ---
    function captureScreenshot() {
      const element = document.querySelector('.page.active-page') || document.getElementById('main-content');
      html2canvas(element, {
        backgroundColor: '#f8f9fa',
        scale: 2,
        useCORS: true
      }).then(canvas => {
        const link = document.createElement('a');
        link.download = `financial-report-${new Date().toISOString().split('T')[0]}.png`;
        link.href = canvas.toDataURL();
        link.click();
        showNotification('تم حفظ لقطة الشاشة بنجاح.');
      }).catch(error => {
        console.error('Error capturing screenshot:', error);
        showNotification('حدث خطأ أثناء حفظ لقطة الشاشة.', true);
      });
    }

    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Firebase auth state will be handled by onAuthStateChanged
      console.log('App initialized');
    });
  </script>
</body>
</html>

